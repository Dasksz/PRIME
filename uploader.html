<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uploader de Dados - PRIME DISTRIBUI√á√ÉO</title>
    <link rel="icon" type="image/jpeg" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSnaaZ2WnZBJIxPRfabS4Ug78PKK6Gu3nbHlw&s">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body class="antialiased">

    <!-- Admin Uploader Modal -->
    <div id="admin-uploader-modal" class="modal-overlay">
        <div class="bg-modal-content rounded-lg shadow-2xl max-w-lg w-full m-4 border border-primary relative text-center p-8">
            <h1 class="text-2xl font-bold mb-4">Uploader (v5.1 - Parcial)</h1>
            <p class="mb-6">Carregue os arquivos para enviar os dados ao Supabase. Voc√™ pode carregar um ou mais arquivos de cada vez.</p>

            <div class="space-y-4 mb-6 text-left">
                <div>
                    <label for="supabase-url" class="block text-sm font-medium mb-2">URL do Projeto Supabase</label>
                    <input type="text" id="supabase-url" placeholder="https://[seu-id].supabase.co" class="w-full text-sm p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-input border-primary text-primary" value="https://dhozwhfmrwiumwpcqabi.supabase.co">
                </div>
                <div>
                    <label for="supabase-key" class="block text-sm font-medium mb-2">Chave Secreta (service_role) ü§´</label>
                    <input type="password" id="supabase-key" placeholder="Cole sua chave secreta aqui..." class="w-full text-sm p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-input border-primary text-primary">
                    <p class="text-xs mt-1">Esta chave NUNCA √© salva. Voc√™ deve digit√°-la toda vez que for usar.</p>
                </div>
            </div>

            <div class="space-y-4 mb-6 border-t border-primary pt-6 text-left">
                <div>
                    <label for="sales-file-input" class="block text-sm font-medium mb-2">1. Arquivo de Vendas (M√™s Atual)</label>
                    <input type="file" id="sales-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="clients-file-input" class="block text-sm font-medium mb-2">2. Cadastro de Clientes</label>
                    <input type="file" id="clients-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="products-file-input" class="block text-sm font-medium mb-2">3. Cadastro de Produtos</label>
                    <input type="file" id="products-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="history-file-input" class="block text-sm font-medium mb-2">4. Hist√≥rico de Vendas (Trimestre Anterior)</label>
                    <input type="file" id="history-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                 <div>
                    <label for="innovations-file-input" class="block text-sm font-medium mb-2">5. Planilha de Inova√ß√µes (M√™s)</label>
                    <input type="file" id="innovations-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
            </div>

            <button id="generate-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg w-full disabled:bg-slate-500 disabled:hover:bg-slate-500 disabled:cursor-not-allowed">
                Enviar Dados para o Supabase
            </button>

            <div id="status-container" class="hidden mt-6 text-sm h-12 flex flex-col justify-center">
                <p id="status-text" class="mb-2"></p>
                <div class="w-full h-2 rounded-lg overflow-hidden bg-slate-700">
                    <div id="progress-bar" class="bg-teal-500 h-full transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </div>

    <script id="worker-script" type="text/worker-javascript">
        self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');

        // --- Fun√ß√µes de Ajuda (parseDate, parseBrazilianNumber, readFile) ---
        // (Sem altera√ß√µes nestas fun√ß√µes)
        function parseDate(dateString) {
            if (!dateString) return null;
            if (dateString instanceof Date) {
                return !isNaN(dateString.getTime()) ? dateString : null;
            }
            if (typeof dateString === 'number') {
                return new Date(Math.round((dateString - 25569) * 86400 * 1000));
            }
            if (typeof dateString !== 'string') return null;

            if (dateString.length === 10 && dateString.charAt(2) === '/' && dateString.charAt(5) === '/') {
                const [day, month, year] = dateString.split('/');
                if (year.length === 4) {
                    return new Date(`${year}-${month}-${day}T00:00:00`);
                }
            }

            const isoDate = new Date(dateString);
            return !isNaN(isoDate.getTime()) ? isoDate : null;
        }

        function parseBrazilianNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string' || !value) return 0;

            let numberString = value.replace(/R\$\s?/g, '').trim();

            const lastComma = numberString.lastIndexOf(',');
            const lastDot = numberString.lastIndexOf('.');

            if (lastComma > lastDot) {
                numberString = numberString.replace(/\./g, '').replace(',', '.');
            } else {
                numberString = numberString.replace(/,/g, '');
            }

            const number = parseFloat(numberString);
            return isNaN(number) ? 0 : number;
        }

        const readFile = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    // Se o arquivo for 'null' ou 'undefined', resolve com array vazio.
                    // Isto √© crucial para o upload parcial.
                    resolve([]);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        let jsonData;
                        const data = event.target.result;
                        if (file.name.endsWith('.csv')) {
                            let decodedData;
                            try {
                                decodedData = new TextDecoder('utf-8', { fatal: true }).decode(new Uint8Array(data));
                            } catch (e) {
                                decodedData = new TextDecoder('iso-8859-1').decode(new Uint8Array(data));
                            }

                            const lines = decodedData.split(/\r?\n/).filter(line => line.trim() !== '');
                            if (lines.length < 1) {
                                resolve([]);
                                return;
                            };

                            const firstLine = lines[0];
                            // Detec√ß√£o de delimitador robusta
                            const delimiters = [';', ',', '\t', '|'];
                            let bestDelimiter = ',';
                            let maxCount = 0;
                            delimiters.forEach(d => {
                                const count = (firstLine.match(new RegExp(`\\${d}`, 'g')) || []).length;
                                if (count > maxCount) {
                                    maxCount = count;
                                    bestDelimiter = d;
                                }
                            });

                            // CORRE√á√ÉO para CSV '5. INOVA√á√ïES.csv' que usa ';'
                            if (file.name.toUpperCase().includes("INOVA")) {
                                if (firstLine.includes(';')) bestDelimiter = ';';
                            }

                            const headers = lines.shift().trim().split(bestDelimiter).map(h => h.replace(/"/g, '').trim().replace(/^\uFEFF/, ''));

                            jsonData = lines.map(line => {
                                const values = line.split(bestDelimiter);
                                let row = {};
                                for (let i = 0; i < headers.length; i++) {
                                    row[headers[i]] = (values[i] || '').replace(/"/g, '').trim();
                                }
                                return row;
                            });
                        } else {
                            const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, cellDates: false });
                        }
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error(`Erro ao ler o arquivo '${file.name}'.`));
                reader.readAsArrayBuffer(file);
            });
        };
        // --- Fim das Fun√ß√µes de Ajuda ---


        // Esta fun√ß√£o (processSalesData) depende
        // dos mapas (clientMap, productMasterMap).
        // Se eles estiverem vazios, os dados de vendas
        // ficar√£o 'N/A' ou com valores padr√£o.
        const processSalesData = (rawData, clientMap, productMasterMap, newRcaSupervisorMap) => {
            return rawData.map(rawRow => {
                const codCliStr = String(rawRow['CODCLI']).trim();
                const clientInfo = clientMap.get(codCliStr) || {};

                let vendorName = String(rawRow['NOME'] || '');
                let supervisorName = String(rawRow['SUPERV'] || '');
                let codUsur = String(rawRow['CODUSUR'] || '').trim();
                let codSupervisor = String(rawRow['CODSUPERVISOR'] || '').trim();
                const pedido = String(rawRow['PEDIDO'] || '');
                let isAmericanas = false;

                const nomeClienteParaLogica = (clientInfo.razaosocial || clientInfo.fantasia || clientInfo.nomecliente || '').trim().toUpperCase();
                if (nomeClienteParaLogica.includes('AMERICANAS S.A')) {
                    vendorName = 'AMERICANAS';
                    codUsur = '1001';
                    supervisorName = 'BALCAO';
                    codSupervisor = '';
                    isAmericanas = true;

                    if (clientInfo.rcas) {
                         clientInfo.rca1 = '1001';
                         if (!clientInfo.rcas.includes('1001')) {
                            clientInfo.rcas.unshift('1001');
                         }
                    }
                }

                if (!isAmericanas) {
                    const rca1Cliente = (clientInfo.rca1 || '').trim();
                    const codUsurVenda = codUsur;
                    const codUsurParaBusca = rca1Cliente || codUsurVenda;
                    const rcaInfo = newRcaSupervisorMap.get(codUsurParaBusca);

                    if (rcaInfo) {
                        vendorName = rcaInfo.NOME;
                        supervisorName = rcaInfo.SUPERV;
                        codSupervisor = rcaInfo.CODSUPERVISOR;
                        codUsur = codUsurParaBusca;
                    }
                    else if (rca1Cliente && rca1Cliente !== codUsurVenda) {
                        const fallbackInfo = newRcaSupervisorMap.get(codUsurVenda);
                        if (fallbackInfo) {
                            vendorName = fallbackInfo.NOME;
                            supervisorName = fallbackInfo.SUPERV;
                            codSupervisor = fallbackInfo.CODSUPERVISOR;
                            codUsur = codUsurVenda;
                        } else {
                            codUsur = codUsurVenda;
                        }
                    }
                    else {
                        codUsur = codUsurVenda;
                    }
                }

                const supervisorUpper = (supervisorName || '').trim().toUpperCase();
                if (supervisorUpper === 'BALCAO' || supervisorUpper === 'BALC√ÉO') supervisorName = 'BALCAO';

                let dtPed = rawRow['DTPED'];
                const dtSaida = rawRow['DTSAIDA'];
                const parsedDtPed = parseDate(dtPed);
                const parsedDtSaida = parseDate(dtSaida);
                if (parsedDtPed && parsedDtSaida && (parsedDtPed.getFullYear() < parsedDtSaida.getFullYear() || (parsedDtPed.getFullYear() === parsedDtSaida.getFullYear() && parsedDtPed.getMonth() < parsedDtSaida.getMonth()))) {
                    dtPed = dtSaida;
                }
                const productCode = String(rawRow['PRODUTO'] || '').trim();
                // Se productMasterMap estiver vazio (sem arquivo de produtos), qtdeMaster ser√° 1.
                const qtdeMaster = productMasterMap.get(productCode) || 1;
                const qtVenda = parseInt(String(rawRow['QTVENDA'] || '0').trim(), 10) || 0;

                const tipoVenda = String(rawRow['TIPOVENDA'] || 'N/A').trim();
                const isFaturamento = (tipoVenda === '1' || tipoVenda === '9');
                const vlVendaOriginal = parseBrazilianNumber(rawRow['VLVENDA']);
                const vlBonificOriginal = parseBrazilianNumber(rawRow['VLBONIFIC']);
                const pesoOriginal = parseBrazilianNumber(rawRow['TOTPESOLIQ']);

                let filialValue = String(rawRow['FILIAL'] || '').trim();
                if (filialValue === '5') filialValue = '05';
                if (filialValue === '8') filialValue = '08';

                return {
                    pedido: pedido,
                    nome: vendorName,
                    superv: supervisorName,
                    produto: productCode,
                    descricao: String(rawRow['DESCRICAO'] || ''),
                    fornecedor: String(rawRow['FORNECEDOR'] || ''),
                    observacaofor: String(rawRow['OBSERVACAOFOR'] || '').trim(),
                    codfor: String(rawRow['CODFOR'] || '').trim(),
                    codusur: codUsur,
                    codcli: codCliStr,
                    // Se clientMap estiver vazio, clientInfo.nomeCliente ser√° 'undefined'
                    // e o '|| N/A' ser√° usado.
                    cliente_nome: clientInfo.nomeCliente || 'N/A',
                    cidade: clientInfo.cidade || 'N/A',
                    bairro: clientInfo.bairro || 'N/A',
                    qtvenda: qtVenda,
                    vlvenda: isFaturamento ? vlVendaOriginal : 0,
                    vlbonific: isFaturamento ? vlBonificOriginal : (vlVendaOriginal + vlBonificOriginal),
                    totpesoliq: pesoOriginal,
                    dtped: dtPed,
                    dtsaida: dtSaida,
                    posicao: String(rawRow['POSICAO'] || ''),
                    estoqueunit: parseBrazilianNumber(rawRow['ESTOQUEUNIT']),
                    qtvenda_embalagem_master: isNaN(qtdeMaster) || qtdeMaster === 0 ? 0 : qtVenda / qtdeMaster,
                    tipovenda: tipoVenda,
                    filial: filialValue,
                    codsupervisor: codSupervisor
                };
            });
        };

        function getPassedWorkingDaysInSpecificMonth(year, month, today) {
            let count = 0;
            const date = new Date(Date.UTC(year, month, 1));
            const todayUTC = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate()));

            while (date <= todayUTC && date.getUTCMonth() === month) {
                const dayOfWeek = date.getUTCDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    count++;
                }
                date.setDate(date.getDate() + 1);
            }
            return count > 0 ? count : 1;
        }

        // O Worker principal (sem altera√ß√µes)
        self.onmessage = async (event) => {
            const { salesFile, clientsFile, productsFile, historyFile, innovationsFile } = event.data;

            try {
                self.postMessage({ type: 'progress', status: 'Lendo arquivos...', percentage: 10 });
                // Gra√ßas √† fun√ß√£o 'readFile', se um arquivo n√£o for fornecido (ex: clientsFile = null),
                // a vari√°vel (ex: clientsDataRaw) ser√° apenas um array vazio [].
                const [salesDataRaw, clientsDataRaw, productsDataRaw, historyDataRaw, innovationsDataRaw] = await Promise.all([
                    readFile(salesFile),
                    readFile(clientsFile),
                    readFile(productsFile),
                    readFile(historyFile),
                    readFile(innovationsFile)
                ]);

                // Se houver dados de vendas OU hist√≥rico, o mapa de supervisores √© necess√°rio.
                // Se n√£o, pulamos esta etapa.
                const newRcaSupervisorMap = new Map();
                if (salesDataRaw.length > 0 || historyDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Criando mapa mestre de supervisores...', percentage: 20 });
                    const lastSaleDateMap = new Map();
                    const allSalesForMap = [...salesDataRaw, ...historyDataRaw];

                    allSalesForMap.forEach(row => {
                        try {
                            const codUsur = String(row['CODUSUR'] || '').trim();
                            if (codUsur === '1001') return;
                            const dtPed = row['DTPED'];
                            if (!codUsur || !dtPed) return;
                            const saleDate = parseDate(dtPed);
                            if (!saleDate || isNaN(saleDate.getTime())) return;
                            const lastDate = lastSaleDateMap.get(codUsur);
                            if (!lastDate || saleDate >= lastDate) {
                                lastSaleDateMap.set(codUsur, saleDate);
                                newRcaSupervisorMap.set(codUsur, {
                                    NOME: String(row['NOME'] || ''),
                                    SUPERV: String(row['SUPERV'] || ''),
                                    CODSUPERVISOR: String(row['CODSUPERVISOR'] || '').trim()
                                });
                            }
                        } catch (e) {
                            console.error('Erro ao processar linha para mapa mestre:', e, row);
                        }
                    });
                }


                const stockMap05 = new Map();
                const stockMap08 = new Map();
                const allProductCodesInStock = new Set();
                if (salesDataRaw.length > 0) {
                     self.postMessage({ type: 'progress', status: 'Extraindo estoque...', percentage: 25 });
                    salesDataRaw.forEach(item => {
                        const productCode = String(item['PRODUTO'] || '').trim();
                        if (!productCode) return;
                        allProductCodesInStock.add(productCode);
                        let branch = String(item['FILIAL'] || '').trim();
                        const stockQtyCx = parseBrazilianNumber(item['ESTOQUECX']);
                        if (branch === '5') branch = '05';
                        if (branch === '8') branch = '08';
                        if (branch === '05') stockMap05.set(productCode, stockQtyCx);
                        else if (branch === '08') stockMap08.set(productCode, stockQtyCx);
                    });
                }

                const productMasterMap = new Map();
                const productDetailsMap = new Map();
                const activeProductCodesFromCadastro = new Set();
                if (productsDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Mapeando produtos...', percentage: 30 });
                    productsDataRaw.forEach(prod => {
                        const productCode = String(prod['C√≥digo'] || '').trim();
                        if (!productCode) return;
                        activeProductCodesFromCadastro.add(productCode);

                        let qtdeMaster = parseInt(prod['Qtde embalagem master(Compra)'], 10);
                        if (isNaN(qtdeMaster) || qtdeMaster <= 0) qtdeMaster = 1;
                        productMasterMap.set(productCode, qtdeMaster);
                        if (!productDetailsMap.has(productCode)) {
                            productDetailsMap.set(productCode, {
                                code: productCode,
                                descricao: String(prod['Descri√ß√£o'] || `Produto ${productCode}`),
                                fornecedor: String(prod['Nome do fornecedor'] || 'N/A'),
                                codfor: String(prod['Fornecedor'] || 'N/A'),
                                // CORRE√á√ÉO: Removido o '1,' que estava a causar o SyntaxError
                                dtcadastro: prod['Dt.Cadastro'] || null
                            });
                        }
                    });
                }

                const clientMap = new Map();
                if (clientsDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Processando clientes...', percentage: 50 });
                    clientsDataRaw.forEach(client => {
                        const codCli = String(client['C√≥digo'] || '').trim();
                        if (!codCli) return;
                        const rca1 = String(client['RCA 1'] || '');
                        const rca2 = String(client['RCA 2'] || '');
                        const rcas = new Set();
                        if (rca1) rcas.add(rca1);
                        if (rca2) rcas.add(rca2);
                        let registrationDateStr = client['Data e Hora de Cadastro'] || '';
                        if (registrationDateStr.includes(' ')) registrationDateStr = registrationDateStr.split(' ')[0];

                        // *** AQUI EST√Å A MUDAN√áA ***
                        const clientData = {
                            codigo_cliente: codCli, // CORRIGIDO: Chave prim√°ria agora √© ASCII
                            rcas: Array.from(rcas),
                            rca1: rca1,
                            rca2: rca2,
                            cidade: String(client['Nome da Cidade'] || 'N/A'),
                            nomecliente: String(client['Fantasia'] || client['Cliente'] || 'N/A'),
                            bairro: String(client['Bairro'] || 'N/A'),
                            razaosocial: String(client['Cliente'] || 'N/A'),
                            fantasia: String(client['Fantasia'] || 'N/A'),
                            cnpj_cpf: String(client['CNPJ/CPF'] || 'N/A'),
                            endereco: String(client['Endere√ßo Comercial'] || client['Endere√ßo'] || 'N/A'),
                            numero: String(client['N√∫mero'] || 'SN'),
                            cep: String(client['CEP'] || 'N/A'),
                            telefone: String(client['Telefone Comercial'] || 'N/A'),
                            email: String(client['E-mail'] || 'N/A'),
                            ramo: String(client['Descricao'] || 'N/A'),
                            ultimacompra: client['Data da √öltima Compra'],
                            datacadastro: registrationDateStr,
                            bloqueio: String(client['Bloqueio'] || '').trim().toUpperCase(),
                            inscricaoestadual: String(client['Insc. Est. / Produtor'] || 'N/A')
                        };
                        // O clientMap agora usa o 'codCli' (ex: "11465") como chave
                        // e armazena o objeto 'clientData' (que tem 'codigo_cliente' dentro)
                        clientMap.set(codCli, clientData);
                    });
                }

                // Processa vendas (mesmo que salesDataRaw seja [], a fun√ß√£o retorna [])
                self.postMessage({ type: 'progress', status: 'Cruzando dados de vendas...', percentage: 70 });
                // NOTA: O 'processSalesData' usa o 'clientMap.get(codCliStr)',
                // o que est√° correto, pois 'codCliStr' √© o "C√≥digo" (ex: "11465").
                // O 'clientInfo' retornado ser√° o objeto 'clientData' que j√°
                // tem 'codigo_cliente' e as outras colunas.
                const processedSalesData = processSalesData(salesDataRaw, clientMap, productMasterMap, newRcaSupervisorMap);
                const processedHistoryData = processSalesData(historyDataRaw, clientMap, productMasterMap, newRcaSupervisorMap);

                // Aplica regras de neg√≥cio (mesmo que os arrays estejam vazios)
                self.postMessage({ type: 'progress', status: 'Aplicando regras de filial...', percentage: 75 });
                const allProcessedSales = [...processedSalesData, ...processedHistoryData].sort((a, b) => {
                    const dateA = parseDate(a.dtped) || new Date(0);
                    const dateB = parseDate(b.dtped) || new Date(0);
                    return dateA - dateB;
                });
                const clientLastBranch = new Map();
                const clientsWith05Purchase = new Set();
                allProcessedSales.forEach(sale => {
                    const codCli = sale.codcli;
                    const filial = sale.filial;
                    if (codCli && filial) {
                        clientLastBranch.set(codCli, filial);
                        if (filial === '05') clientsWith05Purchase.add(codCli);
                    }
                });
                const clientBranchOverride = new Map();
                clientsWith05Purchase.forEach(codCli => {
                    const lastBranch = clientLastBranch.get(codCli);
                    if (lastBranch && lastBranch === '08') clientBranchOverride.set(codCli, '08');
                });
                const applyBranchOverride = (salesArray, overrideMap) => {
                    return salesArray.map(sale => {
                        const override = overrideMap.get(sale.codcli);
                        if (override && sale.filial === '05') return { ...sale, filial: override };
                        return sale;
                    });
                };
                let finalSalesData = applyBranchOverride(processedSalesData, clientBranchOverride);
                let finalHistoryData = applyBranchOverride(processedHistoryData, clientBranchOverride);

                self.postMessage({ type: 'progress', status: 'Aplicando regra (Tiago)...', percentage: 78 });
                const tiagoSellersToMoveTo08 = new Set(['291', '292', '293', '284', '289', '287', '286']);
                const applyTiagoRule = (salesArray) => {
                    return salesArray.map(sale => {
                        if (sale.codsupervisor === '12' && tiagoSellersToMoveTo08.has(sale.codusur)) {
                            return { ...sale, filial: '08' };
                        }
                        return sale;
                    });
                };
                finalSalesData = applyTiagoRule(finalSalesData);
                finalHistoryData = applyTiagoRule(finalHistoryData);

                // Atualiza datas de compra APENAS se houver novos clientes E novas vendas
                if (clientMap.size > 0 && finalSalesData.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Atualizando datas de compra...', percentage: 80 });
                    const latestSaleDateByClient = new Map();
                    finalSalesData.forEach(sale => {
                        const codcli = sale.codcli;
                        const saleDate = parseDate(sale.dtped);
                        if (codcli && saleDate) {
                            const existingDate = latestSaleDateByClient.get(codcli);
                            if (!existingDate || saleDate > existingDate) latestSaleDateByClient.set(codcli, saleDate);
                        }
                    });
                    clientMap.forEach((client, codcli) => {
                        const lastPurchaseDate = parseDate(client.ultimacompra);
                        const latestSaleDate = latestSaleDateByClient.get(codcli);
                        if (latestSaleDate && (!lastPurchaseDate || isNaN(lastPurchaseDate.getTime()) || latestSaleDate > lastPurchaseDate)) {
                            client.ultimacompra = latestSaleDate;
                        }
                    });
                }

                // Agrega pedidos (se houver vendas)
                self.postMessage({ type: 'progress', status: 'Agregando pedidos...', percentage: 90 });
                const aggregateOrders = (data) => {
                    const orders = new Map();
                    data.forEach(row => {
                        if (!row.pedido) return;
                        if (!orders.has(row.pedido)) {
                            orders.set(row.pedido, { ...row, qtvenda: 0, vlvenda: 0, vlbonific: 0, totpesoliq: 0, fornecedores: new Set(), codfors: new Set() });
                        }
                        const order = orders.get(row.pedido);
                        order.qtvenda += row.qtvenda;
                        order.vlvenda += row.vlvenda;
                        order.vlbonific += row.vlbonific;
                        order.totpesoliq += row.totpesoliq;
                        if (row.observacaofor) order.fornecedores.add(row.observacaofor);
                        if (row.codfor) order.codfors.add(row.codfor);
                    });
                    return Array.from(orders.values()).map(order => {
                        order.fornecedores_list = Array.from(order.fornecedores);
                        order.fornecedores_str = order.fornecedores_list.join(', ');
                        order.codfors_list = Array.from(order.codfors);
                        delete order.fornecedores;
                        delete order.codfors;
                        return order;
                    });
                };
                // Se finalSalesData for [], aggregatedByOrder tamb√©m ser√° [].
                const aggregatedByOrder = aggregateOrders(finalSalesData);

                // --- Prepara√ß√£o dos dados finais ---
                // Se os arrays de input estavam vazios, os arrays de output tamb√©m estar√£o.
                // Ex: Se clientsDataRaw = [], finalClientsData = []

                const finalClientsData = Array.from(clientMap.values());
                const finalProductDetailsData = Array.from(productDetailsMap.values());
                const finalActiveProductsData = Array.from(activeProductCodesFromCadastro).map(code => ({ code: code }));

                const finalStockData = [];
                allProductCodesInStock.forEach(code => {
                    finalStockData.push({ product_code: code, filial: "05", stock_qty: stockMap05.get(code) || 0 });
                    finalStockData.push({ product_code: code, filial: "08", stock_qty: stockMap08.get(code) || 0 });
                });

                // Metadados s√£o sempre atualizados se houver vendas
                const finalMetadata = [];
                if (finalSalesData.length > 0) {
                     const lastSaleDate = finalSalesData.length > 0
                        ? new Date(Math.max.apply(null, finalSalesData.map(s => parseDate(s.dtped)).filter(d => d && !isNaN(d))))
                        : new Date();
                    lastSaleDate.setHours(0,0,0,0);
                    const passedWorkingDaysCurrentMonth = getPassedWorkingDaysInSpecificMonth(
                        lastSaleDate.getFullYear(),
                        lastSaleDate.getMonth(),
                        lastSaleDate
                    );

                    finalMetadata.push({
                        key: "passed_working_days",
                        value: String(passedWorkingDaysCurrentMonth)
                    });
                    finalMetadata.push({
                        key: "last_update",
                        value: new Date().toISOString()
                    });
                }


                const finalInnovationsData = innovationsDataRaw.map(item => ({
                    inovacoes: item.Inovacoes || item.inovacoes,
                    codigo: item.Codigo || item.codigo,
                    produto: item.Produto || item.produto
                }));


                self.postMessage({ type: 'progress', status: 'Finalizando...', percentage: 100 });

                // O objeto 'data' S√ì TER√Å chaves para os dados
                // que foram realmente processados.
                self.postMessage({
                    type: 'result',
                    data: {
                        detailed: finalSalesData,
                        history: finalHistoryData,
                        byOrder: aggregatedByOrder,
                        clients: finalClientsData,
                        product_details: finalProductDetailsData,
                        active_products: finalActiveProductsData,
                        stock: finalStockData,
                        innovations: finalInnovationsData,
                        metadata: finalMetadata
                    }
                });

            } catch (error) {
                self.postMessage({ type: 'error', message: error.message + (error.stack ? `
Stack: ${error.stack}`: '') });
            }
        };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const salesFileInput = document.getElementById('sales-file-input');
            const clientsFileInput = document.getElementById('clients-file-input');
            const productsFileInput = document.getElementById('products-file-input');
            const historyFileInput = document.getElementById('history-file-input');
            const innovationsFileInput = document.getElementById('innovations-file-input');
            const generateBtn = document.getElementById('generate-btn');

            const statusContainer = document.getElementById('status-container');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');

            const supabaseUrlInput = document.getElementById('supabase-url');
            const supabaseKeyInput = document.getElementById('supabase-key');

            let files = {};

            // L√≥gica do Bot√£o (sem altera√ß√£o)
            const checkFiles = () => {
                const atLeastOneFileLoaded = files.salesFile || files.clientsFile || files.productsFile || files.historyFile || files.innovationsFile;
                const supabaseConfigReady = supabaseUrlInput.value && supabaseKeyInput.value;
                generateBtn.disabled = !(atLeastOneFileLoaded && supabaseConfigReady);
            };

            // 'Listeners' (sem altera√ß√£o)
            salesFileInput.addEventListener('change', (e) => { files.salesFile = e.target.files[0]; checkFiles(); });
            clientsFileInput.addEventListener('change', (e) => { files.clientsFile = e.target.files[0]; checkFiles(); });
            productsFileInput.addEventListener('change', (e) => { files.productsFile = e.target.files[0]; checkFiles(); });
            historyFileInput.addEventListener('change', (e) => { files.historyFile = e.target.files[0]; checkFiles(); });
            innovationsFileInput.addEventListener('change', (e) => { files.innovationsFile = e.target.files[0]; checkFiles(); });
            supabaseUrlInput.addEventListener('input', checkFiles);
            supabaseKeyInput.addEventListener('input', checkFiles);

            // 'Worker' (sem altera√ß√£o)
            const workerScript = document.getElementById('worker-script').textContent;
            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);
            const worker = new Worker(workerUrl);

            // 'onmessage' do worker (sem altera√ß√£o)
            worker.onmessage = (event) => {
                const { type, status, percentage, data, message } = event.data;

                if (type === 'progress') {
                    statusText.textContent = status;
                    progressBar.style.width = `${percentage}%`;
                } else if (type === 'result') {
                    statusText.textContent = 'Dados processados! Enviando para o Supabase...';
                    progressBar.style.width = '100%';
                    enviarDadosParaSupabase(data);
                } else if (type === 'error') {
                    statusContainer.classList.remove('hidden');
                    statusText.innerHTML = `<p class="text-red-500">Erro no Worker: ${message}</p>`;
                    progressBar.style.width = '0%';
                    generateBtn.disabled = false;
                }
            };

            // 'click' do bot√£o (sem altera√ß√£o)
            generateBtn.addEventListener('click', () => {
                if (generateBtn.disabled) return;

                generateBtn.disabled = true;
                statusContainer.classList.remove('hidden');
                statusText.textContent = 'A iniciar o processamento...';
                progressBar.style.width = '0%';

                worker.postMessage({
                    salesFile: files.salesFile || null,
                    clientsFile: files.clientsFile || null,
                    productsFile: files.productsFile || null,
                    historyFile: files.historyFile || null,
                    innovationsFile: files.innovationsFile || null
                });
            });

            // 'enviarDadosEmLotes' (sem altera√ß√£o da v5)
            async function enviarDadosEmLotes(supabaseClient, nomeTabela, dados, statusText, progressBar, progressoInicial, progressoFinal, primaryKeys = ['id']) {
                const TAMANHO_LOTE = 500;

                try {
                    if (dados.length > 0) {
                        const totalLotes = Math.ceil(dados.length / TAMANHO_LOTE);

                        const anyColumn = primaryKeys[0];
                        statusText.textContent = `(Etapa ${progressoInicial < 40 ? '1' : '2'}/9) Limpando dados antigos de ${nomeTabela}...`;

                        // *** O 'deleteError' AQUI VAI FINALMENTE PARAR DE ACONTECER ***
                        // CORRE√á√ÉO: Usa um filtro gen√©rico que n√£o depende do nome da coluna,
                        // mas agora verifica se a coluna √© num√©rica para evitar erros de tipo.
                        const primaryKey = primaryKeys[0];
                        const isNumericColumn = primaryKey === 'pedido' || primaryKey === 'codigo' || primaryKey === 'product_code' || (dados.length > 0 && typeof dados[0][primaryKey] === 'number');
                        const impossibleValue = isNumericColumn ? -1 : 'IMPOSSIBLE_VALUE_TO_MATCH';

                        const { error: deleteError } = await supabaseClient
                            .from(nomeTabela)
                            .delete()
                            .neq(primaryKey, impossibleValue);

                        if (deleteError) throw new Error(`Falha ao limpar ${nomeTabela}: ${deleteError.message}`);

                        for (let i = 0; i < totalLotes; i++) {
                            const inicio = i * TAMANHO_LOTE;
                            const fim = inicio + TAMANHO_LOTE;
                            const lote = dados.slice(inicio, fim);

                            const statusMsg = `(Etapa ${progressoInicial < 40 ? '1' : '2'}/8) Enviando ${nomeTabela} (Lote ${i + 1}/${totalLotes})...`;
                            statusText.textContent = statusMsg;

                            const { error: insertError } = await supabaseClient
                                .from(nomeTabela)
                                .insert(lote);

                            if (insertError) {
                                console.error(`Erro no lote ${i+1} de ${nomeTabela}:`, insertError);
                                throw new Error(`Erro ao inserir ${nomeTabela} (Lote ${i + 1}): ${insertError.message}`);
                            }

                            const progressoLote = (i + 1) / totalLotes;
                            const progressoTotal = progressoInicial + (progressoLote * (progressoFinal - progressoInicial));
                            progressBar.style.width = `${progressoTotal}%`;
                        }
                    } else {
                        progressBar.style.width = `${progressoFinal}%`;
                    }
                } catch (error) {
                    throw error;
                }
            }


            // Fun√ß√£o principal de envio
            async function enviarDadosParaSupabase(data) {
                const SUPABASE_URL = supabaseUrlInput.value;
                const SUPABASE_KEY = supabaseKeyInput.value;

                if (!SUPABASE_URL || !SUPABASE_KEY) {
                    statusText.innerHTML = `<p class="text-red-500">Erro: URL ou Chave Secreta do Supabase n√£o informada.</p>`;
                    generateBtn.disabled = false;
                    return;
                }

                try {
                    const { createClient } = supabase;
                    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

                    statusText.textContent = 'Conectado! Verificando dados para enviar...';
                    progressBar.style.width = '5%';

                    const tasks = [];

                    if (data.detailed) tasks.push({ name: 'Vendas Atuais', tableName: 'data_detailed', data: data.detailed, keys: ['pedido'] });
                    if (data.history) tasks.push({ name: 'Hist√≥rico', tableName: 'data_history', data: data.history, keys: ['pedido'] });
                    if (data.byOrder) tasks.push({ name: 'Pedidos', tableName: 'data_orders', data: data.byOrder, keys: ['pedido'] });
                    // *** AQUI EST√Å A MUDAN√áA ***
                    if (data.clients) tasks.push({ name: 'Clientes', tableName: 'data_clients', data: data.clients, keys: ['codigo_cliente'] }); // CORRIGIDO
                    if (data.product_details) tasks.push({ name: 'Detalhes de Produtos', tableName: 'data_product_details', data: data.product_details, keys: ['code'] });
                    if (data.active_products) tasks.push({ name: 'Produtos Ativos', tableName: 'data_active_products', data: data.active_products, keys: ['code'] });
                    if (data.stock) tasks.push({ name: 'Estoque', tableName: 'data_stock', data: data.stock, keys: ['product_code'] });
                    if (data.innovations) tasks.push({ name: 'Inova√ß√µes', tableName: 'data_innovations', data: data.innovations, keys: ['codigo'] });
                    if (data.metadata) tasks.push({ name: 'Metadados', tableName: 'data_metadata', data: data.metadata, keys: ['key'] });

                    if (tasks.length === 0) {
                        statusText.innerHTML = `<p class="text-yellow-500">Nenhum dado novo foi processado.</p>`;
                        generateBtn.disabled = false;
                        return;
                    }

                    const totalTasks = tasks.length;

                    for (let i = 0; i < totalTasks; i++) {
                        const task = tasks[i];
                        const taskProgress = ((i + 1) / totalTasks);
                        const progressoInicial = (i / totalTasks) * 100;
                        const progressoFinal = taskProgress * 100;

                        statusText.textContent = `Enviando (${i + 1}/${totalTasks}): ${task.name}...`;

                        await enviarDadosEmLotes(
                            supabaseClient,
                            task.tableName,
                            task.data,
                            statusText,
                            progressBar,
                            progressoInicial,
                            progressoFinal,
                            task.keys
                        );
                    }

                    // CORRE√á√ÉO: Removido o 'E' que estava a causar um SyntaxError
                    // SUCESSO!
                    statusText.innerHTML = `<p class="text-green-500">Sucesso! Dados do dashboard atualizados.</p>`;
                    progressBar.style.width = '100%';
                    generateBtn.disabled = false;

                    // Limpa os campos de arquivo para a pr√≥xima
                    salesFileInput.value = '';
                    clientsFileInput.value = '';
                    productsFileInput.value = '';
                    historyFileInput.value = '';
                    innovationsFileInput.value = '';
                    files = {};
                    checkFiles();

                } catch (error) {
                    console.error('Erro no Supabase:', error);
                    statusText.innerHTML = `<p class="text-red-500">Erro ao enviar: ${error.message}</p>`;
                    progressBar.style.width = '0%';
                    generateBtn.disabled = false;
                }
            }
            checkFiles();
        });
    </script>

</body>
</html>
