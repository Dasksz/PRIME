<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vendas - PRIME DISTRIBUIÇÃO</title>
    <link rel="icon" type="image/jpeg" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSnaaZ2WnZBJIxPRfabS4Ug78PKK6Gu3nbHlw&s">
    <!-- 1. ADICIONADO: Scripts necessários para o dashboard -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- 2. ADICIONADO: Biblioteca do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 3. ADICIONADO: Biblioteca para ler arquivos Excel (XLSX) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Theming */
        :root, html[data-theme="light"] {
            --bg-main: #F1F3F5;                     /* Cinza muito claro */
            --bg-content: #FFFFFF;                  /* Branco */
            --bg-header-gradient-from: #FD7E14;      /* Laranja refinado */
            --bg-header-gradient-to: #E8590C;        /* Laranja mais escuro para gradiente */
            --bg-menu: #FFFFFF;
            --header-span-text: #FFFFFF;
            --bg-menu-button-hover: #F8F9FA;
            --bg-modal-overlay: rgba(0,0,0,0.4);
            --bg-modal-content: #FFFFFF;             /* Sólido */
            --bg-input: #FFFFFF;                     /* Sólido */
            --bg-button: #E9ECEF;
            --bg-button-hover: #DEE2E6;
            --bg-button-active: #FD7E14;
            --bg-tooltip: #212529;
            --text-primary: #212529;
            --text-secondary: #868E96;
            --text-on-active-button: #ffffff;
            --text-on-dark-bg: #ffffff;
            --text-menu: #343A40;
            --text-menu-header: #D95A0B;
            --text-menu-section: #495057;
            --border-primary: #E9ECEF;               /* Borda sutil */
            --border-secondary: #F1F3F5;
            --border-menu-section: #E9ECEF;
            --scrollbar-track: #F1F3F5;
            --scrollbar-thumb: #CED4DA;
            --kpi-card-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        html[data-theme="dark"] {
            --bg-main: #222831;                      /* Cinza-azulado escuro */
            --bg-content: #393E46;                   /* Cinza-azulado médio */
            /* CORREÇÃO: Força o cabeçalho a ser laranja em ambos os temas */
            --bg-header-gradient-from: #FD7E14;
            --bg-header-gradient-to: #E8590C;
            --bg-menu: #393E46;
            --header-span-text: #FFD369;             /* Dourado/Âmbar */
            --bg-menu-button-hover: #4A5058;
            --bg-modal-overlay: rgba(0,0,0,0.6);
            --bg-modal-content: #4A5058;             /* CORRIGIDO: Mais claro que o --bg-content */
            --bg-input: #222831;                     /* Fundo escuro para contraste */
            --bg-button: #4A5058;
            --bg-button-hover: #5A6069;
            --bg-button-active: #FFD369;
            --bg-tooltip: #222831;
            --text-primary: #EEEEEE;                 /* Branco suave */
            --text-secondary: #ADB5BD;
            --text-on-active-button: #222831;        /* Texto escuro no botão ativo */
            --text-on-dark-bg: #EEEEEE;
            --text-menu: #EEEEEE;
            --text-menu-header: #FFD369;
            --text-menu-section: #ADB5BD;
            --border-primary: #ADB5BD;               /* CORRIGIDO: Borda mais clara para destaque */
            --border-secondary: #4A5058;
            --border-menu-section: #4A5058;
            --scrollbar-track: #222831;
            --scrollbar-thumb: #4A5058;
            --kpi-card-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* General Styles using Variables */
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }
        ::-webkit-scrollbar-corner { background: var(--scrollbar-track); }
        .sticky-header th { position: sticky; top: 0; z-index: 10; background-color: var(--bg-content); border-bottom: 2px solid var(--border-secondary); }
        .hidden { display: none !important; }
        
        /* CORREÇÃO: Unifica a cor de fundo de todos os botões de filtro e dropdowns para corresponder aos <select> */
        .metric-btn, .fornecedor-btn, .comparison-toggle-btn, .group-btn, 
        #main-rede-group-container > div > button, #city-rede-group-container > div > button, #comparison-rede-group-container > div > button, #stock-rede-group-container > div > button,
        #vendedor-filter-btn, #tipo-venda-filter-btn, #city-vendedor-filter-btn, #comparison-vendedor-filter-btn, #comparison-supplier-filter-btn, #comparison-product-filter-btn, #stock-vendedor-filter-btn, #stock-supplier-filter-btn, #stock-product-filter-btn, #innovations-vendedor-filter-btn, #innovations-supplier-filter-btn, #innovations-product-filter-btn, #coverage-vendedor-filter-btn, #coverage-supplier-filter-btn, #coverage-product-filter-btn,
        #main-holiday-picker-btn, #comparison-holiday-picker-btn, #clear-filters-btn, #clear-city-filters-btn, #clear-weekly-filters-btn, #clear-comparison-filters-btn, #clear-stock-filters-btn, #clear-innovations-filters-btn, #clear-innovations-month-filters-btn, #clear-coverage-filters-btn { 
            background-color: var(--bg-input); 
            color: var(--text-secondary);
        }
        /* Adiciona borda aos botões que não a tinham, para consistência com os <select> */
        .fornecedor-btn, #clear-filters-btn, #clear-city-filters-btn, #clear-weekly-filters-btn, #clear-comparison-filters-btn, #clear-stock-filters-btn, #clear-innovations-filters-btn, #clear-innovations-month-filters-btn, #clear-coverage-filters-btn {
            border: 1px solid var(--border-primary);
        }
        
        /* Regra de HOVER unificada para todos os botões de filtro */
        .metric-btn:hover, .fornecedor-btn:hover, .comparison-toggle-btn:hover, .group-btn:hover, 
        #main-rede-group-container > div > button:hover, #city-rede-group-container > div > button:hover, #comparison-rede-group-container > div > button:hover, #stock-rede-group-container > div > button:hover,
        #vendedor-filter-btn:hover, #tipo-venda-filter-btn:hover, #city-vendedor-filter-btn:hover, #comparison-vendedor-filter-btn:hover, #comparison-supplier-filter-btn:hover, #comparison-product-filter-btn:hover, #stock-vendedor-filter-btn:hover, #stock-supplier-filter-btn:hover, #stock-product-filter-btn:hover, #innovations-vendedor-filter-btn:hover, #innovations-supplier-filter-btn:hover, #innovations-product-filter-btn:hover, #coverage-vendedor-filter-btn:hover, #coverage-supplier-filter-btn:hover, #coverage-product-filter-btn:hover,
        #main-holiday-picker-btn:hover, #comparison-holiday-picker-btn:hover, #clear-filters-btn:hover, #clear-city-filters-btn:hover, #clear-weekly-filters-btn:hover, #clear-comparison-filters-btn:hover, #clear-stock-filters-btn:hover, #clear-innovations-filters-btn:hover, #clear-innovations-month-filters-btn:hover, #clear-coverage-filters-btn:hover { 
            background-color: var(--bg-button-hover); 
        }
        .metric-btn.active, .fornecedor-btn.active, .comparison-toggle-btn.active, .group-btn.active, #main-rede-group-container > div > button.active, #city-rede-group-container > div > button.active, #comparison-rede-group-container > div > button.active, #stock-rede-group-container > div > button.active { background-color: var(--bg-button-active); color: var(--text-on-active-button); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-modal-overlay); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay > div { background-color: var(--bg-modal-content); border: 1px solid var(--border-primary); } /* Style modal content */

        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltip-text { visibility: hidden; width: auto; min-width: 80px; background-color: var(--bg-tooltip); color: var(--text-on-dark-bg); text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1001; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 10px; }
        .kpi-card { 
            background-color: var(--bg-content); 
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; 
            text-align: left; 
            border: 1px solid var(--border-primary); 
            box-shadow: var(--kpi-card-shadow); 
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--kpi-border-color, var(--bg-button-active));
        }
        .kpi-card h3 {
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem; /* text-xs */
            margin-left: 1rem; /* pl-4 considering the ::before element */
        }
        .kpi-card p:not(.kpi-subtext) {
            color: var(--text-primary);
            font-size: 2rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
            margin-left: 1rem;
        }
        .kpi-card .kpi-subtext {
            color: var(--text-secondary);
            font-size: 0.75rem; /* text-xs */
            margin-left: 1rem;
            margin-top: -0.25rem;
        }

        /* CORREÇÃO: Nova classe para dar destaque aos KPIs da tela de Comparativo */
        .comparison-kpi-card {
            background-color: var(--bg-content);
            border: 1px solid var(--border-primary);
            box-shadow: var(--kpi-card-shadow);
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            text-align: center;
        }

        .stock-trend-btn.active { outline: 2px solid var(--bg-button-active); outline-offset: 2px; transform: scale(1.1); }
        
        /* CORREÇÃO: Classes de fundo personalizadas que faltavam */
        .bg-content { background-color: var(--bg-content); }
        .bg-input { background-color: var(--bg-input); }
        .bg-modal-content { background-color: var(--bg-modal-content); }

        select, input[type=text], input[type=number] { background-color: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary); }
        .header-gradient { background-image: linear-gradient(to right, var(--bg-header-gradient-from), var(--bg-header-gradient-to)); }
        h1, h2, h3, h4, h5, h6 { color: var(--text-primary); }
        p, span, div, label, th, td { color: var(--text-secondary); }
        h1 span, #side-menu h2 { color: var(--text-menu-header); }
        .text-white { color: var(--text-on-dark-bg); } /* Re-evaluate usage */

        tbody tr:hover { background-color: var(--bg-menu-button-hover); }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Loader Style */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        #loader-spinner {
            border: 4px solid #1d2347;
            border-top: 4px solid var(--bg-button-active);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loader Spinner */
        #loader-spinner {
            border: 4px solid var(--border-secondary);
            border-top: 4px solid var(--bg-button-active);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Retractable Menu Styles */
        #side-menu { background-color: var(--bg-menu); color: var(--text-menu); }
        #side-menu.open { transform: translateX(0); }
        #menu-overlay.open { display: block; opacity: 1; }
        .nav-section h3 {
            color: var(--text-menu-section);
            font-weight: 700;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid var(--border-menu-section);
        }
        .nav-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem 1rem; /* Reduced padding */
            border-radius: 0.375rem; /* rounded-md */
            color: var(--text-menu);
            transition: background-color 0.2s, color 0.2s;
            border-left: 3px solid transparent; /* For active state */
            font-weight: 500;
        }
        .nav-btn:hover { 
            background-color: var(--bg-menu-button-hover); 
            color: var(--text-primary);
        }
        .nav-btn.active {
            background-color: var(--bg-menu-button-hover);
            color: var(--text-primary);
            font-weight: 600;
            border-left-color: var(--bg-button-active);
        }

        /* Theme Switcher Styles */
        .theme-switcher {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--border-menu-section);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--bg-button-active);
        }
        input:checked + .slider:before {
            transform: translateX(14px);
        }
    </style>
</head>
<body class="antialiased">

    <!-- Botão do Menu Hamburguer (Fixo no Canto) -->
    <button id="menu-toggle-btn" class="fixed top-4 left-4 z-[1100] p-2 rounded-md transition-colors" style="background-color: var(--bg-button); color: var(--text-secondary);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
    </button>
    
    <!-- Overlay -->
    <div id="menu-overlay" class="fixed inset-0 bg-black/60 z-[1150] hidden transition-opacity duration-300"></div>

    <!-- Menu Lateral Retrátil -->
    <div id="side-menu" class="fixed top-0 left-0 h-full w-64 p-4 z-[1200] transform -translate-x-full transition-transform duration-300 ease-in-out custom-scrollbar overflow-y-auto flex flex-col">
        <h2 class="text-xl font-bold mb-6 text-center">PRIME</h2>
        <nav id="main-nav" class="flex-grow space-y-4">
             <!-- As seções e botões de navegação serão inseridos aqui -->
        </nav>
        <!-- Theme Switcher -->
        <div class="theme-switcher mt-auto">
            <span class="text-sm font-medium" style="color: var(--text-menu-section);">Tema</span>
            <label class="switch">
                <input type="checkbox" id="theme-toggle-checkbox">
                <span class="slider"></span>
            </label>
        </div>
    </div>


    <!-- 5. ADICIONADO: Loader que será exibido enquanto os dados carregam -->
    <div id="loader">
        <div id="loader-spinner"></div>
        <p id="loader-text" class="text-slate-300 mt-4">Carregando dados do Supabase...</p>
    </div>

    <!-- 6. ADICIONADO: Todo o HTML do seu dashboard escuro original -->
    <div id="main-dashboard" class="hidden"> <!-- Começa escondido -->
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="text-center sm:text-left">
                        <h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1>
                        <p id="generation-date" class="text-white mt-1">Dados atualizados em: ...</p>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="kpi-card" style="--kpi-border-color: #6366f1;">
                    <h3>Volume Tons</h3>
                    <p id="total-peso">0,0</p>
                </div>
                <div class="kpi-card" style="--kpi-border-color: #14b8a6;">
                    <h3>Faturamento R$</h3>
                    <p id="total-vendas">R$ 0,00</p>
                </div>
                <div class="kpi-card" style="--kpi-border-color: #22c55e;">
                    <h3>SKU/PDV</h3>
                    <p id="kpi-sku-pdv">0,0</p>
                </div>
                <div class="kpi-card" style="--kpi-border-color: #8b5cf6;">
                    <h3>Cobertura PDVs</h3>
                    <p id="kpi-positivacao">0,0%</p>
                    <p id="kpi-positivacao-percent" class="kpi-subtext">0 PDVs</p>
                </div>
            </div>
            
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div id="fornecedor-toggle-container" class="w-full sm:w-auto rounded-lg p-1 flex justify-center sm:justify-start gap-2">
                    <button data-fornecedor="PEPSICO" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">PEPSICO</button>
                    <button data-fornecedor="MULTIMARCAS" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">MULTIMARCAS</button>
                </div>
            </div>
            
            <div id="main-filters" class="mb-8 p-4 bg-content rounded-xl shadow-sm border border-primary">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                    <div id="main-rede-filter-wrapper" class="relative">
                        <label class="block mb-2 text-sm font-medium text-secondary">Rede</label>
                        <div id="main-rede-group-container" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" data-group="" class="group-btn active py-2 px-4 text-sm font-medium border rounded-l-lg">Todos</button>
                            <button type="button" data-group="com_rede" id="main-com-rede-btn" class="group-btn py-2 px-4 text-sm font-medium border-t border-b flex items-center gap-2">
                                <span id="main-com-rede-btn-text">Com Rede</span>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <button type="button" data-group="sem_rede" class="group-btn py-2 px-4 text-sm font-medium border rounded-r-lg">Sem Rede</button>
                        </div>
                        <div id="main-rede-filter-dropdown" class="hidden absolute z-20 w-56 mt-1 top-full left-0 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-left"></div>
                    </div>
                    <div><label class="block mb-2 text-sm font-medium text-secondary">Supervisor</label><select id="supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                    <div class="relative"><label class="block mb-2 text-sm font-medium text-secondary">Vendedor</label><button id="vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="vendedor-filter-text">Todos Vendedores</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                    <div class="relative"><label class="block mb-2 text-sm font-medium text-secondary">Tipo Venda</label><button id="tipo-venda-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="tipo-venda-filter-text">Todos os Tipos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="tipo-venda-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                    <div><label class="block mb-2 text-sm font-medium text-secondary">Fornecedor</label><select id="fornecedor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                    <div><label class="block mb-2 text-sm font-medium text-secondary">Cód. Cliente</label><input type="text" id="codcli-filter" placeholder="Digite o código..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"></div>
                    <div><label class="block mb-2 text-sm font-medium text-secondary">Posição</label><select id="posicao-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todas</option><option value="L">Liberado</option><option value="M">Montado</option><option value="F">Faturado</option></select></div>
                    <div class="md:col-start-6"><button id="clear-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button></div>
                </div>
            </div>
            <main id="app-container">
                <div id="chartView" class="">
                    <div class="mb-6 p-4 rounded-xl border border-primary shadow-sm bg-content">
                        <div class="flex justify-between items-center mb-4">
                            <div class="w-1/3">
                                <label class="block mb-2 text-sm font-medium text-secondary">Feriados do Mês</label>
                                <button id="main-holiday-picker-btn" class="w-full border text-sm rounded-lg p-2.5 text-left focus:outline-none focus:ring-2 focus:ring-teal-500">Selecionar Feriados</button>
                            </div>
                            <div class="w-1/3 text-center">
                                <h2 class="text-lg font-semibold">Tendência de Faturamento</h2>
                            </div>
                            <div class="w-1/3"></div>
                        </div>
                        <div id="trendChartContainer" class="relative h-80"></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 id="sales-by-person-title" class="text-lg font-semibold mb-4 text-center">Vendas por Supervisor</h2><div id="salesByPersonChartContainer" class="relative h-80"></div></div>
                        <div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 id="faturamentoPorFornecedorTitle" class="text-lg font-semibold mb-4 text-center">Faturamento por Categoria</h2><div id="faturamentoPorFornecedorChartContainer" class="relative h-80"></div></div>
                    </div>
                    <div class="mt-6 p-4 rounded-xl border border-primary shadow-sm bg-content">
                        <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold">Vendas por Produto</h2>
                            <div class="rounded-lg p-1 flex">
                                <button id="faturamentoBtn" class="metric-btn active px-3 py-1 text-sm rounded-md">Faturamento</button>
                                <button id="pesoBtn" class="metric-btn px-3 py-1 text-sm rounded-md">Peso Kg</button>
                            </div>
                        </div>
                        <div id="salesByProductBarChartContainer" class="relative h-80"></div>
                    </div>
                </div>
                <div id="tableView" class="hidden">
                    <div class="overflow-x-auto bg-content rounded-xl border border-primary shadow-sm" style="max-height: 60vh;">
                        <table class="min-w-full text-sm text-left">
                            <thead class="text-xs uppercase sticky-header">
                                <tr><th class="px-4 py-3">Nº Pedido</th><th class="px-4 py-3">Cód. Cliente</th><th class="px-4 py-3">Vendedor</th><th class="px-4 py-3">Fornecedor</th><th class="px-4 py-3">Data Pedido</th><th class="px-4 py-3">Data Fat.</th><th class="px-4 py-3 text-right">Peso Total</th><th class="px-4 py-3 text-right">Faturamento Total</th><th class="px-4 py-3 text-center">Posição</th></tr>
                            </thead>
                            <tbody id="report-table-body" class="divide-y divide-border-secondary"></tbody>
                        </table>
                    </div>
                    <div id="table-pagination-controls" class="hidden mt-4 flex justify-between items-center">
                        <button id="prev-page-btn" class="border font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Anterior</button>
                        <span id="page-info-text">Página 1 de 1</span>
                        <button id="next-page-btn" class="border font-bold py-2 px-4 rounded-lg disabled:opacity-50" disabled>Próxima</button>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Ecrã de Cidades -->
    <div id="city-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center"><div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Análise de Vendas por Cidade</p></div><button id="back-to-main-from-city-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button></div>
        </header>
        <div id="city-view-loader" class="text-center p-16"><p class="text-lg">Carregando dados...</p></div>
        <div id="city-view-content" class="hidden">
            <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                    <div id="city-rede-filter-wrapper" class="relative">
                        <label class="block mb-2 text-sm font-medium">Rede</label>
                        <div id="city-rede-group-container" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" data-group="" class="group-btn active py-2 px-4 text-sm font-medium border rounded-l-lg">Todos</button>
                            <div class="relative">
                                <button type="button" data-group="com_rede" id="city-com-rede-btn" class="group-btn py-2 px-4 text-sm font-medium border-t border-b flex items-center justify-center gap-2">
                                    <span id="city-com-rede-btn-text">Com Rede</span>
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="city-rede-filter-dropdown" class="hidden absolute z-20 w-56 mt-1 top-full left-0 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-left"></div>
                            </div>
                            <button type="button" data-group="sem_rede" class="group-btn py-2 px-4 text-sm font-medium border rounded-r-lg">Sem Rede</button>
                        </div>
                    </div>
                    <div><label class="block mb-2 text-sm font-medium">Supervisor</label><select id="city-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                    <div class="relative"><label class="block mb-2 text-sm font-medium">Vendedor</label><button id="city-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="city-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="city-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                    <div class="relative"><label for="city-name-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="city-name-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
                    <div><label for="city-codcli-filter" class="block mb-2 text-sm font-medium">Cód. Cliente</label><input type="text" id="city-codcli-filter" placeholder="Digite o código..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"></div>
                </div>
                <div class="mt-4 flex justify-center">
                    <button id="clear-city-filters-btn" class="font-bold py-2 px-4 rounded-lg">Limpar Filtros</button>
                </div>
            </div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                    <div class="flex justify-between items-center mb-4"><div class="w-1/4"><span class="text-xl font-bold text-indigo-400">Top 10</span></div><div class="w-1/2 text-center"><h2 id="city-chart-title" class="text-lg font-semibold"></h2></div><div class="w-1/4 text-right"><p class="text-sm">Total Vendido</p><p id="total-faturamento-cidade" class="text-xl font-bold text-green-400">R$ 0,00</p></div></div><div id="salesByClientInCityChartContainer" class="relative h-96"></div>
                </div>
                <div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 class="text-lg font-semibold mb-4 text-center">Status dos Clientes</h2><div id="customerStatusChartContainer" class="relative h-96 flex items-center justify-center"></div></div>
            </div>
            <div class="p-4 rounded-xl mt-6 border border-primary shadow-sm bg-content"><div class="flex justify-between items-center mb-4 px-4"><h3 class="text-lg font-semibold">Clientes Ativos no Mês</h3><button id="export-active-pdf-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Exportar Relatório</button></div><div class="overflow-x-auto custom-scrollbar" style="max-height: 40vh;"><table class="min-w-full text-sm text-left"><thead class="text-xs uppercase sticky-header"><tr><th class="px-4 py-3">Código</th><th class="px-4 py-3">Nome Fantasia</th><th class="px-4 py-3 text-right">Faturamento</th><th class="px-4 py-3">Cidade</th><th class="px-4 py-3">Bairro</th><th class="px-4 py-3">RCA</th></tr></thead><tbody id="city-active-detail-table-body" class="divide-y divide-border-secondary"></tbody></table></div></div>
            <div class="p-4 rounded-xl mt-6 border border-primary shadow-sm bg-content"><div class="flex justify-between items-center mb-4 px-4"><h3 class="text-lg font-semibold">Clientes S/ Vendas no Mês</h3><button id="export-inactive-pdf-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg text-sm">Exportar Relatório</button></div><div class="overflow-x-auto custom-scrollbar" style="max-height: 40vh;"><table class="min-w-full text-sm text-left"><thead class="text-xs uppercase sticky-header"><tr><th class="px-4 py-3">Código</th><th class="px-4 py-3">Nome Fantasia</th><th class="px-4 py-3">Cidade</th><th class="px-4 py-3">Bairro</th><th class="px-4 py-3 text-center">Última Compra</th><th class="px-4 py-3">RCA</th></tr></thead><tbody id="city-inactive-detail-table-body" class="divide-y divide-border-secondary"></tbody></table></div></div>
        </div>
    </div>
    
    <!-- Ecrã Semanal -->
    <div id="weekly-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center"><div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Acompanhamento Semanal</p></div><button id="back-to-main-from-weekly-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button></div>
        </header>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div id="weekly-fornecedor-toggle-container" class="w-full sm:w-auto rounded-lg p-1 flex justify-center sm:justify-start gap-2"><button data-fornecedor="PEPSICO" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">PEPSICO</button><button data-fornecedor="MULTIMARCAS" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">MULTIMARCAS</button></div>
                <button id="clear-weekly-filters-btn" class="font-bold py-2 px-4 rounded-lg">Limpar Filtros</button>
            </div>
            <div class="mt-4"><label class="block text-sm font-medium mb-2">Filtrar Supervisores</label><div id="weekly-supervisor-filter" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
        </div>
        <div class="grid grid-cols-1 gap-6">
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold text-center">Faturamento Mensal por Dia da Semana</h2><div class="text-right"><p class="text-sm">Total do Mês</p><p id="total-mes-semanal" class="text-xl font-bold text-green-400">R$ 0,00</p></div></div><div id="weeklySalesChartContainer" class="relative h-96"></div>
                <div class="mt-6 border-t border-primary pt-4"><h3 class="text-md font-semibold mb-3 text-center">Resumo de Faturamento Semanal</h3><div class="overflow-x-auto"><table class="min-w-full text-sm text-left"><thead class="text-xs uppercase"><tr><th class="px-4 py-2 rounded-l-lg">Semana</th><th class="px-4 py-2 text-right rounded-r-lg">Faturamento Total</th></tr></thead><tbody id="weekly-summary-table-body" class="divide-y divide-border-secondary"></tbody></table></div></div>
            </div>
            <div class="grid grid-cols-1 gap-6"><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 class="text-lg font-semibold mb-4 text-center">Ranking de Positivação</h2><div id="positivacaoChartContainer" class="relative h-80"></div></div><div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 class="text-lg font-semibold mb-4 text-center">Ranking de Mix de Produtos (Por PDV)</h2><div id="mixChartContainer" class="relative h-80"></div></div></div><div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 class="text-lg font-semibold mb-4 text-center">Top 10 Vendedores (Faturamento)</h2><div id="topSellersChartContainer" class="relative h-80"></div></div></div>
        </div>
    </div>
    
    <!-- Ecrã Comparativo -->
    <div id="comparison-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center"><div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Comparativo entre Meses</p></div><button id="back-to-main-from-comparison-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button></div>
        </header>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div id="comparison-rede-filter-wrapper" class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                <div class="relative w-full sm:w-1/2">
                    <label class="block mb-2 text-sm font-medium">Rede</label>
                    <div id="comparison-rede-group-container" class="inline-flex rounded-md shadow-sm w-full" role="group">
                        <button type="button" data-group="" class="group-btn active py-2 px-4 text-sm font-medium border rounded-l-lg flex-1">Todos</button>
                        <button type="button" data-group="com_rede" id="comparison-com-rede-btn" class="group-btn py-2 px-4 text-sm font-medium border-t border-b flex items-center justify-center gap-2 flex-1">
                            <span id="comparison-com-rede-btn-text">Com Rede</span>
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <button type="button" data-group="sem_rede" class="group-btn py-2 px-4 text-sm font-medium border rounded-r-lg flex-1">Sem Rede</button>
                    </div>
                    <div id="comparison-rede-filter-dropdown" class="hidden absolute z-20 w-full mt-1 top-full left-0 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-left"></div>
                </div>
                <div class="w-full sm:w-1/2">
                    <label class="block mb-2 text-sm font-medium">Pasta</label>
                    <div id="comparison-fornecedor-toggle-container" class="w-full rounded-lg p-1 flex justify-center gap-2">
                        <button data-fornecedor="PEPSICO" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1">PEPSICO</button>
                        <button data-fornecedor="MULTIMARCAS" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1">MULTIMARCAS</button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div><label for="comparison-supervisor-filter" class="block mb-2 text-sm font-medium">Supervisor</label><select id="comparison-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                <div class="relative"><label class="block mb-2 text-sm font-medium">Vendedor</label><button id="comparison-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="comparison-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="comparison-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label class="block mb-2 text-sm font-medium">Fornecedor</label><button id="comparison-supplier-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="comparison-supplier-filter-text">Todos Fornecedores</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="comparison-supplier-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="comparison-city-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="comparison-city-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="comparison-city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
            </div>
            <div class="grid grid-cols-1 mt-4">
                <div class="relative">
                    <label class="block mb-2 text-sm font-medium">Filtrar por Produto</label>
                    <button id="comparison-product-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="comparison-product-filter-text">Todos os Produtos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="comparison-product-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg">
                        <div class="p-2 border-b border-primary"><input type="text" id="comparison-product-search-input" placeholder="Buscar produto..." class="bg-input text-xs rounded-lg block w-full p-2 border border-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-teal-500"></div>
                        <div id="comparison-product-list" class="max-h-60 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end border-t border-primary pt-4 mt-4">
                <div><label class="block mb-2 text-sm font-medium">Filial</label><select id="comparison-filial-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="ambas" selected>Ambas</option><option value="05">Filial 05</option><option value="08">Filial 08</option></select></div>
                <div class="flex items-end"><div class="w-full"><label class="block mb-2 text-sm font-medium">Feriados do Mês</label><button id="comparison-holiday-picker-btn" class="w-full border text-sm rounded-lg p-2.5 text-left focus:outline-none focus:ring-2 focus:ring-teal-500">Selecionar Feriados</button></div></div>
                <button id="comparison-tendency-toggle" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-4 rounded-lg">Calcular Tendência</button>
                <button id="clear-comparison-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button>
            </div>
        </div>
        <div id="comparison-kpi-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6 mb-6">
        </div>
        <div class="grid grid-cols-1 gap-6">
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <div class="flex justify-center items-center mb-4 relative">
                    <h2 id="comparison-chart-title" class="text-lg font-semibold text-center">Comparativo de Faturamento Semanal</h2>
                    <div class="absolute right-0 top-0 bottom-0 flex items-center">
                        <div id="comparison-chart-toggle" class="flex rounded-lg p-1">
                            <button id="toggle-weekly-btn" class="comparison-toggle-btn active px-3 py-1 text-sm rounded-md">Semanal</button>
                            <button id="toggle-monthly-btn" class="comparison-toggle-btn px-3 py-1 text-sm rounded-md">Mensal</button>
                        </div>
                    </div>
                </div>
                <div id="weeklyComparisonChartContainer" class="relative h-96"></div>
                <div id="monthlyComparisonChartContainer" class="relative h-96 hidden"></div>
            </div>
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <h2 class="text-lg font-semibold text-center mb-4">Faturamento por Dia da Semana</h2>
                <div id="dailyWeeklyComparisonChartContainer" class="relative h-96"></div>
            </div>
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content"><h2 class="text-lg font-semibold text-center mb-4">Variação de Faturamento por Supervisor</h2><div class="overflow-x-auto custom-scrollbar" style="max-height: 40vh;"><table class="min-w-full text-sm text-left"><thead class="text-xs uppercase sticky-header"><tr><th class="px-4 py-3">Supervisor</th><th class="px-4 py-3 text-right">Média Trim.</th><th class="px-4 py-3 text-right">Fat. Mês Atual</th><th class="px-4 py-3 text-right">Variação</th></tr></thead><tbody id="supervisorComparisonTableBody" class="divide-y divide-border-secondary"></tbody></table></div></div>
        </div>
    </div>
    
    <!-- Ecrã Estoque -->
    <div id="stock-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center"><div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Análise de Estoque</p></div><button id="back-to-main-from-stock-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button></div>
        </header>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div id="stock-rede-filter-wrapper" class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-4">
                <div class="relative w-full sm:w-1/2">
                    <label class="block mb-2 text-sm font-medium">Rede</label>
                    <div id="stock-rede-group-container" class="inline-flex rounded-md shadow-sm w-full" role="group">
                        <button type="button" data-group="" class="group-btn active py-2 px-4 text-sm font-medium border rounded-l-lg flex-1">Todos</button>
                        <button type="button" data-group="com_rede" id="stock-com-rede-btn" class="group-btn py-2 px-4 text-sm font-medium border-t border-b flex items-center justify-center gap-2 flex-1">
                            <span id="stock-com-rede-btn-text">Com Rede</span>
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <button type="button" data-group="sem_rede" class="group-btn py-2 px-4 text-sm font-medium border rounded-r-lg flex-1">Sem Rede</button>
                    </div>
                    <div id="stock-rede-filter-dropdown" class="hidden absolute z-20 w-full mt-1 top-full left-0 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-left"></div>
                </div>
                <div class="w-full sm:w-1/2">
                    <label class="block mb-2 text-sm font-medium">Pasta</label>
                    <div id="stock-fornecedor-toggle-container" class="w-full rounded-lg p-1 flex justify-center gap-2">
                        <button data-fornecedor="PEPSICO" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1">PEPSICO</button>
                        <button data-fornecedor="MULTIMARCAS" class="fornecedor-btn font-bold py-2 px-4 rounded-lg flex-1">MULTIMARCAS</button>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div><label for="stock-supervisor-filter" class="block mb-2 text-sm font-medium">Supervisor</label><select id="stock-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                <div class="relative"><label class="block mb-2 text-sm font-medium">Vendedor</label><button id="stock-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="stock-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="stock-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label class="block mb-2 text-sm font-medium">Fornecedor</label><button id="stock-supplier-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="stock-supplier-filter-text">Todos Fornecedores</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="stock-supplier-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="stock-city-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="stock-city-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="stock-city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="lg:col-span-2 relative">
                    <label class="block mb-2 text-sm font-medium">Produto</label>
                    <button id="stock-product-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="stock-product-filter-text">Todos os Produtos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="stock-product-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg">
                        <div class="p-2 border-b border-primary"><input type="text" id="stock-product-search-input" placeholder="Buscar produto..." class="bg-input text-xs rounded-lg block w-full p-2 border border-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-teal-500"></div>
                        <div id="stock-product-list" class="max-h-60 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
                <div><label class="block mb-2 text-sm font-medium">Filial</label><select id="stock-filial-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="ambas" selected>Ambas</option><option value="05">Filial 05</option><option value="08">Filial 08</option></select></div>
                <button id="clear-stock-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button>
            </div>
        </div>
         <div class="p-4 rounded-xl mb-6 border border-primary shadow-sm bg-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">Análise de Estoque e Tendência de Saída</h2>
                <div class="flex items-end gap-4">
                    <div>
                        <label for="stock-working-days-input" class="block text-xs font-medium mb-1 text-center">Dias Úteis</label>
                        <div class="flex items-center justify-center gap-1">
                            <input type="number" id="stock-working-days-input" value="0" min="1" class="border text-sm rounded-lg block w-20 p-1.5 text-center focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <span id="max-working-days-label" class="text-xs whitespace-nowrap">(Máx: 0)</span>
                        </div>
                    </div>
                    <div id="stock-trend-filter-container" class="flex items-center gap-2">
                        <button data-trend="all" class="stock-trend-btn active p-1 rounded-full transition-transform duration-200"><div class="w-5 h-5 rounded-full bg-gray-400"></div></button>
                        <button data-trend="low" class="stock-trend-btn p-1 rounded-full transition-transform duration-200"><div class="w-5 h-5 rounded-full bg-red-500"></div></button>
                        <button data-trend="medium" class="stock-trend-btn p-1 rounded-full transition-transform duration-200"><div class="w-5 h-5 rounded-full bg-yellow-500"></div></button>
                        <button data-trend="good" class="stock-trend-btn p-1 rounded-full transition-transform duration-200"><div class="w-5 h-5 rounded-full bg-green-500"></div></button>
                    </div>
                </div>
            </div>
            <div class="overflow-auto custom-scrollbar" style="max-height: 60vh;">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase sticky-header">
                        <tr>
                            <th class="px-4 py-3">Produto</th>
                            <th class="px-4 py-3">Fornecedor</th>
                            <th class="px-4 py-3 text-right">Estoque Atual (CX.)</th>
                            <th class="px-4 py-3 text-right">Venda Média Mensal (CX.)</th>
                            <th class="px-4 py-3 text-right">Média diária (CX.)</th>
                            <th class="px-4 py-3 text-right">Tendência (Dias)</th>
                        </tr>
                    </thead>
                    <tbody id="stock-analysis-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <h2 class="text-lg font-semibold text-center mb-4">Produtos com Crescimento</h2>
                <div class="overflow-auto custom-scrollbar" style="max-height: 40vh;">
                    <table class="min-w-full text-sm"><thead class="text-xs uppercase sticky-header"><tr><th class="px-2 py-2 text-left">Produto</th><th class="px-2 py-2 text-right">Vendido (Atual)</th><th class="px-2 py-2 text-right">Média Trim.</th><th class="px-2 py-2 text-right">Variação</th><th class="px-2 py-2 text-right">Estoque</th></tr></thead><tbody id="growth-table-body" class="divide-y divide-border-secondary"></tbody></table>
                </div>
            </div>
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <h2 class="text-lg font-semibold text-center mb-4">Produtos com Queda</h2>
                <div class="overflow-auto custom-scrollbar" style="max-height: 40vh;">
                    <table class="min-w-full text-sm"><thead class="text-xs uppercase sticky-header"><tr><th class="px-2 py-2 text-left">Produto</th><th class="px-2 py-2 text-right">Vendido (Atual)</th><th class="px-2 py-2 text-right">Média Trim.</th><th class="px-2 py-2 text-right">Variação</th><th class="px-2 py-2 text-right">Estoque</th></tr></thead><tbody id="decline-table-body" class="divide-y divide-border-secondary"></tbody></table>
                </div>
            </div>
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <h2 class="text-lg font-semibold text-center mb-4">Novos - Vendidos este Mês</h2>
                <div class="overflow-auto custom-scrollbar" style="max-height: 40vh;">
                    <table class="min-w-full text-sm"><thead class="text-xs uppercase sticky-header"><tr><th class="px-2 py-2 text-left">Produto</th><th class="px-2 py-2 text-right">Vendido (Atual)</th><th class="px-2 py-2 text-right">Média Trim.</th><th class="px-2 py-2 text-right">Estoque</th></tr></thead><tbody id="new-products-table-body" class="divide-y divide-border-secondary"></tbody></table>
                </div>
            </div>
            <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
                <h2 class="text-lg font-semibold text-center mb-4">Perdidos - Não vendidos este Mês</h2>
                <div class="overflow-auto custom-scrollbar" style="max-height: 40vh;">
                    <table class="min-w-full text-sm"><thead class="text-xs uppercase sticky-header"><tr><th class="px-2 py-2 text-left">Produto</th><th class="px-2 py-2 text-right">Vendido (Atual)</th><th class="px-2 py-2 text-right">Média Trim.</th><th class="px-2 py-2 text-right">Estoque</th></tr></thead><tbody id="lost-products-table-body" class="divide-y divide-border-secondary"></tbody></table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 
      *********************************************************************
      * INÍCIO DA CORREÇÃO: ADICIONANDO OS ECRÃS E MODAIS EM FALTA
      *********************************************************************
    -->

    <!-- Ecrã Inovações (EM FALTA) -->
    <div id="innovations-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center">
                <div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Análise de Inovações</p></div>
                <div class="flex gap-4">
                    <button id="innovations-month-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">Inovações Mês</button>
                    <button id="back-to-main-from-innovations-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button>
                </div>
            </div>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-6">
            <div class="kpi-card" style="--kpi-border-color: #14b8a6;">
                <h3>Clientes Ativos (Filtro)</h3>
                <p id="innovations-active-clients-kpi">0</p>
                <p class="kpi-subtext">Base para os KPIs</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #f97316;">
                <h3>Cobertura Mês Anterior</h3>
                <p id="innovations-selection-coverage-value-kpi-previous">0%</p>
                <p id="innovations-selection-coverage-count-kpi-previous" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #06b6d4;">
                <h3>Cobertura Mês Atual</h3>
                <p id="innovations-selection-coverage-value-kpi">0%</p>
                <p id="innovations-selection-coverage-count-kpi" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #f97316;">
                <h3>Cobertura Bonificação Ant.</h3>
                <p id="innovations-bonus-coverage-value-kpi-previous">0%</p>
                <p id="innovations-bonus-coverage-count-kpi-previous" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #06b6d4;">
                <h3>Cobertura Bonificação Atual</h3>
                <p id="innovations-bonus-coverage-value-kpi">0%</p>
                <p id="innovations-bonus-coverage-count-kpi" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #8b5cf6;">
                <h3 id="innovations-top-coverage-title">Item com Maior Cobertura</h3>
                <p id="innovations-top-coverage-value-kpi">0%</p>
                <p id="innovations-top-coverage-product-kpi" class="kpi-subtext truncate" title="Nenhum item analisado">-</p>
                <p id="innovations-top-coverage-count-kpi" class="kpi-subtext">0 PDVs</p>
            </div>
        </div>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                <div><label for="innovations-supervisor-filter" class="block mb-2 text-sm font-medium">Supervisor</label><select id="innovations-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                <div class="relative"><label for="innovations-vendedor-filter-btn" class="block mb-2 text-sm font-medium">Vendedor</label><button id="innovations-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="innovations-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="innovations-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="innovations-supplier-filter-btn" class="block mb-2 text-sm font-medium">Fornecedor</label><button id="innovations-supplier-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="innovations-supplier-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="innovations-supplier-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="innovations-city-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="innovations-city-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="innovations-city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
                <div><label for="innovations-filial-filter" class="block mb-2 text-sm font-medium">Filial</label><select id="innovations-filial-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="ambas" selected>Ambas</option><option value="05">Filial 05</option><option value="08">Filial 08</option></select></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="lg:col-span-2 relative">
                    <label for="innovations-product-filter-btn" class="block mb-2 text-sm font-medium">Produto (Obrigatório)</label>
                    <button id="innovations-product-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="innovations-product-filter-text">Selecione um ou mais produtos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="innovations-product-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg">
                        <div class="p-2 border-b border-primary"><input type="text" id="innovations-product-search-input" placeholder="Buscar produto..." class="bg-input text-xs rounded-lg block w-full p-2 border border-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-teal-500"></div>
                        <div id="innovations-product-list" class="max-h-60 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
                <div class="flex items-center justify-start h-full pb-1"><div class="flex items-center"><input id="innovations-include-bonus" type="checkbox" checked class="w-4 h-4 text-teal-500 rounded focus:ring-teal-500"><label for="innovations-include-bonus" class="ml-2 text-sm font-medium">Incluir Bonificações</label></div></div>
                <button id="clear-innovations-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button>
            </div>
        </div>
        <div id="innovations-table-container" class="bg-content p-4 rounded-xl border border-primary shadow-sm">
            <div id="innovations-placeholder" class="text-center py-16"><p class="text-lg">Aguardando filtro de produtos...</p></div>
            <div id="innovations-results" class="hidden overflow-auto custom-scrollbar" style="max-height: 60vh;">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase sticky-header">
                        <tr><th class="px-2 py-2">PRODUTO</th><th class="px-2 py-2 text-right">ESTOQUE CAIXAS</th><th class="px-2 py-2 text-right">COBERTURA MÊS ANT.</th><th class="px-2 py-2 text-right">COBERTURA MÊS ATUAL</th><th class="px-2 py-2 text-right">VARIAÇÃO</th></tr>
                    </thead>
                    <tbody id="innovations-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ecrã Inovações Mês (EM FALTA) -->
    <div id="innovations-month-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
         <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center">
                <div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Gráfico de Cobertura por Categoria de Inovação</p></div>
                <div class="flex gap-4">
                    <button id="export-innovations-month-pdf-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Exportar PDF</button>
                    <button id="back-to-innovations-from-month-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar</button>
                </div>
            </div>
        </header>
         <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-6">
            <div class="kpi-card" style="--kpi-border-color: #14b8a6;"><h3>Clientes Ativos (Filtro)</h3><p id="innovations-month-active-clients-kpi">0</p><p class="kpi-subtext">Base para os KPIs</p></div>
            <div class="kpi-card" style="--kpi-border-color: #f97316;"><h3>Cobertura Mês Anterior</h3><p id="innovations-month-selection-coverage-value-kpi-previous">0%</p><p id="innovations-month-selection-coverage-count-kpi-previous" class="kpi-subtext">0 de 0 clientes</p></div>
            <div class="kpi-card" style="--kpi-border-color: #06b6d4;"><h3>Cobertura Mês Atual</h3><p id="innovations-month-selection-coverage-value-kpi">0%</p><p id="innovations-month-selection-coverage-count-kpi" class="kpi-subtext">0 de 0 clientes</p></div>
            <div class="kpi-card" style="--kpi-border-color: #f97316;"><h3>Cobertura Bonificação Ant.</h3><p id="innovations-month-bonus-coverage-value-kpi-previous">0%</p><p id="innovations-month-bonus-coverage-count-kpi-previous" class="kpi-subtext">0 de 0 clientes</p></div>
            <div class="kpi-card" style="--kpi-border-color: #06b6d4;"><h3>Cobertura Bonificação Atual</h3><p id="innovations-month-bonus-coverage-value-kpi">0%</p><p id="innovations-month-bonus-coverage-count-kpi" class="kpi-subtext">0 de 0 clientes</p></div>
            <div class="kpi-card" style="--kpi-border-color: #8b5cf6;"><h3 id="innovations-month-top-coverage-title">Item com Maior Cobertura</h3><p id="innovations-month-top-coverage-value-kpi">0%</p><p id="innovations-month-top-coverage-kpi" class="kpi-subtext truncate" title="Nenhum item analisado">-</p><p id="innovations-month-top-coverage-count-kpi" class="kpi-subtext">0 PDVs</p></div>
        </div>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                <div><label for="innovations-month-supervisor-filter" class="block mb-2 text-sm font-medium">Supervisor</label><select id="innovations-month-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                <div class="relative"><label for="innovations-month-vendedor-filter-btn" class="block mb-2 text-sm font-medium">Vendedor</label><button id="innovations-month-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="innovations-month-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="innovations-month-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="innovations-month-city-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="innovations-month-city-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="innovations-month-city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
                <div><label for="innovations-month-filial-filter" class="block mb-2 text-sm font-medium">Filial</label><select id="innovations-month-filial-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="ambas" selected>Ambas</option><option value="05">Filial 05</option><option value="08">Filial 08</option></select></div>
                <div class="flex items-center justify-start h-full pb-1"><div class="flex items-center"><input id="innovations-month-include-bonus" type="checkbox" checked class="w-4 h-4 text-teal-500 rounded focus:ring-teal-500"><label for="innovations-month-include-bonus" class="ml-2 text-sm font-medium">Incluir Bonificações</label></div></div>
                <button id="clear-innovations-month-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button>
            </div>
            <div class="mt-4 border-t border-primary pt-4">
                <label for="innovations-month-category-filter" class="block mb-2 text-sm font-medium">Filtrar por Categoria de Inovação</label>
                <select id="innovations-month-category-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todas as Categorias</option></select>
            </div>
        </div>
        <div class="p-4 rounded-xl border border-primary shadow-sm bg-content mb-6">
            <div id="innovations-month-chartContainer" class="relative h-96"></div>
        </div>
        <div class="p-4 rounded-xl border border-primary shadow-sm bg-content mb-6">
            <h2 class="text-lg font-semibold mb-4 text-center">Dados do Gráfico</h2>
            <div class="overflow-auto custom-scrollbar" style="max-height: 60vh;">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase sticky-header"><tr><th class="px-2 py-2">CATEGORIA</th><th class="px-2 py-2">PRODUTO</th><th class="px-2 py-2 text-right">ESTOQUE CAIXAS</th><th class="px-2 py-2 text-right">COBERTURA MÊS ANT.</th><th class="px-2 py-2 text-right">COBERTURA MÊS ATUAL</th><th class="px-2 py-2 text-right">VARIAÇÃO</th></tr></thead>
                    <tbody id="innovations-month-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
        </div>
        <div class="p-4 rounded-xl border border-primary shadow-sm bg-content">
            <h2 class="text-lg font-semibold mb-2 text-center">Inovações por cliente</h2>
            <div id="innovations-by-client-legend" class="text-xs mb-4 p-2 bg-content rounded"></div>
            <div class="overflow-auto custom-scrollbar" style="max-height: 60vh;">
                <table class="min-w-full text-sm text-left">
                    <thead id="innovations-by-client-table-head" class="text-xs uppercase sticky-header"></thead>
                    <tbody id="innovations-by-client-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ecrã Cobertura (EM FALTA) -->
    <div id="coverage-view" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8 p-6 header-gradient rounded-b-lg shadow-lg">
            <div class="flex justify-between items-center">
                <div><h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span style="color: var(--header-span-text);">PRIME</span> DISTRIBUIÇÃO</h1><p class="text-lg text-white -mt-1">Análise de Cobertura (Estoque x PDVs)</p></div>
                <button id="back-to-main-from-coverage-btn" class="bg-white/20 hover:bg-white/30 text-white font-bold py-2 px-4 rounded-lg">Voltar ao Dashboard</button>
            </div>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="kpi-card" style="--kpi-border-color: #14b8a6;">
                <h3>Clientes Ativos (Filtro)</h3>
                <p id="coverage-active-clients-kpi">0</p>
                <p class="kpi-subtext">Base para os KPIs</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #f97316;">
                <h3>Cobertura Mês Anterior</h3>
                <p id="coverage-selection-coverage-value-kpi-previous">0%</p>
                <p id="coverage-selection-coverage-count-kpi-previous" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #06b6d4;">
                <h3>Cobertura Mês Atual</h3>
                <p id="coverage-selection-coverage-value-kpi">0%</p>
                <p id="coverage-selection-coverage-count-kpi" class="kpi-subtext">0 de 0 clientes</p>
            </div>
            <div class="kpi-card" style="--kpi-border-color: #8b5cf6;">
                <h3>Item com Maior Cobertura</h3>
                <p id="coverage-top-coverage-value-kpi">0%</p>
                <p id="coverage-top-coverage-product-kpi" class="kpi-subtext truncate" title="Nenhum item analisado">-</p>
            </div>
        </div>
        <div class="mb-6 p-4 bg-content rounded-xl shadow-sm border border-primary">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                <div><label for="coverage-supervisor-filter" class="block mb-2 text-sm font-medium">Supervisor</label><select id="coverage-supervisor-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                <div class="relative"><label for="coverage-vendedor-filter-btn" class="block mb-2 text-sm font-medium">Vendedor</label><button id="coverage-vendedor-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="coverage-vendedor-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="coverage-vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="coverage-supplier-filter-btn" class="block mb-2 text-sm font-medium">Fornecedor</LabeL><button id="coverage-supplier-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="coverage-supplier-filter-text">Todos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="coverage-supplier-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar"></div></div>
                <div class="relative"><label for="coverage-city-filter" class="block mb-2 text-sm font-medium">Cidade</label><input type="text" id="coverage-city-filter" placeholder="Digite a cidade..." class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5" autocomplete="off"><div id="coverage-city-suggestions" class="absolute z-10 w-full bg-modal-content border border-primary rounded-lg mt-1 hidden max-h-48 overflow-y-auto custom-scrollbar"></div></div>
                <div><label for="coverage-filial-filter" class="block mb-2 text-sm font-medium">Filial</label><select id="coverage-filial-filter" class="text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="ambas" selected>Ambas</option><option value="05">Filial 05</option><option value="08">Filial 08</option></select></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div class="lg:col-span-2 relative">
                    <label for="coverage-product-filter-btn" class="block mb-2 text-sm font-medium">Produto</label>
                    <button id="coverage-product-filter-btn" class="w-full border text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="coverage-product-filter-text">Todos os Produtos</span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="coverage-product-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-modal-content border border-primary rounded-lg shadow-lg">
                        <div class="p-2 border-b border-primary"><input type="text" id="coverage-product-search-input" placeholder="Buscar produto..." class="bg-input text-xs rounded-lg block w-full p-2 border border-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-teal-500"></div>
                        <div id="coverage-product-list" class="max-h-60 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>
                <div class="flex items-center justify-start h-full pb-1"><div class="flex items-center"><input id="coverage-include-bonus" type="checkbox" checked class="w-4 h-4 text-teal-500 rounded focus:ring-teal-500"><label for="coverage-include-bonus" class="ml-2 text-sm font-medium">Incluir Bonificações</label></div></div>
                <button id="clear-coverage-filters-btn" class="w-full font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button>
            </div>
        </div>
        <div id="coverage-table-container" class="bg-content p-4 rounded-xl border border-primary shadow-sm">
            <div id="coverage-results" class="overflow-auto custom-scrollbar" style="max-height: 60vh;">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase sticky-header">
                        <tr><th class="px-2 py-2">PRODUTO</th><th class="px-2 py-2 text-right">ESTOQUE (Cx)</th><th class="px-2 py-2 text-right">COB. ESTOQUE (Dias)</th><th class="px-2 py-2 text-right">PDVs MÊS ANT.</th><th class="px-2 py-2 text-right">PDVs MÊS ATUAL</th><th class="px-2 py-2 text-right">COB. PDVs (%)</th></tr>
                    </thead>
                    <tbody id="coverage-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes do Pedido (EM FALTA) -->
    <div id="order-details-modal" class="modal-overlay hidden">
        <div class="bg-modal-content rounded-lg shadow-2xl max-w-4xl w-full m-4 border border-primary">
            <div class="p-6 border-b border-primary flex justify-between items-center"><h2 class="text-xl font-bold">Detalhes do Pedido <span id="modal-pedido-id"></span></h2><button id="modal-close-btn" class="text-3xl">&times;</button></div>
            <div id="modal-header-info" class="p-6 text-left grid grid-cols-2 md:grid-cols-3 gap-4 text-sm"></div>
            <div class="custom-scrollbar" style="max-height: 50vh; overflow-y: auto;">
                <table class="min-w-full text-sm text-left">
                    <thead class="text-xs uppercase sticky-header"><tr><th class="px-4 py-3">Produto</th><th class="px-4 py-3 text-right">Quantidade</th><th class="px-4 py-3 text-right">Peso (Kg)</th><th class="px-4 py-3 text-right">Valor Unitário</th></tr></thead>
                    <tbody id="modal-table-body" class="divide-y divide-border-secondary"></tbody>
                </table>
            </div>
            <div id="modal-footer-total" class="p-6 border-t border-primary flex justify-between items-center"></div>
        </div>
    </div>
    
    <!-- Modal Detalhes do Cliente (EM FALTA) -->
    <div id="client-details-modal" class="modal-overlay hidden">
        <div class="bg-modal-content rounded-lg shadow-2xl max-w-2xl w-full m-4 border border-primary">
            <div class="p-6 border-b border-primary flex justify-between items-center"><h2 class="text-xl font-bold">Resumo Cadastral</h2><button id="client-modal-close-btn" class="text-3xl">&times;</button></div>
            <div id="client-modal-content" class="p-6"></div>
        </div>
    </div>
    
    <!-- Modal Feriados (EM FALTA) -->
    <div id="holiday-modal" class="modal-overlay hidden">
        <div class="bg-modal-content rounded-lg shadow-2xl max-w-xs w-full m-4 border border-primary">
            <div class="p-4 border-b border-primary flex justify-between items-center">
                <h2 class="text-lg font-bold">Selecionar Feriados</h2>
                <button id="holiday-modal-close-btn" class="text-3xl">&times;</button>
            </div>
            <div class="p-4">
                <div id="calendar-container"></div>
            </div>
            <div class="p-4 border-t border-primary text-right">
                <button id="holiday-modal-done-btn" class="bg-teal-500 hover:bg-teal-400 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- 
      *********************************************************************
      * FIM DA CORREÇÃO
      *********************************************************************
    -->

    <!-- Admin Uploader Modal -->
    <div id="admin-uploader-modal" class="modal-overlay hidden">
        <div class="bg-modal-content rounded-lg shadow-2xl max-w-lg w-full m-4 border border-primary relative text-center p-8">
            <button id="admin-modal-close-btn" class="absolute top-2 right-4 text-3xl font-bold hover:text-red-500 transition-colors">&times;</button>

            <h1 class="text-2xl font-bold mb-4">Uploader (v5.1 - Parcial)</h1>
            <p class="mb-6">Carregue os arquivos para enviar os dados ao Supabase. Você pode carregar um ou mais arquivos de cada vez.</p>

            <div class="space-y-4 mb-6 text-left">
                <div>
                    <label for="supabase-url" class="block text-sm font-medium mb-2">URL do Projeto Supabase</label>
                    <input type="text" id="supabase-url" placeholder="https://[seu-id].supabase.co" class="w-full text-sm p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-input border-primary text-primary" value="https://dhozwhfmrwiumwpcqabi.supabase.co">
                </div>
                <div>
                    <label for="supabase-key" class="block text-sm font-medium mb-2">Chave Secreta (service_role) 🤫</label>
                    <input type="password" id="supabase-key" placeholder="Cole sua chave secreta aqui..." class="w-full text-sm p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-input border-primary text-primary">
                    <p class="text-xs mt-1">Esta chave NUNCA é salva. Você deve digitá-la toda vez que for usar.</p>
                </div>
            </div>

            <div class="space-y-4 mb-6 border-t border-primary pt-6 text-left">
                <div>
                    <label for="sales-file-input" class="block text-sm font-medium mb-2">1. Arquivo de Vendas (Mês Atual)</label>
                    <input type="file" id="sales-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="clients-file-input" class="block text-sm font-medium mb-2">2. Cadastro de Clientes</label>
                    <input type="file" id="clients-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="products-file-input" class="block text-sm font-medium mb-2">3. Cadastro de Produtos</label>
                    <input type="file" id="products-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                <div>
                    <label for="history-file-input" class="block text-sm font-medium mb-2">4. Histórico de Vendas (Trimestre Anterior)</label>
                    <input type="file" id="history-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
                 <div>
                    <label for="innovations-file-input" class="block text-sm font-medium mb-2">5. Planilha de Inovações (Mês)</label>
                    <input type="file" id="innovations-file-input" class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-button file:text-secondary hover:file:bg-button-hover" accept=".csv, .xls, .xlsx"/>
                </div>
            </div>

            <button id="generate-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg w-full disabled:bg-slate-500 disabled:hover:bg-slate-500 disabled:cursor-not-allowed">
                Enviar Dados para o Supabase
            </button>

            <div id="status-container" class="hidden mt-6 text-sm h-12 flex flex-col justify-center">
                <p id="status-text" class="mb-2"></p>
                <div class="w-full h-2 rounded-lg overflow-hidden bg-slate-700">
                    <div id="progress-bar" class="bg-teal-500 h-full transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. MODIFICADO: Script agora busca dados das 8 tabelas -->
    <script>
        // !! AÇÃO NECESSÁRIA !!
        // Cole sua URL e Chave PÚBLICA (anon) aqui
        const SUPABASE_URL = 'https://dhozwhfmrwiumwpcqabi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRob3p3aGZtcndpdW13cGNxYWJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjMzNjAsImV4cCI6MjA3NzgzOTM2MH0.syWqcBCbfH5Ey5AB4NGrsF2-ZuBw4W3NZAPIAZb6Bq4';
        
        // 8. MODIFICADO: Nova função para carregar dados das 8 tabelas
        async function carregarDadosDoSupabase() {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const mainDashboard = document.getElementById('main-dashboard');
            
            try {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('COLE_A_URL')) {
                    loaderText.innerHTML = '<span class="text-red-400">Erro: SUPABASE_URL ou SUPABASE_ANON_KEY não configuradas no index.html.</span>';
                    return;
                }
                
                const { createClient } = supabase;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                const fetchColumnarData = async (tableName, columns = '*') => {
                    const { data, error } = await supabaseClient.from(tableName).select(columns);
                    if (error) {
                        console.error(`Erro ao buscar dados da tabela '${tableName}':`, error);
                        return [];
                    }
                    return data || [];
                };

                loaderText.textContent = 'Buscando dados...';
                // CORREÇÃO: Coluna 'qtvenda_embalagem_master' alterada para minúsculas
                const detailedColumns = 'dtped,codcli,vlvenda,totpesoliq,nome,superv,descricao,produto,fornecedor,codfor,observacaofor,posicao,tipovenda,codusur,filial,bairro,cidade,vlbonific,qtvenda_embalagem_master,pedido,dtsaida,cliente_nome,qtvenda';
                // CORREÇÃO: Coluna 'qtvenda_embalagem_master' alterada para minúsculas
                const historyColumns = 'superv,dtped,vlvenda,codcli,filial,nome,codfor,produto,observacaofor,cidade,codusur,tipovenda,qtvenda_embalagem_master,vlbonific,fornecedor,totpesoliq,descricao,qtvenda';

                const fetchHistoryInChunks = async () => {
                    let allHistory = [];
                    let offset = 0;
                    const chunkSize = 25000;
                    while (true) {
                        const { data, error } = await supabaseClient
                            .from('data_history')
                            .select(historyColumns)
                            .range(offset, offset + chunkSize - 1);

                        if (error) {
                            console.error(`Erro ao buscar chunk de 'data_history':`, error);
                            break;
                        }
                        if (data) {
                            allHistory = allHistory.concat(data);
                        }
                        if (!data || data.length < chunkSize) {
                            break;
                        }
                        offset += chunkSize;
                    }
                    return allHistory;
                };

                const fetchDetailedInChunks = async () => {
                    let allDetailed = [];
                    let offset = 0;
                    const chunkSize = 20000; // <-- REDUZIDO de 25000 para 20000
                    while (true) {
                        const { data, error } = await supabaseClient
                            .from('data_detailed')
                            .select(detailedColumns)
                            .range(offset, offset + chunkSize - 1);

                        if (error) {
                            console.error(`Erro ao buscar chunk de 'data_detailed':`, error);
                            break;
                        }
                        if (data) {
                            allDetailed = allDetailed.concat(data);
                        }
                        if (!data || data.length < chunkSize) {
                            break;
                        }
                        offset += chunkSize;
                    }
                    return allDetailed;
                };

                const [
                    detailedData, historyData, clientsData, ordersData,
                    productDetailsData, activeProductsData, stockData,
                    innovationsData, metadata
                ] = await Promise.all([
                    fetchDetailedInChunks(),
                    fetchHistoryInChunks(),
                    fetchColumnarData('data_clients'),
                    fetchColumnarData('data_orders'),
                    fetchColumnarData('data_product_details'),
                    fetchColumnarData('data_active_products'),
                    fetchColumnarData('data_stock'),
                    fetchColumnarData('data_innovations'),
                    fetchColumnarData('data_metadata')
                ]);
                console.log("DEBUG: clientsData length:", clientsData.length);

                loaderText.textContent = 'Processando dados...';

                const productDetails = (productDetailsData ?? []).reduce((acc, item) => {
                    acc[item.code] = {
                        descricao: item.descricao,
                        fornecedor: item.fornecedor,
                        codfor: item.codfor,
                        dtcadastro: item.dtcadastro
                    };
                    return acc;
                }, {});

                const activeProductCodes = (activeProductsData ?? []).map(item => item.code);

                const stockMap05 = {};
                const stockMap08 = {};
                (stockData ?? []).forEach(item => {
                    if (item.filial === '05') stockMap05[item.product_code] = item.stock_qty;
                    else if (item.filial === '08') stockMap08[item.product_code] = item.stock_qty;
                });

                const metadataValue = (metadata ?? []).find(m => m.key === 'passedWorkingDaysCurrentMonth')?.value;
                const passedWorkingDaysCurrentMonth = metadataValue ? parseInt(metadataValue, 10) : 1;

                const embeddedData = {
                    detailed: detailedData ?? [],
                    history: historyData ?? [],
                    clients: clientsData ?? [],
                    byOrder: ordersData ?? [],
                    innovationsMonth: innovationsData ?? [],
                    productDetails: productDetails,
                    activeProductCodes: activeProductCodes,
                    stockMap05: stockMap05,
                    stockMap08: stockMap08,
                    passedWorkingDaysCurrentMonth: passedWorkingDaysCurrentMonth
                };

                window.embeddedData = embeddedData;
                
                const generationDate = new Date().toLocaleString('pt-BR');
                document.getElementById('generation-date').textContent = `Dados atualizados em: ${generationDate}`;
                
                const scriptLogicContent = document.getElementById('report-logic-script').textContent;
                const logicScript = document.createElement('script');
                logicScript.textContent = scriptLogicContent;
                
                // CORREÇÃO: Torna o dashboard visível ANTES de executar o script de lógica
                mainDashboard.classList.remove('hidden');
                
                document.body.appendChild(logicScript);

                loader.style.opacity = '0';
                setTimeout(() => loader.classList.add('hidden'), 300);

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                loaderText.innerHTML = `<span class="text-red-400">Falha ao carregar dados: ${error.message}</span>`;
            }
        }

        // Inicia o carregamento assim que a página estiver pronta
        document.addEventListener('DOMContentLoaded', carregarDadosDoSupabase);
    </script>


    <!-- 
      9. ADICIONADO: Seu script de lógica original, INALTERADO,
      mas agora dentro de um <script type="text/template"> 
    -->
    <script id="report-logic-script" type="text/template">
        //const embeddedData = window.embeddedData; // Esta linha será removida pois os dados virão como argumento
        let allSalesData = embeddedData.detailed || [];
        let allHistoryData = embeddedData.history || [];

        // CORREÇÃO: Padroniza os campos de nome e supervisor para remover espaços
        allSalesData.forEach(s => {
            if (s.nome) s.nome = s.nome.trim();
            if (s.superv) s.superv = s.superv.trim();
        });
        allHistoryData.forEach(s => {
            if (s.nome) s.nome = s.nome.trim();
            if (s.superv) s.superv = s.superv.trim();
        });

        const aggregatedOrders = embeddedData.byOrder || [];
        const allClientsData = embeddedData.clients || [];
        const stockData05 = new Map(Object.entries(embeddedData.stockMap05 || {}));
        const stockData08 = new Map(Object.entries(embeddedData.stockMap08 || {}));
        const innovationsMonthData = embeddedData.innovationsMonth || [];
        const clientMapForKPIs = new Map(allClientsData.map(c => [String(c['codigo_cliente']), c]));
        const activeProductCodesFromCadastro = new Set(embeddedData.activeProductCodes || []);
        const productDetailsMap = new Map(Object.entries(embeddedData.productDetails || {}));
        const passedWorkingDaysCurrentMonth = embeddedData.passedWorkingDaysCurrentMonth || 1;

        const clientsWithSalesThisMonth = new Set(allSalesData.map(s => s.codcli));

        const optimizedData = {
            salesById: new Map(),
            historyById: new Map(),
            indices: {
                current: {
                    bySupervisor: new Map(),
                    byRca: new Map(),
                    byPasta: new Map(),
                    bySupplier: new Map(),
                    byClient: new Map(),
                    byPosition: new Map(),
                    byRede: new Map(),
                    byTipoVenda: new Map()
                },
                history: {
                    bySupervisor: new Map(),
                    byRca: new Map(),
                    byPasta: new Map(),
                    bySupplier: new Map(),
                    byClient: new Map(),
                    byTipoVenda: new Map()
                }
            }
        };
        let clientLastBranch = new Map();
        let clientRamoMap = new Map();

        const lastSaleDate = allSalesData.length > 0 ? new Date(Math.max.apply(null, allSalesData.map(s => parseDate(s.dtped)).filter(d => d && !isNaN(d)))) : new Date();
        lastSaleDate.setHours(0,0,0,0);
        let maxWorkingDaysStock = 0;
        let sortedWorkingDays = [];
        let customWorkingDaysStock = 0;

        function initializeOptimizedDataStructures() {
            try {
            // 1. Criar um mapa de detalhes do vendedor (codusur -> {nome, supervisor})
            const sellerDetailsMap = new Map();
            const allDataForSellerMapping = [...allSalesData, ...allHistoryData];
            allDataForSellerMapping.forEach(s => {
                if (s.codusur && (!sellerDetailsMap.has(s.codusur) || s.nome)) { // Prioriza registros com nome
                    sellerDetailsMap.set(s.codusur, { name: s.nome, supervisor: s.superv });
                }
            });

            // 2. Criar um mapa do cliente para o seu vendedor principal atual (codcli -> codusur)
            const clientToCurrentSellerMap = new Map();
            let americanasCodCli = null;
            allClientsData.forEach(client => {
                if (client.codigo_cliente && client.rca1) {
                    clientToCurrentSellerMap.set(String(client.codigo_cliente), String(client.rca1));
                }
                // 3. Identificar o código do cliente para "Americanas" para a exceção
                if (client.razaosocial && client.razaosocial.toUpperCase().includes('AMERICANAS')) {
                    americanasCodCli = String(client.codigo_cliente);
                }
            });

            // 4. Função para reatribuir vendas baseada na nova regra
            const remapSales = (salesData) => {
                return salesData.map(sale => {
                    const clientCode = String(sale.codcli);
                    // Aplica a regra para todos, exceto para o cliente "Americanas"
                    if (clientCode !== americanasCodCli) {
                        const currentSellerCode = clientToCurrentSellerMap.get(clientCode);
                        if (currentSellerCode) {
                            const sellerDetails = sellerDetailsMap.get(currentSellerCode);
                            if (sellerDetails) {
                                // Cria um novo objeto para não modificar o original diretamente (imutabilidade)
                                const remappedSale = { ...sale };
                                remappedSale.codusur = currentSellerCode;
                                remappedSale.nome = sellerDetails.name;
                                remappedSale.superv = sellerDetails.supervisor;
                                return remappedSale;
                            }
                        }
                    }
                    // Retorna a venda original se a regra não se aplicar
                    return sale;
                });
            };

            // 5. Substituir os dados originais pelos dados reatribuídos
            allSalesData = remapSales(allSalesData);
            allHistoryData = remapSales(allHistoryData);

            allClientsData.forEach(client => {
                let rcaList = [];
                if (client.rcas) {
                    if (typeof client.rcas === 'string') {
                        // Assuming string format like "{rca1,rca2}"
                        rcaList = client.rcas.replace(/[{}]/g, '').split(',').filter(r => r);
                    } else if (Array.isArray(client.rcas)) {
                        rcaList = client.rcas;
                    }
                }
                if (client.rca1 && !rcaList.includes(client.rca1)) rcaList.push(client.rca1);
                if (client.rca2 && !rcaList.includes(client.rca2)) rcaList.push(client.rca2);
                client.rcas = rcaList;
            });
            aggregatedOrders.sort((a, b) => {
                const dateA = parseDate(a.dtped);
                const dateB = parseDate(b.dtped);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateB - dateA;
            });
            optimizedData.clientsByRca = new Map();
            allClientsData.forEach(client => {
                clientRamoMap.set(client['codigo_cliente'], client.ramo || 'N/A');
                
                const rca1 = client.rca1;
                if (rca1) {
                    if (!optimizedData.clientsByRca.has(rca1)) {
                        optimizedData.clientsByRca.set(rca1, []);
                    }
                    optimizedData.clientsByRca.get(rca1).push(client);
                }
            });

            optimizedData.rcasBySupervisor = new Map();
            const supervisorToRcaMap = new Map();
            const populateSupervisorMap = (sale) => {
                 if (sale.codusur && sale.superv) {
                    if (!supervisorToRcaMap.has(sale.superv)) {
                        supervisorToRcaMap.set(sale.superv, new Set());
                    }
                    supervisorToRcaMap.get(sale.superv).add(sale.codusur);
                }
            };
            allSalesData.forEach(populateSupervisorMap);
            allHistoryData.forEach(populateSupervisorMap);

            supervisorToRcaMap.forEach((rcas, supervisor) => {
                optimizedData.rcasBySupervisor.set(supervisor, Array.from(rcas));
            });

            optimizedData.productsBySupplier = new Map();
            const populateProductMap = (sale) => {
                if (sale.codfor && sale.produto) {
                    const codfor = String(sale.codfor);
                    if (!optimizedData.productsBySupplier.has(codfor)) {
                        optimizedData.productsBySupplier.set(codfor, new Set());
                    }
                    optimizedData.productsBySupplier.get(codfor).add(sale.produto);
                }
            };
            allSalesData.forEach(populateProductMap);
            allHistoryData.forEach(populateProductMap);


            optimizedData.salesByProduct = { current: new Map(), history: new Map() };
            allSalesData.forEach(sale => {
                if (sale.produto) {
                    if (!optimizedData.salesByProduct.current.has(sale.produto)) {
                        optimizedData.salesByProduct.current.set(sale.produto, []);
                    }
                    optimizedData.salesByProduct.current.get(sale.produto).push(sale);
                }
            });
            allHistoryData.forEach(sale => {
                if (sale.produto) {
                    if (!optimizedData.salesByProduct.history.has(sale.produto)) {
                        optimizedData.salesByProduct.history.set(sale.produto, []);
                    }
                    optimizedData.salesByProduct.history.get(sale.produto).push(sale);
                }
            });

            optimizedData.rcaCodeByName = new Map();
            const populateRcaCodeMap = (s) => {
                if(s.nome && s.codusur) optimizedData.rcaCodeByName.set(s.nome, s.codusur);
            };
            allSalesData.forEach(populateRcaCodeMap);
            allHistoryData.forEach(populateRcaCodeMap);

            [...allSalesData, ...allHistoryData].forEach(sale => {
                if (sale.codcli && sale.filial) {
                    clientLastBranch.set(sale.codcli, sale.filial);
                }
            });

            const buildIndex = (data, indexSet, dataMap) => {
                const { bySupervisor, byRca, byPasta, bySupplier, byClient, byPosition, byRede, byTipoVenda } = indexSet;
                
                data.forEach((sale, index) => {
                    const id = dataMap.size;
                    dataMap.set(id, sale);

                    const supervisor = sale.superv || 'N/A';
                    const rca = sale.nome || 'N/A';
                    const pasta = sale.observacaofor || 'N/A';
                    const supplier = sale.codfor || 'N/A';
                    const client = sale.codcli || 'N/A';
                    const position = sale.posicao || 'N/A';
                    const rede = clientRamoMap.get(client) || 'N/A';
                    const tipoVenda = sale.tipovenda || 'N/A';

                    if (!bySupervisor.has(supervisor)) bySupervisor.set(supervisor, new Set());
                    bySupervisor.get(supervisor).add(id);

                    if (!byRca.has(rca)) byRca.set(rca, new Set());
                    byRca.get(rca).add(id);

                    if (!byPasta.has(pasta)) byPasta.set(pasta, new Set());
                    byPasta.get(pasta).add(id);

                    if (!bySupplier.has(supplier)) bySupplier.set(supplier, new Set());
                    bySupplier.get(supplier).add(id);

                    if (!byClient.has(client)) byClient.set(client, new Set());
                    byClient.get(client).add(id);

                    if (byTipoVenda) {
                        if (!byTipoVenda.has(tipoVenda)) byTipoVenda.set(tipoVenda, new Set());
                        byTipoVenda.get(tipoVenda).add(id);
                    }

                    if (byPosition) {
                        if (!byPosition.has(position)) byPosition.set(position, new Set());
                        byPosition.get(position).add(id);
                    }
                    
                    if (byRede) {
                         if (!byRede.has(rede)) byRede.set(rede, new Set());
                         byRede.get(rede).add(id);
                    }
                });
            };

            buildIndex(allSalesData, optimizedData.indices.current, optimizedData.salesById);
            buildIndex(allHistoryData, optimizedData.indices.history, optimizedData.historyById);


            optimizedData.salesByClientAndRca_CurrentMonth = new Map();
            allSalesData.forEach(s => {
                if (s.vlvenda > 0 && s.codcli && s.produto && s.codusur) {
                    if (!optimizedData.salesByClientAndRca_CurrentMonth.has(s.codcli)) {
                        optimizedData.salesByClientAndRca_CurrentMonth.set(s.codcli, new Map());
                    }
                    const clientSales = optimizedData.salesByClientAndRca_CurrentMonth.get(s.codcli);
                    if (!clientSales.has(s.produto)) {
                        clientSales.set(s.produto, new Set());
                    }
                    clientSales.get(s.produto).add(s.codusur);
                }
            });

            const currentMonth = lastSaleDate.getUTCMonth();
            const currentYear = lastSaleDate.getUTCFullYear();
            const previousMonth = (currentMonth === 0) ? 11 : currentMonth - 1;
            const previousMonthYear = (currentMonth === 0) ? currentYear - 1 : currentYear;

            optimizedData.salesByClientAndRca_PreviousMonth = new Map();
            allHistoryData.forEach(s => {
                const saleDate = parseDate(s.dtped);
                if (s.vlvenda > 0 && s.codcli && s.produto && s.codusur && saleDate?.getUTCMonth() === previousMonth && saleDate?.getUTCFullYear() === previousMonthYear) {
                     if (!optimizedData.salesByClientAndRca_PreviousMonth.has(s.codcli)) {
                        optimizedData.salesByClientAndRca_PreviousMonth.set(s.codcli, new Map());
                    }
                    const clientSales = optimizedData.salesByClientAndRca_PreviousMonth.get(s.codcli);
                    if (!clientSales.has(s.produto)) {
                        clientSales.set(s.produto, new Set());
                    }
                    clientSales.get(s.produto).add(s.codusur);
                }
            });

            optimizedData.bonificationsByClientAndRca_CurrentMonth = new Map();
            allSalesData.forEach(s => {
                if (s.vlbonific > 0 && s.codcli && s.produto && s.codusur) {
                    if (!optimizedData.bonificationsByClientAndRca_CurrentMonth.has(s.codcli)) {
                        optimizedData.bonificationsByClientAndRca_CurrentMonth.set(s.codcli, new Map());
                    }
                    const clientBonuses = optimizedData.bonificationsByClientAndRca_CurrentMonth.get(s.codcli);
                    if (!clientBonuses.has(s.produto)) {
                        clientBonuses.set(s.produto, new Set());
                    }
                    clientBonuses.get(s.produto).add(s.codusur);
                }
            });

            optimizedData.bonificationsByClientAndRca_PreviousMonth = new Map();
            allHistoryData.forEach(s => {
                const saleDate = parseDate(s.dtped);
                if (s.vlbonific > 0 && s.codcli && s.produto && s.codusur && saleDate?.getUTCMonth() === previousMonth && saleDate?.getUTCFullYear() === previousMonthYear) {
                     if (!optimizedData.bonificationsByClientAndRca_PreviousMonth.has(s.codcli)) {
                        optimizedData.bonificationsByClientAndRca_PreviousMonth.set(s.codcli, new Map());
                    }
                    const clientBonuses = optimizedData.bonificationsByClientAndRca_PreviousMonth.get(s.codcli);
                    if (!clientBonuses.has(s.produto)) {
                        clientBonuses.set(s.produto, new Set());
                    }
                    clientBonuses.get(s.produto).add(s.codusur);
                }
            });

            const workingDaysSet = new Set();
            const allSalesForDays = [...allSalesData, ...allHistoryData];
            allSalesForDays.forEach(sale => {
                const date = parseDate(sale.dtped);
                if (date) {
                    // CORREÇÃO 3: Usar getUTCDay() em vez de getDay() para cálculos de data consistentes
                    const dayOfWeek = date.getUTCDay();
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                        workingDaysSet.add(date.toISOString().split('T')[0]);
                    }
                }
            });
        
            sortedWorkingDays = Array.from(workingDaysSet).sort((a, b) => new Date(a) - new Date(b));
        
            maxWorkingDaysStock = workingDaysSet.size > 0 ? workingDaysSet.size : 1;
            customWorkingDaysStock = maxWorkingDaysStock;

            optimizedData.productPastaMap = new Map();
            const populatePastaMap = (sale) => {
                if (sale.PRODUTO && sale.observacaofor && !optimizedData.productPastaMap.has(sale.PRODUTO)) {
                    optimizedData.productPastaMap.set(sale.PRODUTO, sale.observacaofor);
                }
            };
            allSalesData.forEach(populatePastaMap);
            allHistoryData.forEach(populatePastaMap);
        
            setTimeout(() => {
                const maxDaysLabel = document.getElementById('max-working-days-label');
                if (maxDaysLabel) {
                    maxDaysLabel.textContent = `(Máx: ${maxWorkingDaysStock})`;
                }
                 const daysInput = document.getElementById('stock-working-days-input');
                 if(daysInput) daysInput.value = customWorkingDaysStock;
            }, 0);
        } catch (error) {
                console.error("Erro fatal durante initializeOptimizedDataStructures:", error);
            }
        }

        Chart.register(ChartDataLabels);

        const mainDashboard = document.getElementById('main-dashboard');
        const cityView = document.getElementById('city-view');
        const weeklyView = document.getElementById('weekly-view');
        const comparisonView = document.getElementById('comparison-view');
        const stockView = document.getElementById('stock-view');

        const showWeeklyBtn = document.getElementById('show-weekly-btn');
        const showCityBtn = document.getElementById('show-city-btn');
        const backToMainFromCityBtn = document.getElementById('back-to-main-from-city-btn');
        const backToMainFromWeeklyBtn = document.getElementById('back-to-main-from-weekly-btn');
        const backToMainFromComparisonBtn = document.getElementById('back-to-main-from-comparison-btn');
        const backToMainFromStockBtn = document.getElementById('back-to-main-from-stock-btn');

        const totalVendasEl = document.getElementById('total-vendas');
        const totalPesoEl = document.getElementById('total-peso');
        const kpiSkuPdVEl = document.getElementById('kpi-sku-pdv');
        const kpiPositivacaoEl = document.getElementById('kpi-positivacao');
        const kpiPositivacaoPercentEl = document.getElementById('kpi-positivacao-percent');


        const viewChartBtn = document.getElementById('viewChartBtn');
        const viewTableBtn = document.getElementById('viewTableBtn');
        const viewComparisonBtn = document.getElementById('viewComparisonBtn');
        const viewStockBtn = document.getElementById('viewStockBtn');
        const chartView = document.getElementById('chartView');
        const tableView = document.getElementById('tableView');
        const faturamentoBtn = document.getElementById('faturamentoBtn');
        const pesoBtn = document.getElementById('pesoBtn');

        const supervisorFilter = document.getElementById('supervisor-filter');
        const fornecedorFilter = document.getElementById('fornecedor-filter');
        const vendedorFilterBtn = document.getElementById('vendedor-filter-btn');
        const vendedorFilterText = document.getElementById('vendedor-filter-text');
        const vendedorFilterDropdown = document.getElementById('vendedor-filter-dropdown');

        const tipoVendaFilterBtn = document.getElementById('tipo-venda-filter-btn');
        const tipoVendaFilterText = document.getElementById('tipo-venda-filter-text');
        const tipoVendaFilterDropdown = document.getElementById('tipo-venda-filter-dropdown');

        const mainRedeGroupContainer = document.getElementById('main-rede-group-container');
        const mainComRedeBtn = document.getElementById('main-com-rede-btn');
        const mainComRedeBtnText = document.getElementById('main-com-rede-btn-text');
        const mainRedeFilterDropdown = document.getElementById('main-rede-filter-dropdown');

        const posicaoFilter = document.getElementById('posicao-filter');
        const codcliFilter = document.getElementById('codcli-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const salesByPersonTitle = document.getElementById('sales-by-person-title');
        const fornecedorToggleContainer = document.getElementById('fornecedor-toggle-container');

        const citySupervisorFilter = document.getElementById('city-supervisor-filter');
        const cityVendedorFilterBtn = document.getElementById('city-vendedor-filter-btn');
        const cityVendedorFilterText = document.getElementById('city-vendedor-filter-text');
        const cityVendedorFilterDropdown = document.getElementById('city-vendedor-filter-dropdown');
        const cityNameFilter = document.getElementById('city-name-filter');
        const cityCodCliFilter = document.getElementById('city-codcli-filter');
        const citySuggestions = document.getElementById('city-suggestions');
        const clearCityFiltersBtn = document.getElementById('clear-city-filters-btn');
        const totalFaturamentoCidadeEl = document.getElementById('total-faturamento-cidade');
        const cityActiveDetailTableBody = document.getElementById('city-active-detail-table-body');
        const cityInactiveDetailTableBody = document.getElementById('city-inactive-detail-table-body');

        const cityRedeGroupContainer = document.getElementById('city-rede-group-container');
        const cityComRedeBtn = document.getElementById('city-com-rede-btn');
        const cityComRedeBtnText = document.getElementById('city-com-rede-btn-text');
        const cityRedeFilterDropdown = document.getElementById('city-rede-filter-dropdown');

        const weeklySupervisorFilter = document.getElementById('weekly-supervisor-filter');
        const clearWeeklyFiltersBtn = document.getElementById('clear-weekly-filters-btn');
        const totalMesSemanalEl = document.getElementById('total-mes-semanal');
        const weeklyFornecedorToggleContainer = document.getElementById('weekly-fornecedor-toggle-container');

        const comparisonSupervisorFilter = document.getElementById('comparison-supervisor-filter');
        const comparisonVendedorFilterBtn = document.getElementById('comparison-vendedor-filter-btn');
        const comparisonVendedorFilterText = document.getElementById('comparison-vendedor-filter-text');
        const comparisonVendedorFilterDropdown = document.getElementById('comparison-vendedor-filter-dropdown');
        const comparisonFornecedorToggleContainer = document.getElementById('comparison-fornecedor-toggle-container');
        const comparisonFilialFilter = document.getElementById('comparison-filial-filter');

        const comparisonSupplierFilterBtn = document.getElementById('comparison-supplier-filter-btn');
        const comparisonSupplierFilterText = document.getElementById('comparison-supplier-filter-text');
        const comparisonSupplierFilterDropdown = document.getElementById('comparison-supplier-filter-dropdown');

        const comparisonCityFilter = document.getElementById('comparison-city-filter');
        const comparisonCitySuggestions = document.getElementById('comparison-city-suggestions');
        const comparisonProductFilterBtn = document.getElementById('comparison-product-filter-btn');
        const comparisonProductFilterText = document.getElementById('comparison-product-filter-text');
        const comparisonProductFilterDropdown = document.getElementById('comparison-product-filter-dropdown');

        const comparisonRedeGroupContainer = document.getElementById('comparison-rede-group-container');
        const comparisonComRedeBtn = document.getElementById('comparison-com-rede-btn');
        const comparisonComRedeBtnText = document.getElementById('comparison-com-rede-btn-text');
        const comparisonRedeFilterDropdown = document.getElementById('comparison-rede-filter-dropdown');

        const clearComparisonFiltersBtn = document.getElementById('clear-comparison-filters-btn');
        const comparisonTendencyToggle = document.getElementById('comparison-tendency-toggle');

        const comparisonChartTitle = document.getElementById('comparison-chart-title');
        const toggleWeeklyBtn = document.getElementById('toggle-weekly-btn');
        const toggleMonthlyBtn = document.getElementById('toggle-monthly-btn');
        const weeklyComparisonChartContainer = document.getElementById('weeklyComparisonChartContainer');
        const monthlyComparisonChartContainer = document.getElementById('monthlyComparisonChartContainer');

        // Elementos do novo Menu Retrátil
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const mainNav = document.getElementById('main-nav');

        const stockFilialFilter = document.getElementById('stock-filial-filter');
        const stockRedeGroupContainer = document.getElementById('stock-rede-group-container');
        const stockComRedeBtn = document.getElementById('stock-com-rede-btn');
        const stockComRedeBtnText = document.getElementById('stock-com-rede-btn-text');
        const stockRedeFilterDropdown = document.getElementById('stock-rede-filter-dropdown');
        const stockFornecedorToggleContainer = document.getElementById('stock-fornecedor-toggle-container');
        const stockSupervisorFilter = document.getElementById('stock-supervisor-filter');
        const stockVendedorFilterBtn = document.getElementById('stock-vendedor-filter-btn');
        const stockVendedorFilterText = document.getElementById('stock-vendedor-filter-text');
        const stockVendedorFilterDropdown = document.getElementById('stock-vendedor-filter-dropdown');
        const stockSupplierFilterBtn = document.getElementById('stock-supplier-filter-btn');
        const stockSupplierFilterText = document.getElementById('stock-supplier-filter-text');
        const stockSupplierFilterDropdown = document.getElementById('stock-supplier-filter-dropdown');
        const stockCityFilter = document.getElementById('stock-city-filter');
        const stockCitySuggestions = document.getElementById('stock-city-suggestions');
        const stockProductFilterBtn = document.getElementById('stock-product-filter-btn');
        const stockProductFilterText = document.getElementById('stock-product-filter-text');
        const stockProductFilterDropdown = document.getElementById('stock-product-filter-dropdown');
        const clearStockFiltersBtn = document.getElementById('clear-stock-filters-btn');
        const stockAnalysisTableBody = document.getElementById('stock-analysis-table-body');
        const growthTableBody = document.getElementById('growth-table-body');
        const declineTableBody = document.getElementById('decline-table-body');
        const newProductsTableBody = document.getElementById('new-products-table-body');
        const lostProductsTableBody = document.getElementById('lost-products-table-body');

        const innovationsView = document.getElementById('innovations-view');
        const viewInnovationsBtn = document.getElementById('viewInnovationsBtn');
        const backToMainFromInnovationsBtn = document.getElementById('back-to-main-from-innovations-btn');
        const innovationsSupervisorFilter = document.getElementById('innovations-supervisor-filter');
        const innovationsVendedorFilterBtn = document.getElementById('innovations-vendedor-filter-btn');
        const innovationsVendedorFilterText = document.getElementById('innovations-vendedor-filter-text');
        const innovationsVendedorFilterDropdown = document.getElementById('innovations-vendedor-filter-dropdown');
        const innovationsSupplierFilterBtn = document.getElementById('innovations-supplier-filter-btn');
        const innovationsSupplierFilterText = document.getElementById('innovations-supplier-filter-text');
        const innovationsSupplierFilterDropdown = document.getElementById('innovations-supplier-filter-dropdown');
        const innovationsCityFilter = document.getElementById('innovations-city-filter');
        const innovationsCitySuggestions = document.getElementById('innovations-city-suggestions');
        const innovationsProductFilterBtn = document.getElementById('innovations-product-filter-btn');
        const innovationsProductFilterText = document.getElementById('innovations-product-filter-text');
        const innovationsProductFilterDropdown = document.getElementById('innovations-product-filter-dropdown');
        const clearInnovationsFiltersBtn = document.getElementById('clear-innovations-filters-btn');
        const innovationsTableBody = document.getElementById('innovations-table-body');
        const innovationsPlaceholder = document.getElementById('innovations-placeholder');
        const innovationsResults = document.getElementById('innovations-results');
        const innovationsActiveClientsKpi = document.getElementById('innovations-active-clients-kpi');
        const innovationsTopCoverageProductKpi = document.getElementById('innovations-top-coverage-product-kpi');
        const innovationsTopCoverageValueKpi = document.getElementById('innovations-top-coverage-value-kpi');
        const innovationsTopCoverageCountKpi = document.getElementById('innovations-top-coverage-count-kpi');
        const innovationsSelectionCoverageValueKpi = document.getElementById('innovations-selection-coverage-value-kpi');
        const innovationsSelectionCoverageCountKpi = document.getElementById('innovations-selection-coverage-count-kpi');
        const innovationsSelectionCoverageValueKpiPrevious = document.getElementById('innovations-selection-coverage-value-kpi-previous');
        const innovationsSelectionCoverageCountKpiPrevious = document.getElementById('innovations-selection-coverage-count-kpi-previous');
        const innovationsBonusCoverageValueKpi = document.getElementById('innovations-bonus-coverage-value-kpi');
        const innovationsBonusCoverageCountKpi = document.getElementById('innovations-bonus-coverage-count-kpi');
        const innovationsBonusCoverageValueKpiPrevious = document.getElementById('innovations-bonus-coverage-value-kpi-previous');
        const innovationsBonusCoverageCountKpiPrevious = document.getElementById('innovations-bonus-coverage-count-kpi-previous');
        const innovationsMonthBtn = document.getElementById('innovations-month-btn');
        const innovationsFilialFilter = document.getElementById('innovations-filial-filter');
        const innovationsIncludeBonusCheckbox = document.getElementById('innovations-include-bonus');

        const innovationsMonthView = document.getElementById('innovations-month-view');
        const backToInnovationsFromMonthBtn = document.getElementById('back-to-innovations-from-month-btn');
        const innovationsMonthChartContainer = document.getElementById('innovations-month-chartContainer');
        const innovationsMonthTableBody = document.getElementById('innovations-month-table-body');
        const innovationsMonthCategoryFilter = document.getElementById('innovations-month-category-filter');
        const innovationsMonthSupervisorFilter = document.getElementById('innovations-month-supervisor-filter');
        const innovationsMonthVendedorFilterBtn = document.getElementById('innovations-month-vendedor-filter-btn');
        const innovationsMonthVendedorFilterText = document.getElementById('innovations-month-vendedor-filter-text');
        const innovationsMonthVendedorFilterDropdown = document.getElementById('innovations-month-vendedor-filter-dropdown');
        const innovationsMonthCityFilter = document.getElementById('innovations-month-city-filter');
        const innovationsMonthCitySuggestions = document.getElementById('innovations-month-city-suggestions');
        const clearInnovationsMonthFiltersBtn = document.getElementById('clear-innovations-month-filters-btn');
        const innovationsMonthFilialFilter = document.getElementById('innovations-month-filial-filter');
        const innovationsMonthActiveClientsKpi = document.getElementById('innovations-month-active-clients-kpi');
        const innovationsMonthTopCoverageKpi = document.getElementById('innovations-month-top-coverage-kpi');
        const innovationsMonthTopCoverageValueKpi = document.getElementById('innovations-month-top-coverage-value-kpi');
        const innovationsMonthTopCoverageCountKpi = document.getElementById('innovations-month-top-coverage-count-kpi');
        const innovationsMonthSelectionCoverageValueKpi = document.getElementById('innovations-month-selection-coverage-value-kpi');
        const innovationsMonthSelectionCoverageCountKpi = document.getElementById('innovations-month-selection-coverage-count-kpi');
        const innovationsMonthSelectionCoverageValueKpiPrevious = document.getElementById('innovations-month-selection-coverage-value-kpi-previous');
        const innovationsMonthSelectionCoverageCountKpiPrevious = document.getElementById('innovations-month-selection-coverage-count-kpi-previous');
        const innovationsMonthBonusCoverageValueKpi = document.getElementById('innovations-month-bonus-coverage-value-kpi');
        const innovationsMonthBonusCoverageCountKpi = document.getElementById('innovations-month-bonus-coverage-count-kpi');
        const innovationsMonthBonusCoverageValueKpiPrevious = document.getElementById('innovations-month-bonus-coverage-value-kpi-previous');
        const innovationsMonthBonusCoverageCountKpiPrevious = document.getElementById('innovations-month-bonus-coverage-count-kpi-previous');
        const exportInnovationsMonthPdfBtn = document.getElementById('export-innovations-month-pdf-btn');
        const innovationsMonthIncludeBonusCheckbox = document.getElementById('innovations-month-include-bonus');

        const coverageView = document.getElementById('coverage-view');
        const viewCoverageBtn = document.getElementById('viewCoverageBtn');
        const backToMainFromCoverageBtn = document.getElementById('back-to-main-from-coverage-btn');
        const coverageSupervisorFilter = document.getElementById('coverage-supervisor-filter');
        const coverageVendedorFilterBtn = document.getElementById('coverage-vendedor-filter-btn');
        const coverageVendedorFilterText = document.getElementById('coverage-vendedor-filter-text');
        const coverageVendedorFilterDropdown = document.getElementById('coverage-vendedor-filter-dropdown');
        const coverageSupplierFilterBtn = document.getElementById('coverage-supplier-filter-btn');
        const coverageSupplierFilterText = document.getElementById('coverage-supplier-filter-text');
        const coverageSupplierFilterDropdown = document.getElementById('coverage-supplier-filter-dropdown');
        const coverageCityFilter = document.getElementById('coverage-city-filter');
        const coverageCitySuggestions = document.getElementById('coverage-city-suggestions');
        const coverageProductFilterBtn = document.getElementById('coverage-product-filter-btn');
        const coverageProductFilterText = document.getElementById('coverage-product-filter-text');
        const coverageProductFilterDropdown = document.getElementById('coverage-product-filter-dropdown');
        const clearCoverageFiltersBtn = document.getElementById('clear-coverage-filters-btn');
        const coverageFilialFilter = document.getElementById('coverage-filial-filter');
        const coverageIncludeBonusCheckbox = document.getElementById('coverage-include-bonus');

        const coverageActiveClientsKpi = document.getElementById('coverage-active-clients-kpi');
        const coverageSelectionCoverageValueKpiPrevious = document.getElementById('coverage-selection-coverage-value-kpi-previous');
        const coverageSelectionCoverageCountKpiPrevious = document.getElementById('coverage-selection-coverage-count-kpi-previous');
        const coverageSelectionCoverageValueKpi = document.getElementById('coverage-selection-coverage-value-kpi');
        const coverageSelectionCoverageCountKpi = document.getElementById('coverage-selection-coverage-count-kpi');
        const coverageTopCoverageValueKpi = document.getElementById('coverage-top-coverage-value-kpi');
        const coverageTopCoverageProductKpi = document.getElementById('coverage-top-coverage-product-kpi');

        const coverageTableBody = document.getElementById('coverage-table-body');


        const modal = document.getElementById('order-details-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalPedidoId = document.getElementById('modal-pedido-id');
        const modalHeaderInfo = document.getElementById('modal-header-info');
        const modalTableBody = document.getElementById('modal-table-body');
        const modalFooterTotal = document.getElementById('modal-footer-total');

        const clientModal = document.getElementById('client-details-modal');
        const clientModalCloseBtn = document.getElementById('client-modal-close-btn');
        const clientModalContent = document.getElementById('client-modal-content');

        const holidayModal = document.getElementById('holiday-modal');
        const holidayModalCloseBtn = document.getElementById('holiday-modal-close-btn');
        const holidayModalDoneBtn = document.getElementById('holiday-modal-done-btn');
        const mainHolidayPickerBtn = document.getElementById('main-holiday-picker-btn');
        const comparisonHolidayPickerBtn = document.getElementById('comparison-holiday-picker-btn');
        const calendarContainer = document.getElementById('calendar-container');
        
        const tablePaginationControls = document.getElementById('table-pagination-controls');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');
        const pageInfoText = document.getElementById('page-info-text');

        let charts = {};
        let currentProductMetric = 'faturamento';
        let currentFornecedor = '';
        let currentWeeklyFornecedor = '';
        let currentComparisonFornecedor = '';
        let currentStockFornecedor = '';
        let useTendencyComparison = false;
        let comparisonChartType = 'weekly';
        let activeClientsForExport = [];
        let inactiveClientsForExport = [];
        let selectedSellers = [];
        let selectedCitySellers = [];
        let selectedComparisonSellers = [];
        let selectedStockSellers = [];
        let selectedTiposVenda = [];
        let selectedComparisonSuppliers = [];
        let selectedComparisonProducts = [];
        let selectedStockSuppliers = [];
        let selectedStockProducts = [];
        let historicalBests = {};
        let selectedHolidays = [];
        let stockTrendFilter = 'all';

        let selectedMainRedes = [];
        let selectedCityRedes = [];
        let selectedComparisonRedes = [];
        let selectedStockRedes = [];

        let mainRedeGroupFilter = '';
        let cityRedeGroupFilter = '';
        let comparisonRedeGroupFilter = '';
        let stockRedeGroupFilter = '';

        let selectedInnovationsSellers = [];
        let selectedInnovationsSuppliers = [];
        let selectedInnovationsProducts = [];
        let selectedInnovationsMonthSellers = [];

        let globalInnovationsKPI = { activeClients: 0, topProduct: { product: '-', coverage: 0, clients: 0 } };
        let innovationsIncludeBonus = true;
        let innovationsMonthIncludeBonus = true;

        let innovationsMonthTableDataForExport = [];
        let innovationsByClientForExport = [];
        let categoryLegendForExport = [];
        let chartLabels = [];

        let calendarState = { year: lastSaleDate.getFullYear(), month: lastSaleDate.getMonth() };

        let selectedCoverageSellers = [];
        let selectedCoverageSuppliers = [];
        let selectedCoverageProducts = [];
        let coverageIncludeBonus = true;
        
        let mainTableState = {
            currentPage: 1,
            itemsPerPage: 50,
            filteredData: [],
            totalPages: 1
        };

        initializeOptimizedDataStructures();

        const getFirstName = (fullName) => (fullName || '').split(' ')[0];

        function parseDate(dateString) {
            if (!dateString) return null;

            // Se já for um objeto Date, retorna diretamente
            if (dateString instanceof Date) {
                return !isNaN(dateString.getTime()) ? dateString : null;
            }

            // Se for um número (formato Excel)
            if (typeof dateString === 'number') {
                return new Date(Math.round((dateString - 25569) * 86400 * 1000));
            }
            
            if (typeof dateString !== 'string') return null;

            // Tentativa de parse para 'YYYY-MM-DDTHH:mm:ss.sssZ' ou 'YYYY-MM-DD'
            // O construtor do Date já lida bem com isso, mas vamos garantir o UTC.
            if (dateString.includes('T') || dateString.includes('-')) {
                 // Adiciona 'Z' se não tiver informação de fuso horário para forçar UTC
                const isoString = dateString.endsWith('Z') ? dateString : dateString + 'Z';
                const isoDate = new Date(isoString);
                if (!isNaN(isoDate.getTime())) {
                    return isoDate;
                }
            }

            // Tentativa de parse para 'DD/MM/YYYY'
            if (dateString.length === 10 && dateString.charAt(2) === '/' && dateString.charAt(5) === '/') {
                const [day, month, year] = dateString.split('/');
                if (year && month && day && year.length === 4) {
                    // Cria a data em UTC para evitar problemas de fuso horário
                    const utcDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day)));
                    if (!isNaN(utcDate.getTime())) {
                        return utcDate;
                    }
                }
            }

            // Fallback para outros formatos que o `new Date()` consegue interpretar
            const genericDate = new Date(dateString);
            if (!isNaN(genericDate.getTime())) {
                return genericDate;
            }

            return null; // Retorna nulo se nenhum formato corresponder
        }

        function formatDate(date) {
            if (!date) return '';
            const d = parseDate(date);
            if (!d || isNaN(d.getTime())) return '';

            const day = String(d.getUTCDate()).padStart(2, '0');
            const month = String(d.getUTCMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const year = d.getUTCFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // <!-- INÍCIO DO CÓDIGO RESTAURADO -->
        
        function getCoverageFilteredData() {
            const supervisor = coverageSupervisorFilter.value;
            const sellers = selectedCoverageSellers;
            const suppliers = selectedCoverageSuppliers;
            const products = selectedCoverageProducts;
            const city = coverageCityFilter.value.trim().toLowerCase();
            const filial = coverageFilialFilter.value;

            let clients = [...allClientsData];

            if (filial !== 'ambas') {
                clients = clients.filter(c => {
                    const lastBranch = clientLastBranch.get(c['codigo_cliente']);
                    return lastBranch === filial;
                });
            }

            if (supervisor) {
                const rcasOfSupervisor = new Set(optimizedData.rcasBySupervisor.get(supervisor) || []);
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSupervisor.has(rca)));
            }
            if (sellers.length > 0) {
                const rcasOfSellers = new Set();
                 sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) rcasOfSellers.add(rcaCode);
                });
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSellers.has(rca)));
            }
            if (city) {
                clients = clients.filter(c => c.cidade && c.cidade.toLowerCase() === city);
            }

            let sales = [...allSalesData];
            let history = [...allHistoryData];
            if (filial !== 'ambas') {
                 sales = sales.filter(s => s.filial === filial);
                 history = history.filter(s => s.filial === filial);
            }
            
            const salesFilter = s => 
                (suppliers.length === 0 || suppliers.includes(String(s.codfor))) &&
                (products.length === 0 || products.includes(String(s.produto)));
                
            sales = sales.filter(salesFilter);
            history = history.filter(salesFilter);

            return { sales, history, clients };
        }
        
        function updateCoverageFilters() {
            const { sales, history } = getCoverageFilteredData();
            let productSource = [...sales, ...history];
            updateProductFilter(coverageProductFilterDropdown, coverageProductFilterText, selectedCoverageProducts, productSource, 'coverage');
        }
        
        function resetCoverageFilters() {
            coverageSupervisorFilter.value = '';
            coverageCityFilter.value = '';
            coverageFilialFilter.value = 'ambas';
            coverageIncludeBonusCheckbox.checked = true;
            coverageIncludeBonus = true;
            selectedCoverageSellers = [];
            selectedCoverageSuppliers = [];
            selectedCoverageProducts = [];
            updateSellerFilter('', coverageVendedorFilterDropdown, coverageVendedorFilterText, [], allSalesData);
            updateSupplierFilter(coverageSupplierFilterDropdown, coverageSupplierFilterText, [], allSalesData, 'coverage');
            updateCoverageFilters();
            updateCoverageView();
        }
        
        function updateCoverageView() {
            const { clients, sales, history } = getCoverageFilteredData();
            const productsToAnalyze = [...new Set([...sales.map(s => s.produto), ...history.map(s => s.produto)])];

            const supervisor = coverageSupervisorFilter.value;
            const sellers = selectedCoverageSellers;
            const sellerRcaCodes = new Set();
            if (sellers.length > 0) {
                sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) sellerRcaCodes.add(rcaCode);
                });
            } else if (supervisor) {
                (optimizedData.rcasBySupervisor.get(supervisor) || []).forEach(rca => sellerRcaCodes.add(rca));
            }

            const activeClientsForCoverage = clients.filter(c => {
                const codcli = c['codigo_cliente'];
                const rca1 = String(c.rca1 || '').trim();
                
                // --- INÍCIO DA MODIFICAÇÃO ---
                // REGRA DE EXCLUSÃO REMOVIDA: Ignora clientes destes RCAs
                /*
                if (rca1 === '306' || rca1 === '300') {
                    return false;
                }
                */
                // --- FIM DA MODIFICAÇÃO ---

                const isAmericanas = (c.razaosocial || '').toUpperCase().includes('AMERICANAS');
                // const isVdHiago = vdHiagoClients.has(codcli); // REGRA REMOVIDA
                
                // Regra de inclusão
                return (isAmericanas || rca1 !== '53');
            });
            const activeClientsCount = activeClientsForCoverage.length;
            const activeClientCodes = new Set(activeClientsForCoverage.map(c => c['codigo_cliente']));

            coverageActiveClientsKpi.textContent = activeClientsCount.toLocaleString('pt-BR');

            if (productsToAnalyze.length === 0) {
                coverageSelectionCoverageValueKpi.textContent = '0%';
                coverageSelectionCoverageCountKpi.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                coverageSelectionCoverageValueKpiPrevious.textContent = '0%';
                coverageSelectionCoverageCountKpiPrevious.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                coverageTopCoverageValueKpi.textContent = '0%';
                coverageTopCoverageProductKpi.textContent = '-';
                coverageTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-slate-500">Nenhum produto selecionado ou encontrado para os filtros.</td></tr>';
                return;
            }

            const tableData = [];
            const clientsWhoGotSelectionCurrent = new Set();
            const clientsWhoGotSelectionPrevious = new Set();
            let topCoverageItem = { name: '-', coverage: 0, clients: 0 };
            const activeStockMap = getActiveStockMap(coverageFilialFilter.value);

            productsToAnalyze.forEach(productCode => {
                const productInfo = productDetailsMap.get(productCode) || { descricao: `Produto ${productCode}`};

                let clientsWhoGotProductCurrent = 0;
                let clientsWhoGotProductPrevious = 0;

                activeClientCodes.forEach(codcli => {
                    const clientSalesCurrent = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                    const clientBonusCurrent = coverageIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;
                    if ((clientSalesCurrent && clientSalesCurrent.has(productCode) && (sellerRcaCodes.size === 0 || [...clientSalesCurrent.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                        (clientBonusCurrent && clientBonusCurrent.has(productCode) && (sellerRcaCodes.size === 0 || [...clientBonusCurrent.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                        clientsWhoGotProductCurrent++;
                        clientsWhoGotSelectionCurrent.add(codcli);
                    }

                    const clientSalesPrevious = optimizedData.salesByClientAndRca_PreviousMonth.get(codcli);
                    const clientBonusPrevious = coverageIncludeBonus ? optimizedData.bonificationsByClientAndRca_PreviousMonth.get(codcli) : null;

                    if ((clientSalesPrevious && clientSalesPrevious.has(productCode) && (sellerRcaCodes.size === 0 || [...clientSalesPrevious.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                        (clientBonusPrevious && clientBonusPrevious.has(productCode) && (sellerRcaCodes.size === 0 || [...clientBonusPrevious.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                        clientsWhoGotProductPrevious++;
                        clientsWhoGotSelectionPrevious.add(codcli);
                    }
                });

                const coverageCurrent = activeClientsCount > 0 ? (clientsWhoGotProductCurrent / activeClientsCount) * 100 : 0;
                
                if (coverageCurrent > topCoverageItem.coverage) {
                    topCoverageItem = {
                        name: `(${productCode}) ${productInfo.descricao}`,
                        coverage: coverageCurrent,
                        clients: clientsWhoGotProductCurrent
                    };
                }

                const stockQty = activeStockMap.get(productCode) || 0;
                const productAllSales = [...sales, ...history].filter(s => s.produto === productCode);
                
                const productCadastroDate = parseDate(productInfo.dtcadastro);
                let productFirstWorkingDayIndex = 0;
                if (productCadastroDate) {
                    const cadastroDateString = productCadastroDate.toISOString().split('T')[0];
                    productFirstWorkingDayIndex = sortedWorkingDays.findIndex(d => d >= cadastroDateString);
                    if (productFirstWorkingDayIndex === -1) productFirstWorkingDayIndex = sortedWorkingDays.length;
                }
                const productMaxLifeInWorkingDays = sortedWorkingDays.length - productFirstWorkingDayIndex;
                const effectiveDaysToCalculate = Math.min(customWorkingDaysStock, productMaxLifeInWorkingDays) || 1;
                
                const endDate = parseDate(sortedWorkingDays[sortedWorkingDays.length - 1]);
                const targetIndex = Math.max(0, sortedWorkingDays.length - effectiveDaysToCalculate);
                const startDate = parseDate(sortedWorkingDays[targetIndex]);
                
                let totalQtySoldInRange = 0;
                productAllSales.forEach(sale => {
                    const saleDate = parseDate(sale.dtped);
                    if (saleDate && saleDate >= startDate && saleDate <= endDate) {
                        totalQtySoldInRange += sale.qtvenda_embalagem_master;
                    }
                });

                const dailyAvgSale = totalQtySoldInRange / effectiveDaysToCalculate;
                const trendDays = dailyAvgSale > 0 ? (stockQty / dailyAvgSale) : (stockQty > 0 ? Infinity : 0);
                
                tableData.push({
                    descricao: `(${productCode}) ${productInfo.descricao}`,
                    stockQty: stockQty,
                    trendDays: trendDays,
                    clientsPreviousCount: clientsWhoGotProductPrevious,
                    clientsCurrentCount: clientsWhoGotProductCurrent,
                    coverageCurrent: coverageCurrent
                });
            });

            coverageTopCoverageValueKpi.textContent = `${topCoverageItem.coverage.toFixed(2)}%`;
            coverageTopCoverageProductKpi.textContent = topCoverageItem.name;
            coverageTopCoverageProductKpi.title = topCoverageItem.name;

            const selectionCoveredCountCurrent = clientsWhoGotSelectionCurrent.size;
            const selectionCoveragePercentCurrent = activeClientsCount > 0 ? (selectionCoveredCountCurrent / activeClientsCount) * 100 : 0;
            coverageSelectionCoverageValueKpi.textContent = `${selectionCoveragePercentCurrent.toFixed(2)}%`;
            coverageSelectionCoverageCountKpi.textContent = `${selectionCoveredCountCurrent.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            const selectionCoveredCountPrevious = clientsWhoGotSelectionPrevious.size;
            const selectionCoveragePercentPrevious = activeClientsCount > 0 ? (selectionCoveredCountPrevious / activeClientsCount) * 100 : 0;
            coverageSelectionCoverageValueKpiPrevious.textContent = `${selectionCoveragePercentPrevious.toFixed(2)}%`;
            coverageSelectionCoverageCountKpiPrevious.textContent = `${selectionCoveredCountPrevious.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
            
            tableData.sort((a, b) => b.coverageCurrent - a.coverageCurrent);

            coverageTableBody.innerHTML = tableData.map(item => {
                let trendText;
                if (!isFinite(item.trendDays) && item.stockQty > 0) {
                    trendText = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-500/30 text-gray-300">S/ VENDA</span>`;
                } else if (isFinite(item.trendDays)) {
                    const trendDays = Math.floor(item.trendDays);
                    let trendColor = 'text-slate-400';
                    if (trendDays < 15) trendColor = 'text-red-400';
                    else if (trendDays < 30) trendColor = 'text-yellow-400';
                    else trendColor = 'text-green-400';
                    trendText = `<span class="font-bold ${trendColor}">${trendDays} dias</span>`;
                } else {
                    trendText = '-';
                }
                
                return `
                    <tr class="hover:bg-slate-700/50">
                        <td class="px-2 py-1.5 text-xs">${item.descricao}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.stockQty.toLocaleString('pt-BR')}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${trendText}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.clientsPreviousCount.toLocaleString('pt-BR')}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.clientsCurrentCount.toLocaleString('pt-BR')}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.coverageCurrent.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        // <!-- FIM DO CÓDIGO RESTAURADO -->

        function getUniqueMonthCount(data) {
            const months = new Set();
            data.forEach(sale => {
                const saleDate = parseDate(sale.dtped);
                if (saleDate) {
                    const monthKey = `${saleDate.getFullYear()}-${saleDate.getMonth()}`;
                    months.add(monthKey);
                }
            });
            return months.size > 0 ? months.size : 1;
        }

        function calculateSummaryFromData(data, isFiltered, clientBaseForPositivacao) {
            const summary = {
                totalFaturamento: 0, totalPeso: 0, vendasPorVendedor: {}, vendasPorSupervisor: {},
                top10ProdutosFaturamento: [], top10ProdutosPeso: [], faturamentoPorFornecedor: {},
                skuPdv: 0, positivacaoCount: 0, positivacaoPercent: 0
            };
            const salesByProduct = {};
            const faturamentoMap = new Map();

            // --- INÍCIO DA MODIFICAÇÃO: KPIs de Cobertura e SKU ---
            
            // 1. Lógica de Positivação (Cobertura)
            // Registar clientes que tiveram *qualquer* operação (Venda OU Bonificação)
            const positiveClients = new Set();
            data.forEach(sale => {
                // Se o cliente teve Venda (vlvenda > 0) OU Bonificação (vlbonific > 0), ele é considerado positivado.
                if (sale.codcli && (sale.vlvenda > 0 || sale.vlbonific > 0)) {
                    positiveClients.add(sale.codcli);
                }
            });
            summary.positivacaoCount = positiveClients.size;


            let totalSkus = 0;
            data.forEach(item => {
                summary.totalFaturamento += item.vlvenda;
                summary.totalPeso += item.totpesoliq;

                // 2. Lógica de SKU/PDV
                // Contamos o SKU se for uma Venda OU uma Bonificação
                if(item.vlvenda > 0 || item.vlbonific > 0) {
                    totalSkus++;
                }

                const vendedor = item.nome || 'N/A';
                summary.vendasPorVendedor[vendedor] = (summary.vendasPorVendedor[vendedor] || 0) + item.vlvenda;

                const supervisor = item.superv || 'N/A';
                summary.vendasPorSupervisor[supervisor] = (summary.vendasPorSupervisor[supervisor] || 0) + item.vlvenda;

                const produto = item.descricao || 'N/A';
                const codigo = item.produto || 'N/A';
                if (!salesByProduct[produto]) salesByProduct[produto] = { faturamento: 0, peso: 0, codigo: codigo };
                salesByProduct[produto].faturamento += item.vlvenda;
                salesByProduct[produto].peso += item.totpesoliq;

                let fornecedorLabel;
                if(isFiltered){
                    const fornecedorNome = item.fornecedor || 'N/A';
                    const codFor = item.codfor;
                    fornecedorLabel = `${fornecedorNome} - ${codFor}`;
                } else {
                     fornecedorLabel = item.observacaofor || 'N/A';
                }

                const currentTotal = faturamentoMap.get(fornecedorLabel) || 0;
                faturamentoMap.set(fornecedorLabel, currentTotal + item.vlvenda);
            });

            const totalRelevantClients = clientBaseForPositivacao.length;
            summary.positivacaoPercent = totalRelevantClients > 0 ? (summary.positivacaoCount / totalRelevantClients) * 100 : 0;
            // O cálculo do SKU/PDV agora usa a nova contagem de SKUs e a nova contagem de positivação
            summary.skuPdv = summary.positivacaoCount > 0 ? totalSkus / summary.positivacaoCount : 0;
            // --- FIM DA MODIFICAÇÃO ---

            summary.faturamentoPorFornecedor = Object.fromEntries(faturamentoMap);
            summary.top10ProdutosFaturamento = Object.entries(salesByProduct).sort(([,a],[,b]) => b.faturamento - a.faturamento).slice(0, 10).map(([p, d]) => ({ produto: p, ...d }));
            summary.top10ProdutosPeso = Object.entries(salesByProduct).sort(([,a],[,b]) => b.peso - a.peso).slice(0, 10).map(([p, d]) => ({ produto: p, ...d }));
            return summary;
        }

        const isObject = obj => obj && typeof obj === 'object' && !Array.isArray(obj);
        const mergeDeep = (...objects) => {
            return objects.reduce((prev, obj) => {
                Object.keys(obj).forEach(key => {
                    const pVal = prev[key];
                    const oVal = obj[key];
                    if (isObject(pVal) && isObject(oVal)) prev[key] = mergeDeep(pVal, oVal);
                    else prev[key] = oVal;
                });
                return prev;
            }, {});
        };

        function createChart(canvasId, type, labels, chartData, optionsOverrides = {}, pluginsToRegister = []) {
            const container = document.getElementById(canvasId + 'Container');
            if (!container) {
                console.error(`Chart container not found for id: ${canvasId}Container`);
                return;
            }

            if (pluginsToRegister.length > 0) {
                try { Chart.register(...pluginsToRegister); } catch (e) {}
            }

            const getCSSVar = (variable) => getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
            const textColor = getCSSVar('--text-primary');
            const secondaryTextColor = getCSSVar('--text-secondary');
            const gridColor = getCSSVar('--border-primary');
            
            const professionalPalette = [
                '#84a98c', '#a5a58d', '#a5a58d', '#b7b7a4', '#cad2c5', // Tons suaves de verde e cinza
                '#ffb4a2', '#ffcdb2', '#e5989b', '#b5838d', '#6d6875'  // Tons suaves de rosa e pêssego
            ];

            let finalDatasets;
            if (Array.isArray(chartData) && chartData.length > 0 && typeof chartData[0] === 'object' && chartData[0].hasOwnProperty('label')) {
                finalDatasets = chartData.map((dataset, index) => ({ ...dataset, backgroundColor: dataset.backgroundColor || professionalPalette[index % professionalPalette.length], borderColor: dataset.borderColor || professionalPalette[index % professionalPalette.length] }));
            } else {
                 finalDatasets = [{ data: chartData || [], backgroundColor: canvasId === 'customerStatusChart' ? ['#84a98c', '#e5989b'] : professionalPalette }];
            }
            
            let baseOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false, labels: {color: textColor} }, datalabels: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: secondaryTextColor }, grid: { color: gridColor} }, x: { ticks: { color: secondaryTextColor }, grid: { color: gridColor} } } };
            let typeDefaults = {};
            if (type === 'bar') typeDefaults = { layout: { padding: { right: 30 } }, plugins: { datalabels: { display: true, anchor: 'end', align: 'end', offset: -4, color: textColor, font: { size: 10 }, formatter: (v) => (v > 1000 ? (v/1000).toFixed(1) + 'k' : v.toFixed(0)) } } };
            if (type === 'doughnut') typeDefaults = { maintainAspectRatio: true, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: { position: 'top', labels: { color: textColor } }, datalabels: { display: true, color: '#FFF', font: { size: 11, weight: 'bold' }, formatter: (v, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); if(total === 0 || v === 0) return ''; const p = (v / total) * 100; return p > 5 ? p.toFixed(0) + '%' : ''; } } } };
            
            // 1. Sempre construir um objeto de opções novo e limpo
            const options = mergeDeep({}, baseOptions, typeDefaults, optionsOverrides);

            if (charts[canvasId]) {
                charts[canvasId].data.labels = labels;
                charts[canvasId].data.datasets = finalDatasets;
                // 2. Substituir as opções antigas pelas novas, em vez de tentar um merge
                charts[canvasId].options = options; 
                charts[canvasId].update();
                return;
            }

            container.innerHTML = '';
            const newCanvas = document.createElement('canvas');
            newCanvas.id = canvasId;
            container.appendChild(newCanvas);
            container.style.display = ''; container.style.alignItems = ''; container.style.justifyContent = '';
            const ctx = newCanvas.getContext('2d');
            
            charts[canvasId] = new Chart(ctx, { type, data: { labels, datasets: finalDatasets }, options });
        }

        function showNoDataMessage(canvasId, message) {
            if (charts[canvasId]) {
                charts[canvasId].destroy();
                delete charts[canvasId];
            }
            const container = document.getElementById(canvasId + 'Container');
            if(container) {
                container.style.display = 'flex'; container.style.alignItems = 'center'; container.style.justifyContent = 'center';
                container.innerHTML = `<p class="text-slate-500">${message}</p>`;
            }
        }

        function updateProductBarChart(summary) {
            const metric = currentProductMetric;
            const data = metric === 'faturamento' ? summary.top10ProdutosFaturamento : summary.top10ProdutosPeso;
            const labels = data.map(p => `(${p.codigo}) ${p.produto}`);
            const values = data.map(p => p[metric]);
            createChart('salesByProductBarChart', 'bar', labels, values);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('report-table-body');
            if (!tableBody) return;

            mainTableState.filteredData = data;
            mainTableState.totalPages = Math.ceil(data.length / mainTableState.itemsPerPage);
            if (mainTableState.currentPage > mainTableState.totalPages && mainTableState.totalPages > 0) {
                mainTableState.currentPage = mainTableState.totalPages;
            } else if (mainTableState.totalPages === 0) {
                 mainTableState.currentPage = 1;
            }

            const startIndex = (mainTableState.currentPage - 1) * mainTableState.itemsPerPage;
            const endIndex = startIndex + mainTableState.itemsPerPage;
            const pageData = data.slice(startIndex, endIndex);

            const getPosicaoBadge = (posicao) => {
                if (!posicao) return '<span>-</span>';
                let classes = '';
                switch (posicao) {
                    case 'L': classes = 'bg-green-500/20 text-green-300'; break;
                    case 'M': classes = 'bg-blue-500/20 text-blue-300'; break;
                    case 'F': classes = 'bg-yellow-500/20 text-yellow-300'; break;
                    default: return `<span>${posicao}</span>`;
                }
                return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${classes}">${posicao}</span>`;
            };
            
            tableBody.innerHTML = pageData.map(row => `
                <tr>
                    <td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-pedido-id="${row.pedido}">${row.pedido}</a></td>
                    <td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-codcli="${row.codcli}">${row.codcli}</a></td>
                    <td class="px-4 py-2">${getFirstName(row.nome)}</td>
                    <td class="px-4 py-2">${row.fornecedores_str || ''}</td>
                    <td class="px-4 py-2">${formatDate(row.dtped)}</td>
                    <td class="px-4 py-2">${formatDate(row.dtsaida)}</td>
                    <td class="px-4 py-2 text-right">${(row.totpesoliq || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })} Kg</td>
                    <td class="px-4 py-2 text-right">${(row.vlvenda || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="px-4 py-2 text-center">${getPosicaoBadge(row.posicao)}</td>
                </tr>
            `).join('');

            if (data.length > 0) {
                pageInfoText.textContent = `Página ${mainTableState.currentPage} de ${mainTableState.totalPages} (Total: ${data.length} pedidos)`;
                prevPageBtn.disabled = mainTableState.currentPage === 1;
                nextPageBtn.disabled = mainTableState.currentPage === mainTableState.totalPages;
                tablePaginationControls.classList.remove('hidden');
            } else {
                pageInfoText.textContent = 'Nenhum pedido encontrado.';
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                tablePaginationControls.classList.add('hidden');
            }
        }

        function isHoliday(date, holidays) {
            if (!date || !holidays) return false;
            const dateString = date.toISOString().split('T')[0];
            return holidays.includes(dateString);
        }

        function getWorkingDaysInMonth(year, month, holidays) {
            let count = 0;
            const date = new Date(Date.UTC(year, month, 1));
            while (date.getUTCMonth() === month) {
                const dayOfWeek = date.getUTCDay(); // Sunday is 0, Monday is 1
                if (dayOfWeek >= 1 && dayOfWeek <= 5 && !isHoliday(date, holidays)) {
                    count++;
                }
                date.setUTCDate(date.getUTCDate() + 1);
            }
            return count;
        }

        function getPassedWorkingDaysInMonth(year, month, holidays, today) {
            let count = 0;
            // Ensure the start date is in UTC
            const date = new Date(Date.UTC(year, month, 1));
            // Ensure the 'today' parameter is also treated as a UTC date for comparison
            const todayUTC = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));

            while (date <= todayUTC && date.getUTCMonth() === month) {
                const dayOfWeek = date.getUTCDay(); // 0 for Sunday
                if (dayOfWeek >= 1 && dayOfWeek <= 5 && !isHoliday(date, holidays)) {
                    count++;
                }
                date.setUTCDate(date.getUTCDate() + 1);
            }
            return count > 0 ? count : 1;
        }


        function updateTrendChart(currentSales, historicalSales) {
            if (!currentSales || currentSales.length === 0 || !historicalSales || historicalSales.length === 0) {
                showNoDataMessage('trendChart', 'Dados insuficientes para exibir a tendência.');
                return;
            }
            const currentYear = lastSaleDate.getFullYear();
            const currentMonth = lastSaleDate.getMonth();
            const totalWorkingDays = getWorkingDaysInMonth(currentYear, currentMonth, selectedHolidays);
            const passedWorkingDays = getPassedWorkingDaysInMonth(currentYear, currentMonth, selectedHolidays, lastSaleDate);

            const averageMonthlyRevenue = monthlyKpiAverage(historicalSales, (sales) => sales.reduce((sum, s) => sum + s.vlvenda, 0));
            const currentMonthRevenue = currentSales.reduce((sum, sale) => sum + sale.vlvenda, 0);
            const trend = passedWorkingDays > 0 && totalWorkingDays > 0 ? (currentMonthRevenue / passedWorkingDays) * totalWorkingDays : 0;
            const lineChartDataset = [{ label: 'Valor', data: [averageMonthlyRevenue, trend], fill: true, borderColor: 'var(--bg-button-active)', backgroundColor: 'rgba(20, 184, 166, 0.1)', tension: 0.2, pointRadius: 6, pointBackgroundColor: 'var(--bg-button-active)', pointBorderColor: 'var(--bg-content)', pointBorderWidth: 2, pointHoverRadius: 8 }];
            
            const formatLabelValue = (v) => {
                if (typeof v !== 'number') return ''; // Proteção contra valores não numéricos
                return (v >= 1000000 ? (v / 1000000).toFixed(2) + ' M' : (v / 1000).toFixed(0) + 'k');
            };
            
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim();

            createChart('trendChart', 'line', ['Média Faturamento Trimestre', 'Tendência Mês Atual'], lineChartDataset, {
                layout: { padding: { top: 30 } },
                plugins: {
                    legend: { display: false },
                    datalabels: { display: true, anchor: 'end', align: 'top', offset: 8, color: textColor, font: { size: 12, weight: 'bold' }, formatter: formatLabelValue }
                },
                scales: {
                    y: { ticks: { callback: function(value) { if (value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(1) + 'M'; return 'R$ ' + (value / 1000) + 'k'; } } },
                    x: { grid: { display: false } }
                }
            });
        }

        function updateAllVisuals() {
            console.log("Debug: updateAllVisuals chamada.");
            const supervisor = supervisorFilter.value;
            const posicao = posicaoFilter.value;
            const codcli = codcliFilter.value.trim();
            const selectedFornecedor = fornecedorFilter.value;

            let clientBaseForCoverage = allClientsData.filter(c => {
                const rca1 = String(c.rca1 || '').trim();
                const isAmericanas = (c.razaosocial || '').toUpperCase().includes('AMERICANAS');
                return (isAmericanas || rca1 !== '53');
            });

            if (mainRedeGroupFilter === 'com_rede') {
                clientBaseForCoverage = clientBaseForCoverage.filter(c => c.ramo && c.ramo !== 'N/A');
                if (selectedMainRedes.length > 0) {
                    clientBaseForCoverage = clientBaseForCoverage.filter(c => selectedMainRedes.includes(c.ramo));
                }
            } else if (mainRedeGroupFilter === 'sem_rede') {
                clientBaseForCoverage = clientBaseForCoverage.filter(c => !c.ramo || c.ramo === 'N/A');
            }
            const clientCodesInRede = new Set(clientBaseForCoverage.map(c => c['codigo_cliente']));

            const getFilteredData = (sourceData) => {
                return sourceData.filter(item => {
                    let matches = true;
                    if (mainRedeGroupFilter) {
                        matches = matches && clientCodesInRede.has(item.codcli);
                    }
                    if (codcli) {
                        matches = matches && item.codcli === codcli;
                    } else {
                        if (supervisor) {
                            matches = matches && item.superv === supervisor;
                        }
                        if (selectedSellers.length > 0) {
                            matches = matches && selectedSellers.includes(item.nome);
                        }
                    }
                    if (selectedTiposVenda.length > 0) {
                        matches = matches && selectedTiposVenda.includes(item.tipovenda);
                    }
                    if (currentFornecedor) {
                        if (item.fornecedores_list) { // Para aggregatedOrders
                            matches = matches && item.fornecedores_list.includes(currentFornecedor);
                        } else { // Para allSalesData/allHistoryData
                            matches = matches && item.observacaofor === currentFornecedor;
                        }
                    }
                    if (selectedFornecedor) {
                         if (item.codfors_list) { // Para aggregatedOrders
                            matches = matches && item.codfors_list.includes(selectedFornecedor);
                        } else { // Para allSalesData/allHistoryData
                            matches = matches && item.codfor == selectedFornecedor;
                        }
                    }
                    if (posicao) {
                        matches = matches && item.posicao === posicao;
                    }
                    return matches;
                });
            };

            const filteredSalesData = getFilteredData(allSalesData);
            const filteredHistoryData = getFilteredData(allHistoryData);
            const filteredTableData = getFilteredData(aggregatedOrders);
            
            const isFiltered = !!supervisor || selectedSellers.length > 0 || !!codcli || !!currentFornecedor || !!mainRedeGroupFilter || !!selectedFornecedor || !!posicao || selectedTiposVenda.length > 0;

            const summary = calculateSummaryFromData(filteredSalesData, isFiltered, clientBaseForCoverage);

            totalVendasEl.textContent = summary.totalFaturamento.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            totalPesoEl.textContent = `${(summary.totalPeso / 1000).toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}`;
            kpiSkuPdVEl.textContent = summary.skuPdv.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
            kpiPositivacaoEl.textContent = `${summary.positivacaoPercent.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}%`;
            kpiPositivacaoPercentEl.textContent = `${summary.positivacaoCount.toLocaleString('pt-BR')} PDVs`;


            if (!tableView.classList.contains('hidden')) {
                renderTable(filteredTableData);
            }

            if (!chartView.classList.contains('hidden')) {
                updateTrendChart(filteredSalesData, filteredHistoryData);
                const totalForPercentage = supervisor ? Object.values(summary.vendasPorVendedor).reduce((a, b) => a + b, 0) : Object.values(summary.vendasPorSupervisor).reduce((a, b) => a + b, 0);
                const personChartTooltipOptions = { plugins: { tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; const value = context.parsed.y; if (value !== null) { label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); if (totalForPercentage > 0) { const percentage = ((value / totalForPercentage) * 100).toFixed(2); label += ` (${percentage}%)`; } } return label; } } } } };
                if (supervisor) {
                    salesByPersonTitle.textContent = 'Vendas por Vendedor';
                    createChart('salesByPersonChart', 'bar', Object.keys(summary.vendasPorVendedor).map(getFirstName), Object.values(summary.vendasPorVendedor), personChartTooltipOptions);
                } else {
                    salesByPersonTitle.textContent = 'Vendas por Supervisor';
                    createChart('salesByPersonChart', 'bar', Object.keys(summary.vendasPorSupervisor), Object.values(summary.vendasPorSupervisor), personChartTooltipOptions);
                }

                document.getElementById('faturamentoPorFornecedorTitle').textContent = isFiltered ? 'Faturamento por Fornecedor' : 'Faturamento por Categoria';
                const faturamentoPorFornecedorData = summary.faturamentoPorFornecedor;
                const totalFaturamentoFornecedor = Object.values(faturamentoPorFornecedorData).reduce((a, b) => a + b, 0);
                const fornecedorTooltipOptions = { indexAxis: 'y', plugins: { tooltip: { callbacks: { label: function(context) { let label = context.label || ''; if (label) label += ': '; const value = context.parsed.x; if (value !== null) { label += new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value); if (totalFaturamentoFornecedor > 0) { const percentage = ((value / totalFaturamentoFornecedor) * 100).toFixed(2); label += ` (${percentage}%)`; } } return label; } } } } };
                const sortedFornecedores = Object.entries(faturamentoPorFornecedorData).sort(([, a], [, b]) => a - b);
                if (sortedFornecedores.length > 0) createChart('faturamentoPorFornecedorChart', 'bar', sortedFornecedores.map(([name]) => name), sortedFornecedores.map(([, total]) => total), fornecedorTooltipOptions);
                else showNoDataMessage('faturamentoPorFornecedorChart', 'Sem dados de faturamento.');
                updateProductBarChart(summary);
            }
        }

        function populateSupervisors(filterElementId, dataSource) {
            const supervisorFilterEl = document.getElementById(filterElementId);
            if (!supervisorFilterEl) return;
            const supervisors = [...new Set(dataSource.map(item => item.superv).filter(Boolean))].sort();
            const currentSupervisorValue = supervisorFilterEl.value;
            supervisorFilterEl.innerHTML = '<option value="">Todos</option>';
            supervisors.forEach(sup => { supervisorFilterEl.innerHTML += `<option value="${sup}">${sup}</option>`; });
            if (supervisors.includes(currentSupervisorValue)) supervisorFilterEl.value = currentSupervisorValue;
            else supervisorFilterEl.value = '';
        }

        function populateMainSupplierFilter(filterElementId, dataSource) {
            const filterEl = document.getElementById(filterElementId);
            if (!filterEl) return;
            const suppliers = new Map();
            dataSource.forEach(s => {
                if (s.codfor && s.fornecedor) {
                    suppliers.set(s.codfor, s.fornecedor);
                }
            });
            const sortedSuppliers = [...suppliers.entries()].sort((a, b) => a[1].localeCompare(b[1]));

            filterEl.innerHTML = '<option value="">Todos</option>';
            sortedSuppliers.forEach(([cod, name]) => {
                filterEl.innerHTML += `<option value="${cod}">${cod} - ${name}</option>`;
            });
        }

        function updateSellerFilter(supervisor, dropdown, filterText, selectedArray, dataSource) {
            const sellersToShow = supervisor ? [...new Set(dataSource.filter(s => s.superv === supervisor).map(s => s.nome))].sort() : [...new Set(dataSource.map(item => item.nome).filter(Boolean))].sort();
            selectedArray = selectedArray.filter(seller => sellersToShow.includes(seller));
            dropdown.innerHTML = '';
            sellersToShow.forEach(s => { const isChecked = selectedArray.includes(s); dropdown.innerHTML += `<label class="flex items-center p-2 hover:bg-slate-600 cursor-pointer"><input type="checkbox" class="form-checkbox h-4 w-4 bg-slate-800 border-slate-500 rounded text-teal-500 focus:ring-teal-500" value="${s}" ${isChecked ? 'checked' : ''}><span class="ml-2">${s}</span></label>`; });
            if (selectedArray.length === 0 || selectedArray.length === sellersToShow.length) filterText.textContent = 'Todos Vendedores';
            else if (selectedArray.length === 1) filterText.textContent = selectedArray[0];
            else filterText.textContent = `${selectedArray.length} vendedores selecionados`;
            return selectedArray;
        }

        function updateTipoVendaFilter(dropdown, filterText, selectedArray, dataSource) {
            const tiposVendaToShow = [...new Set(dataSource.map(item => item.tipovenda).filter(Boolean))].sort();
            selectedArray = selectedArray.filter(tipo => tiposVendaToShow.includes(tipo));
            dropdown.innerHTML = '';
            tiposVendaToShow.forEach(s => { 
                const isChecked = selectedArray.includes(s); 
                dropdown.innerHTML += `<label class="flex items-center p-2 hover:bg-slate-600 cursor-pointer"><input type="checkbox" class="form-checkbox h-4 w-4 bg-slate-800 border-slate-500 rounded text-teal-500 focus:ring-teal-500" value="${s}" ${isChecked ? 'checked' : ''}><span class="ml-2">${s}</span></label>`; 
            });
            if (selectedArray.length === 0 || selectedArray.length === tiposVendaToShow.length) filterText.textContent = 'Todos os Tipos';
            else if (selectedArray.length === 1) filterText.textContent = selectedArray[0];
            else filterText.textContent = `${selectedArray.length} tipos selecionados`;
            return selectedArray;
        }

        function updateRedeFilter(dropdown, buttonTextElement, selectedArray, dataSource, baseText = 'Com Rede') {
            const redesToShow = [...new Set(dataSource.map(item => item.ramo).filter(r => r && r !== 'N/A'))].sort();
            const validSelected = selectedArray.filter(rede => redesToShow.includes(rede));

            dropdown.innerHTML = '';
            redesToShow.forEach(r => {
                const isChecked = validSelected.includes(r);
                dropdown.innerHTML += `<label class="flex items-center p-2 hover:bg-slate-600 cursor-pointer"><input type="checkbox" class="form-checkbox h-4 w-4 bg-slate-800 border-slate-500 rounded text-teal-500 focus:ring-teal-500" value="${r}" ${isChecked ? 'checked' : ''}><span class="ml-2 text-sm">${r}</span></label>`;
            });

            if (validSelected.length === 0) {
                buttonTextElement.textContent = baseText;
            } else {
                buttonTextElement.textContent = `${baseText} (${validSelected.length})`;
            }
            return validSelected;
        }

        function resetMainFilters() {
            supervisorFilter.value = '';
            fornecedorFilter.value = '';
            posicaoFilter.value = '';
            codcliFilter.value = '';
            currentFornecedor = '';
            selectedSellers = [];
            selectedTiposVenda = [];
            mainRedeGroupFilter = '';
            selectedMainRedes = [];
            mainTableState.currentPage = 1;

            mainRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            mainRedeGroupContainer.querySelector('button[data-group=""]').classList.add('active');
            updateRedeFilter(mainRedeFilterDropdown, mainComRedeBtnText, selectedMainRedes, allClientsData);

            document.querySelectorAll('#fornecedor-toggle-container .fornecedor-btn').forEach(b => b.classList.remove('active'));
            populateSupervisors('supervisor-filter', allSalesData);
            selectedSellers = updateSellerFilter('', vendedorFilterDropdown, vendedorFilterText, selectedSellers, allSalesData);
            selectedTiposVenda = updateTipoVendaFilter(tipoVendaFilterDropdown, tipoVendaFilterText, selectedTiposVenda, allSalesData);
            updateAllVisuals();
        }

        function resetCityFilters() {
            citySupervisorFilter.value = '';
            cityNameFilter.value = '';
            cityCodCliFilter.value = '';
            selectedCitySellers = [];
            selectedCityRedes = [];
            cityRedeGroupFilter = '';

            selectedCitySellers = updateSellerFilter('', cityVendedorFilterDropdown, cityVendedorFilterText, selectedCitySellers, allSalesData);

            cityRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            cityRedeGroupContainer.querySelector('button[data-group=""]').classList.add('active');
            updateRedeFilter(cityRedeFilterDropdown, cityComRedeBtnText, selectedCityRedes, allClientsData);

            updateCityView();
        }

        function resetWeeklyFilters() {
            weeklySupervisorFilter.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
            currentWeeklyFornecedor = '';
            document.querySelectorAll('#weekly-fornecedor-toggle-container .fornecedor-btn').forEach(b => b.classList.remove('active'));
            updateWeeklyView();
        }

        function resetComparisonFilters() {
            comparisonSupervisorFilter.value = '';
            comparisonFilialFilter.value = 'ambas';
            currentComparisonFornecedor = '';
            comparisonCityFilter.value = '';
            selectedComparisonSellers = [];
            selectedComparisonSuppliers = [];
            selectedComparisonProducts = [];
            comparisonRedeGroupFilter = '';
            selectedComparisonRedes = [];

            comparisonRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            comparisonRedeGroupContainer.querySelector('button[data-group=""]').classList.add('active');
            updateRedeFilter(comparisonRedeFilterDropdown, comparisonComRedeBtnText, selectedComparisonRedes, allClientsData);

            document.querySelectorAll('#comparison-fornecedor-toggle-container .fornecedor-btn').forEach(b => b.classList.remove('active'));

            updateAllComparisonFilters();
            updateComparisonView();
        }

        function resetStockFilters() {
            stockFilialFilter.value = 'ambas';
            currentStockFornecedor = '';
            stockSupervisorFilter.value = '';
            stockCityFilter.value = '';
            selectedStockSellers = [];
            selectedStockSuppliers = [];
            selectedStockProducts = [];
            stockRedeGroupFilter = '';
            selectedStockRedes = [];
            stockTrendFilter = 'all';

            document.querySelectorAll('.stock-trend-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.stock-trend-btn[data-trend="all"]').classList.add('active');

            stockRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            stockRedeGroupContainer.querySelector('button[data-group=""]').classList.add('active');
            updateRedeFilter(stockRedeFilterDropdown, stockComRedeBtnText, selectedStockRedes, allClientsData, 'Com Rede');

            document.querySelectorAll('#stock-fornecedor-toggle-container .fornecedor-btn').forEach(b => b.classList.remove('active'));
            
            customWorkingDaysStock = maxWorkingDaysStock;
            const daysInput = document.getElementById('stock-working-days-input');
            if(daysInput) daysInput.value = customWorkingDaysStock;

            handleStockFilterChange();
        }


        function getRelevantClientsForCityFilter() {
            let clients = [...allClientsData];

            if (cityRedeGroupFilter === 'com_rede') {
                clients = clients.filter(c => c.ramo && c.ramo !== 'N/A');
                if (selectedCityRedes.length > 0) {
                    clients = clients.filter(c => selectedCityRedes.includes(c.ramo));
                }
            } else if (cityRedeGroupFilter === 'sem_rede') {
                clients = clients.filter(c => !c.ramo || c.ramo === 'N/A');
            }

            const supervisor = citySupervisorFilter.value;
            if (supervisor) {
                const rcasOfSupervisor = [...new Set(allSalesData.filter(s => s.superv === supervisor).map(s => s.codusur))];
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSupervisor.includes(rca)));
            }
            if (selectedCitySellers.length > 0) {
                const rcasOfVendedor = [...new Set(allSalesData.filter(s => selectedCitySellers.includes(s.nome)).map(s => s.codusur))];
                clients = clients.filter(c => c.rcas.some(rca => rcasOfVendedor.includes(rca)));
            }

            return clients;
        }

        function updateCitySuggestions(filterInput, suggestionsContainer, dataSource) {
            const inputValue = filterInput.value.toLowerCase();
            const allAvailableCities = [...new Set(dataSource.map(c => c.cidade || c.cidade).filter(c => c && c !== 'N/A'))].sort();
            const filteredCities = inputValue ? allAvailableCities.filter(c => c.toLowerCase().includes(inputValue)) : allAvailableCities;

            if (filteredCities.length > 0 && (document.activeElement === filterInput || !suggestionsContainer.classList.contains('manual-hide'))) {
                suggestionsContainer.innerHTML = filteredCities.map(c => `<div class="p-2 hover:bg-slate-600 cursor-pointer">${c}</div>`).join('');
                suggestionsContainer.classList.remove('hidden');
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        }

        function validateCityFilter() {
            const selectedCity = cityNameFilter.value;
            if (!selectedCity) return;
            const relevantClients = getRelevantClientsForCityFilter();
            const availableCities = [...new Set(relevantClients.map(c => c.cidade).filter(Boolean))];
            if (!availableCities.includes(selectedCity)) cityNameFilter.value = '';
        }

        function updateCityView() {
            const supervisor = citySupervisorFilter.value;
            const codcliFilterVal = cityCodCliFilter.value.trim();
            if (codcliFilterVal && !allClientsData.some(c => String(c['codigo_cliente']) === codcliFilterVal)) return;
            let clientsForAnalysis = getRelevantClientsForCityFilter();
            const allAvailableCities = [...new Set(clientsForAnalysis.map(c => c.cidade).filter(Boolean))];
            const cidadeFiltroInput = cityNameFilter.value.trim();
            let cidadeFiltro = '';
            if (cidadeFiltroInput && allAvailableCities.includes(cidadeFiltroInput)) cidadeFiltro = cidadeFiltroInput;

            const referenceDate = lastSaleDate;
            const currentMonth = referenceDate.getMonth();
            const currentYear = referenceDate.getFullYear();

            let salesForAnalysis = allSalesData;

            const clientCodesForAnalysis = new Set(clientsForAnalysis.map(c => c['codigo_cliente']));
            salesForAnalysis = salesForAnalysis.filter(s => clientCodesForAnalysis.has(s.codcli));

            if (supervisor) salesForAnalysis = salesForAnalysis.filter(s => s.superv === supervisor);
            if (selectedCitySellers.length > 0) salesForAnalysis = salesForAnalysis.filter(s => selectedCitySellers.includes(s.nome));

            if (cidadeFiltro) { clientsForAnalysis = clientsForAnalysis.filter(c => c.cidade && c.cidade === cidadeFiltro); salesForAnalysis = salesForAnalysis.filter(s => s.cidade && s.cidade === cidadeFiltro); }
            if (codcliFilterVal) { clientsForAnalysis = clientsForAnalysis.filter(c => String(c['codigo_cliente']) === codcliFilterVal); salesForAnalysis = salesForAnalysis.filter(s => s.codcli === codcliFilterVal); }

            const salesThisMonth = allSalesData.filter(sale => {
                const saleDate = parseDate(sale.dtped);
                return saleDate && saleDate.getFullYear() === currentYear && saleDate.getMonth() === currentMonth;
            });

            const clientTotalsThisMonth = new Map();
            salesThisMonth.forEach(sale => {
                const codcli = sale.codcli;
                const currentTotal = clientTotalsThisMonth.get(codcli) || 0;
                clientTotalsThisMonth.set(codcli, currentTotal + sale.vlvenda);
            });

            let activeClientsList = [];
            let inactiveClientsList = [];

            clientsForAnalysis.forEach(client => {
                const codcli = String(client['codigo_cliente']);
                if (codcli === '6720' || client.bloqueio === 'S') return;

                const registrationDate = parseDate(client.datacadastro);
                client.isNew = registrationDate && registrationDate.getMonth() === currentMonth && registrationDate.getFullYear() === currentYear;

                const totalFaturamentoMes = clientTotalsThisMonth.get(codcli) || 0;

                if (totalFaturamentoMes > 0) {
                    activeClientsList.push(client);
                } else {
                    if (totalFaturamentoMes < 0) {
                        client.isReturn = true;
                    }
                    const clientRcas = client.rcas || [];
                    if (clientRcas.length > 0 && clientRcas.every(rca => rca === '53')) return;
                    client.isNewForInactiveLabel = client.isNew && !parseDate(client.ultimacompra);
                    inactiveClientsList.push(client);
                }
            });

            inactiveClientsForExport = inactiveClientsList;

            if (clientsForAnalysis.length > 0) {
                 const statusChartOptions = { animation: { duration: 800, easing: 'easeOutQuart' }, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: function(context) { return context.label; } } }, datalabels: { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); if (total === 0 || value === 0) return ''; const percentage = (value * 100 / total).toFixed(1) + "%"; return `${value}\n(${percentage})`; }, color: '#fff', font: { weight: 'bold' }, textAlign: 'center' } } };
                createChart('customerStatusChart', 'doughnut', ['Ativos no Mês', 'S/ Vendas no Mês'], [activeClientsList.length, inactiveClientsList.length], statusChartOptions);
            } else showNoDataMessage('customerStatusChart', 'Sem clientes no filtro para exibir o status.');

            const salesByActiveClient = {};
            activeClientsList.forEach(client => {
                const codcli = String(client['codigo_cliente']);
                let clientSales = salesThisMonth.filter(s => s.codcli === codcli);

                if (selectedCitySellers.length > 0) {
                    clientSales = clientSales.filter(s => selectedCitySellers.includes(s.nome));
                }

                const totalFaturamentoFiltrado = clientSales.reduce((sum, s) => sum + s.vlvenda, 0);

                if (totalFaturamentoFiltrado > 0) {
                    const pepsicoTotal = clientSales.filter(s => s.observacaofor === 'PEPSICO').reduce((sum, s) => sum + s.vlvenda, 0);
                    const multimarcasTotal = clientSales.filter(s => s.observacaofor === 'MULTIMARCAS').reduce((sum, s) => sum + s.vlvenda, 0);
                    const outrosTotal = totalFaturamentoFiltrado - pepsicoTotal - multimarcasTotal;
                    salesByActiveClient[codcli] = { ...client, total: totalFaturamentoFiltrado, pepsico: pepsicoTotal, multimarcas: multimarcasTotal, outros: outrosTotal };
                }
            });

            const sortedActiveClients = Object.values(salesByActiveClient).sort((a, b) => b.total - a.total);
            activeClientsForExport = sortedActiveClients;
            cityActiveDetailTableBody.innerHTML = sortedActiveClients.map(data => {
                const novoLabel = data.isNew ? `<span class="ml-2 text-xs font-semibold text-purple-400 bg-purple-900/50 px-2 py-0.5 rounded-full">NOVO</span>` : '';
                let tooltipParts = [];
                if (data.pepsico > 0) tooltipParts.push(`PEPSICO: ${data.pepsico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                if (data.multimarcas > 0) tooltipParts.push(`MULTIMARCAS: ${data.multimarcas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                if (data.outros > 0.001) tooltipParts.push(`OUTROS: ${data.outros.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                const tooltipText = tooltipParts.length > 0 ? tooltipParts.join('<br>') : 'Sem detalhamento de categoria';
                return `<tr><td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-codcli="${data['codigo_cliente']}">${data['codigo_cliente']}</a></td><td class="px-4 py-2 flex items-center">${data.fantasia || data.razaosocial}${novoLabel}</td><td class="px-4 py-2 text-right"><div class="tooltip">${data.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<span class="tooltip-text" style="width: max-content; transform: translateX(-50%); margin-left: 0;">${tooltipText}</span></div></td><td class="px-4 py-2">${data.cidade}</td><td class="px-4 py-2">${data.bairro}</td><td class="px-4 py-2">${data.rca1 || '-'}</td></tr>`
            }).join('');

            inactiveClientsList.sort((a, b) => {
                if (a.isReturn && !b.isReturn) return -1;
                if (!a.isReturn && b.isReturn) return 1;
                if (a.isNewForInactiveLabel && !b.isNewForInactiveLabel) return -1;
                if (!a.isNewForInactiveLabel && b.isNewForInactiveLabel) return 1;
                return (parseDate(b.ultimacompra) || 0) - (parseDate(a.ultimacompra) || 0);
            });
            cityInactiveDetailTableBody.innerHTML = inactiveClientsList.map(client => {
                const novoLabel = client.isNewForInactiveLabel ? `<span class="ml-2 text-xs font-semibold text-purple-400 bg-purple-900/50 px-2 py-0.5 rounded-full">NOVO</span>` : '';
                const devolucaoLabel = client.isReturn ? `<span class="ml-2 text-xs font-semibold text-red-400 bg-red-900/50 px-2 py-0.5 rounded-full">DEVOLUÇÃO</span>` : '';
                return `<tr><td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-codcli="${client['codigo_cliente']}">${client['codigo_cliente']}</a></td><td class="px-4 py-2 flex items-center">${client.fantasia || client.razaosocial}${novoLabel}${devolucaoLabel}</td><td class="px-4 py-2">${client.cidade}</td><td class="px-4 py-2">${client.bairro}</td><td class="px-4 py-2 text-center">${formatDate(client.ultimacompra)}</td><td class="px-4 py-2">${client.rca1 || '-'}</td></tr>`
            }).join('');

            const cityChartTitleEl = document.getElementById('city-chart-title');
            const cityChartOptions = { indexAxis: 'y', scales: { x: { grace: '15%' } }, plugins: { datalabels: { align: 'end', anchor: 'end', color: '#cbd5e1', font: { size: 14, weight: 'bold' }, formatter: (value) => (value / 1000).toFixed(1) + 'k', offset: 8 } } };
            const totalFaturamentoCidade = salesForAnalysis.reduce((sum, item) => sum + item.vlvenda, 0);
            totalFaturamentoCidadeEl.textContent = totalFaturamentoCidade.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            if (cidadeFiltro) {
                cityChartTitleEl.textContent = 'Top 10 Bairros';
                const salesByBairro = {};
                salesForAnalysis.forEach(sale => { const bairro = sale.bairro || 'N/A'; salesByBairro[bairro] = (salesByBairro[bairro] || 0) + sale.vlvenda; });
                const sortedBairros = Object.entries(salesByBairro).sort(([, a], [, b]) => b - a).slice(0, 10);
                createChart('salesByClientInCityChart', 'bar', sortedBairros.map(([name]) => name), sortedBairros.map(([, total]) => total), cityChartOptions);
            } else {
                cityChartTitleEl.textContent = 'Top 10 Cidades';
                const salesByCity = {};
                salesForAnalysis.forEach(sale => { const cidade = sale.cidade || 'N/A'; salesByCity[cidade] = (salesByCity[cidade] || 0) + sale.vlvenda; });
                const sortedCidades = Object.entries(salesByCity).sort(([, a], [, b]) => b - a).slice(0, 10);
                createChart('salesByClientInCityChart', 'bar', sortedCidades.map(([name]) => name), sortedCidades.map(([, total]) => total), cityChartOptions);
            }
        }

        function getWeekOfMonth(date) {
            // This function now operates entirely in UTC.
            const d = new Date(date);
            const startOfMonth = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
            const dayOfMonth = d.getUTCDate();
            
            // getUTCDay(): 0 for Sunday, 1 for Monday, etc.
            const dayOfWeek = startOfMonth.getUTCDay(); 
            
            // We want Monday to be the first day (index 0). Sunday should be 6.
            const adjustedDayOfWeek = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; 
            
            // Calculate week number
            return Math.ceil((dayOfMonth + adjustedDayOfWeek) / 7);
        }

        function calculateHistoricalBests() {
            const salesBySupervisorByDay = {};
            // Since parseDate now returns UTC dates, all operations should be UTC
            const mostRecentSaleDate = allSalesData.map(s => parseDate(s.dtped)).filter(Boolean).reduce((a, b) => a > b ? a : b, new Date(0));
            
            // Use UTC methods to calculate previous month
            const previousMonthDate = new Date(Date.UTC(mostRecentSaleDate.getUTCFullYear(), mostRecentSaleDate.getUTCMonth() - 1, 1));
            const previousMonth = previousMonthDate.getUTCMonth();
            const previousMonthYear = previousMonthDate.getUTCFullYear();
            
            const historyLastMonthData = allHistoryData.filter(sale => { 
                const saleDate = parseDate(sale.dtped); 
                return saleDate && saleDate.getUTCMonth() === previousMonth && saleDate.getUTCFullYear() === previousMonthYear; 
            });
            
            historyLastMonthData.forEach(sale => {
                if (!sale.superv || sale.superv === 'BALCAO' || !sale.dtped) return;
                const saleDate = parseDate(sale.dtped); if (!saleDate) return;
                const supervisor = sale.superv.toUpperCase(); 
                const dateString = saleDate.toISOString().split('T')[0]; // This is already in YYYY-MM-DD format from UTC
                if (!salesBySupervisorByDay[supervisor]) salesBySupervisorByDay[supervisor] = {};
                if (!salesBySupervisorByDay[supervisor][dateString]) salesBySupervisorByDay[supervisor][dateString] = 0;
                salesBySupervisorByDay[supervisor][dateString] += sale.vlvenda;
            });
            
            const bestDayByWeekdayBySupervisor = {};
            for (const supervisor in salesBySupervisorByDay) {
                const salesByDay = salesBySupervisorByDay[supervisor];
                const bests = {};
                for (const dateString in salesByDay) {
                    // parseDate handles UTC correctly
                    const date = parseDate(dateString); 
                    const dayOfWeek = date.getUTCDay(); // Use getUTCDay
                    const total = salesByDay[dateString];
                    // 1 (Mon) to 5 (Fri)
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) { 
                        if (!bests[dayOfWeek] || total > bests[dayOfWeek]) bests[dayOfWeek] = total; 
                    }
                }
                bestDayByWeekdayBySupervisor[supervisor] = bests;
            }
            historicalBests = bestDayByWeekdayBySupervisor;
        }

        function populateWeeklyFilters() {
            const supervisors = [...new Set(allSalesData.map(item => item.superv).filter(Boolean).filter(sup => sup !== 'BALCAO'))].sort();
            weeklySupervisorFilter.innerHTML = '';
            supervisors.forEach(sup => { weeklySupervisorFilter.innerHTML += `<div class="flex items-center"><input id="sup-check-${sup.replace(/\s+/g, '-')}" type="checkbox" value="${sup}" class="w-4 h-4 text-teal-600 bg-slate-700 border-slate-600 rounded focus:ring-teal-600 ring-offset-slate-800 focus:ring-2"><label for="sup-check-${sup.replace(/\s+/g, '-')}" class="ml-2 text-sm font-medium text-slate-300">${sup}</label></div>`; });
        }

        function updateWeeklyView() {
            const selectedSupervisors = Array.from(weeklySupervisorFilter.querySelectorAll('input:checked')).map(cb => cb.value);
            let dataForGeneralCharts = allSalesData;
            if (currentWeeklyFornecedor) dataForGeneralCharts = dataForGeneralCharts.filter(row => String(row.observacaofor).trim() === currentWeeklyFornecedor);
            if (selectedSupervisors.length > 0) dataForGeneralCharts = dataForGeneralCharts.filter(d => selectedSupervisors.includes(d.superv));
            
            // Use UTC methods to define the current month for filtering
            const currentMonth = lastSaleDate.getUTCMonth(); 
            const currentYear = lastSaleDate.getUTCFullYear();
            
            const monthSales = dataForGeneralCharts.filter(d => { 
                if (!d.dtped) return false; 
                const saleDate = parseDate(d.dtped); 
                // Use UTC methods for comparison
                return saleDate && saleDate.getUTCMonth() === currentMonth && saleDate.getUTCFullYear() === currentYear; 
            });
            
            const totalMes = monthSales.reduce((sum, item) => sum + item.vlvenda, 0);
            totalMesSemanalEl.textContent = totalMes.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            const salesByWeekAndDay = {}; 
            const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            monthSales.forEach(sale => { 
                const saleDate = parseDate(sale.dtped); 
                if (!saleDate) return; 
                const weekNum = getWeekOfMonth(saleDate); // Already UTC-based
                const dayOfWeek = saleDate.getUTCDay(); // Use getUTCDay
                if(dayOfWeek === 0 || dayOfWeek === 6) return; // Skip weekends
                const dayName = dayNames[dayOfWeek]; 
                if (!salesByWeekAndDay[weekNum]) { 
                    salesByWeekAndDay[weekNum] = { 'Segunda': 0, 'Terça': 0, 'Quarta': 0, 'Quinta': 0, 'Sexta': 0 }; 
                } 
                salesByWeekAndDay[weekNum][dayName] = (salesByWeekAndDay[weekNum][dayName] || 0) + sale.vlvenda; 
            });
            
            const weekLabels = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta'];
            const weekNumbers = Object.keys(salesByWeekAndDay).sort((a,b) => a - b);
            const professionalPalette = ['#14b8a6', '#6366f1', '#ec4899', '#f97316', '#8b5cf6'];
            const currentMonthDatasets = weekNumbers.map((weekNum, index) => ({ 
                label: `Semana ${weekNum}`, 
                data: weekLabels.map(day => salesByWeekAndDay[weekNum][day] || 0), 
                backgroundColor: professionalPalette[index % professionalPalette.length] 
            }));
            
            const supervisorsForHistory = selectedSupervisors.length > 0 ? selectedSupervisors : Object.keys(historicalBests).map(s => s.toLowerCase().replace(/(?:^|\s)\S/g, a => a.toUpperCase()));
            const historicalDataForChart = [0, 0, 0, 0, 0];
            supervisorsForHistory.forEach(sup => { 
                const bests = historicalBests[sup.toUpperCase()]; 
                if(bests) { 
                    historicalDataForChart[0] += bests[1] || 0; // Mon
                    historicalDataForChart[1] += bests[2] || 0; // Tue
                    historicalDataForChart[2] += bests[3] || 0; // Wed
                    historicalDataForChart[3] += bests[4] || 0; // Thu
                    historicalDataForChart[4] += bests[5] || 0; // Fri
                } 
            });
            const historicalDataset = { type: 'line', label: 'Melhor Dia Mês Anterior', data: historicalDataForChart, borderColor: '#b5838d', backgroundColor: 'transparent', pointBackgroundColor: '#b5838d', pointRadius: 4, tension: 0.1, borderWidth: 2, yAxisID: 'y', datalabels: { display: false } };
            const finalDatasets = [...currentMonthDatasets, historicalDataset];
            const weeklyChartOptions = { plugins: { legend: { display: true, position: 'top', onClick: (e, legendItem, legend) => { const index = legendItem.datasetIndex; const ci = legend.chart; if (ci.isDatasetVisible(index)) { ci.hide(index); legendItem.hidden = true; } else { ci.show(index); legendItem.hidden = false; } let newTotal = 0; ci.data.datasets.forEach((dataset, i) => { if (ci.isDatasetVisible(i) && dataset.type !== 'line') newTotal += dataset.data.reduce((acc, val) => acc + val, 0); }); totalMesSemanalEl.textContent = newTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); } } } };
            createChart('weeklySalesChart', 'bar', weekLabels, finalDatasets, weeklyChartOptions);
            const weeklySummaryTableBody = document.getElementById('weekly-summary-table-body');
            if (weeklySummaryTableBody) {
                weeklySummaryTableBody.innerHTML = ''; let grandTotal = 0;
                Object.keys(salesByWeekAndDay).sort((a,b) => parseInt(a) - parseInt(b)).forEach(weekNum => { const weekTotal = Object.values(salesByWeekAndDay[weekNum]).reduce((a, b) => a + b, 0); grandTotal += weekTotal; weeklySummaryTableBody.innerHTML += `<tr><td class="px-4 py-2">Semana ${weekNum}</td><td class="px-4 py-2 text-right">${weekTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`; });
                weeklySummaryTableBody.innerHTML += `<tr class="font-bold"><td class="px-4 py-2">Total do Mês</td><td class="px-4 py-2 text-right">${grandTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td></tr>`;
            }
            const dataForRankings = dataForGeneralCharts.filter(d => d.superv !== 'BALCAO');
            const positivacao = {}; dataForRankings.forEach(d => { if (!d.nome || !d.codcli) return; if (!positivacao[d.nome]) positivacao[d.nome] = new Set(); positivacao[d.nome].add(d.codcli); });
            const positivacaoRank = Object.entries(positivacao).map(([v, c]) => ({ vendedor: v, total: c.size })).sort((a, b) => b.total - a.total).slice(0, 10);
            if (positivacaoRank.length > 0) createChart('positivacaoChart', 'bar', positivacaoRank.map(r => getFirstName(r.vendedor)), positivacaoRank.map(r => r.total));
            else showNoDataMessage('positivacaoChart', 'Sem dados para o ranking.');
            const salesBySeller = {}; dataForRankings.forEach(d => { if (!d.nome) return; salesBySeller[d.nome] = (salesBySeller[d.nome] || 0) + d.vlvenda; });
            const topSellersRank = Object.entries(salesBySeller).sort(([, a], [, b]) => b - a).slice(0, 10);
            if (topSellersRank.length > 0) createChart('topSellersChart', 'bar', topSellersRank.map(r => getFirstName(r[0])), topSellersRank.map(r => r[1]));
            else showNoDataMessage('topSellersChart', 'Sem dados para o ranking.');
            const vendorsInFilter = [...new Set(dataForRankings.map(d => d.nome))].filter(v => v !== 'VD HIAGO');
            const mixRank = vendorsInFilter.map(vendedor => { const vendorSales = dataForRankings.filter(d => d.nome === vendedor); if (vendorSales.length === 0) return { vendedor, avgMix: 0 }; const supervisor = vendorSales[0].superv; let salesForMixCalc; if (supervisor === 'OSVALDO NUNES O') salesForMixCalc = vendorSales; else { const targetSuppliers = ['707', '708']; salesForMixCalc = vendorSales.filter(d => targetSuppliers.includes(String(d.codfor))); } const mixPerClient = {}; salesForMixCalc.forEach(d => { if (!d.codcli || !d.descricao) return; if (!mixPerClient[d.codcli]) mixPerClient[d.codcli] = new Set(); mixPerClient[d.codcli].add(d.descricao); }); const mixValues = Object.values(mixPerClient).map(p => p.size); if (mixValues.length === 0) return { vendedor, avgMix: 0 }; const avgMix = mixValues.reduce((a, b) => a + b, 0) / mixValues.length; return { vendedor, avgMix }; }).sort((a, b) => b.avgMix - a.avgMix).slice(0, 10);
            if(mixRank.length > 0 && mixRank.some(r => r.avgMix > 0)) createChart('mixChart', 'bar', mixRank.map(r => getFirstName(r.vendedor)), mixRank.map(r => r.avgMix));
            else showNoDataMessage('mixChart', 'Sem dados para o ranking.');
        }

        function updateSupplierFilter(dropdown, filterText, selectedArray, dataSource, filterType = 'comparison') {
            const suppliers = new Map();
            dataSource.forEach(s => { if(s.codfor && s.fornecedor) suppliers.set(s.codfor, s.fornecedor); });
            const sortedSuppliers = [...suppliers.entries()].sort((a, b) => a[1].localeCompare(b[1]));

            selectedArray = selectedArray.filter(cod => suppliers.has(cod));

            dropdown.innerHTML = '';
            sortedSuppliers.forEach(([cod, name]) => {
                const isChecked = selectedArray.includes(cod);
                dropdown.innerHTML += `<label class="flex items-center p-2 hover:bg-slate-600 cursor-pointer"><input type="checkbox" data-filter-type="${filterType}" class="form-checkbox h-4 w-4 bg-slate-800 border-slate-500 rounded text-teal-500 focus:ring-teal-500" value="${cod}" ${isChecked ? 'checked' : ''}><span class="ml-2 text-xs">${cod} - ${name}</span></label>`;
            });

            if (selectedArray.length === 0 || selectedArray.length === sortedSuppliers.length) {
                filterText.textContent = 'Todos Fornecedores';
            } else if (selectedArray.length === 1) {
                filterText.textContent = suppliers.get(selectedArray[0]) || '1 selecionado';
            } else {
                filterText.textContent = `${selectedArray.length} fornecedores selecionados`;
            }
            return selectedArray;
        }

        function updateComparisonCitySuggestions(dataSource) {
            const inputValue = comparisonCityFilter.value.toLowerCase();
            const allAvailableCities = [...new Set(dataSource.map(c => c.cidade).filter(c => c && c !== 'N/A'))].sort();
            const filteredCities = inputValue ? allAvailableCities.filter(c => c.toLowerCase().includes(inputValue)) : allAvailableCities;
            if (filteredCities.length > 0 && document.activeElement === comparisonCityFilter) {
                comparisonCitySuggestions.innerHTML = filteredCities.map(c => `<div class="p-2 hover:bg-slate-600 cursor-pointer">${c}</div>`).join('');
                comparisonCitySuggestions.classList.remove('hidden');
            } else {
                comparisonCitySuggestions.classList.add('hidden');
            }
        }

        function getSundayBasedWeeks(year, month) {
            const weeks = [];
            const firstDayOfMonth = new Date(Date.UTC(year, month, 1));
            const lastDayOfMonth = new Date(Date.UTC(year, month + 1, 0));

            let startDate = new Date(firstDayOfMonth);
            startDate.setUTCHours(0, 0, 0, 0);
            startDate.setUTCDate(startDate.getUTCDate() - startDate.getUTCDay());

            while (startDate <= lastDayOfMonth) {
                let endDate = new Date(startDate);
                endDate.setUTCDate(endDate.getUTCDate() + 6);
                endDate.setUTCHours(23, 59, 59, 999);
                weeks.push({ start: new Date(startDate), end: new Date(endDate) });
                startDate.setUTCDate(startDate.getUTCDate() + 7);
            }
            return weeks;
        }

        function normalize(str) {
            return str
                ? str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').toUpperCase()
                : '';
        }

        function getPositiveClientsWithNewLogic(salesData) {
            const salesByClient = new Map();
            salesData.forEach(sale => {
                if (!sale.codcli) return;
                const clientTotal = salesByClient.get(sale.codcli) || 0;
                salesByClient.set(sale.codcli, clientTotal + sale.vlvenda);
            });

            let positiveClients = 0;
            const threshold = 1;

            for (const total of salesByClient.values()) {
                if (total > threshold) {
                    positiveClients++;
                }
            }
            return positiveClients;
        }

        const formatValue = (val, format) => {
            if (format === 'currency') return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            if (format === 'decimal') return val.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            if (format === 'mix') return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return val.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        };

        const formatAbbreviated = (val, format) => {
            let prefix = format === 'currency' ? 'R$ ' : '';
            if (val >= 1000000) {
                return prefix + (val / 1000000).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' Mi';
            } else if (val >= 1000) {
                 return prefix + (val / 1000).toLocaleString('pt-BR', { maximumFractionDigits: 0 }) + ' K';
            }
            return null;
        };

        function renderKpiCards(kpis) {
            const container = document.getElementById('comparison-kpi-container');

            container.innerHTML = kpis.map(kpi => {
                const variation = kpi.history > 0 ? ((kpi.current - kpi.history) / kpi.history) * 100 : (kpi.current > 0 ? 100 : 0);
                const colorClass = variation > 0 ? 'text-green-400' : variation < 0 ? 'text-red-400' : 'text-slate-400';

                let displayValue;
                if (kpi.title === 'Faturamento Total') {
                    displayValue = formatAbbreviated(kpi.current, kpi.format) || formatValue(kpi.current, kpi.format);
                } else {
                    displayValue = formatValue(kpi.current, kpi.format);
                }

                /* CORREÇÃO: Usa a nova classe .comparison-kpi-card para aplicar o estilo com sombra e destaque. */
                return `<div class="comparison-kpi-card">
                            <p class="text-sm">${kpi.title}</p>
                            <p class="text-2xl font-bold my-2">${displayValue}</p>
                            <p class="text-sm ${colorClass}">${variation.toFixed(2)}% vs Média do Trimestre</p>
                            <p class="text-xs">Média Trim.: ${formatValue(kpi.history, kpi.format)}</p>
                        </div>`;
            }).join('');
        }

        function calculateAverageMixComDevolucao(salesData, targetCodfors) {
             if (!salesData || salesData.length === 0 || !targetCodfors || targetCodfors.length === 0) return 0;

            const clientProductNetValue = new Map();

            for (const sale of salesData) {
                if (!targetCodfors.includes(String(sale.codfor))) continue;
                if (!sale.codcli || !sale.produto) continue;

                if (!clientProductNetValue.has(sale.codcli)) {
                    clientProductNetValue.set(sale.codcli, new Map());
                }
                const clientProducts = clientProductNetValue.get(sale.codcli);

                const currentValue = clientProducts.get(sale.produto) || 0;
                clientProducts.set(sale.produto, currentValue + (Number(sale.vlvenda) || 0));
            }

            const mixValues = [];
            for (const products of clientProductNetValue.values()) {
                let positiveProductCount = 0;
                for (const netValue of products.values()) {
                    if (netValue > 1) {
                        positiveProductCount++;
                    }
                }
                if (positiveProductCount > 0) {
                    mixValues.push(positiveProductCount);
                }
            }

            if (mixValues.length === 0) return 0;

            return mixValues.reduce((a, b) => a + b, 0) / mixValues.length;
        }

        function calculatePositivacaoPorCestaComDevolucao(salesData, requiredCategories) {
            if (!salesData || salesData.length === 0 || !requiredCategories || requiredCategories.length === 0) return 0;

            const normalizedCategories = requiredCategories.map(normalize);
            const clientProductNetSales = new Map();

            for (const sale of salesData) {
                if (!sale.codcli || !sale.produto) continue;

                if (!clientProductNetSales.has(sale.codcli)) {
                    clientProductNetSales.set(sale.codcli, new Map());
                }
                const clientProducts = clientProductNetSales.get(sale.codcli);

                if (!clientProducts.has(sale.produto)) {
                    clientProducts.set(sale.produto, { netValue: 0, description: sale.descricao });
                }
                const productData = clientProducts.get(sale.produto);
                productData.netValue += (Number(sale.vlvenda) || 0);
            }

            const clientPurchasedCategories = new Map();

            for (const [codcli, products] of clientProductNetSales.entries()) {
                for (const data of products.values()) {
                    if (data.netValue > 1) {
                        const normalizedDescription = normalize(data.description);
                        for (const category of normalizedCategories) {
                            if (normalizedDescription.includes(category)) {
                                if (!clientPurchasedCategories.has(codcli)) {
                                    clientPurchasedCategories.set(codcli, new Set());
                                }
                                clientPurchasedCategories.get(codcli).add(category);
                                break;
                            }
                        }
                    }
                }
            }

            let positivadosCount = 0;
            const requiredCategoryCount = normalizedCategories.length;
            for (const categoriesPurchased of clientPurchasedCategories.values()) {
                if (categoriesPurchased.size >= requiredCategoryCount) {
                    positivadosCount++;
                }
            }

            return positivadosCount;
        }


        function groupSalesByMonth(salesData) {
            const salesByMonth = {};
            salesData.forEach(sale => {
                const date = parseDate(sale.dtped);
                if (!date || isNaN(date.getTime())) return;
                // Use UTC methods to create a reliable month key
                const monthKey = date.getUTCFullYear() + '-' + String(date.getUTCMonth() + 1).padStart(2, '0');
                if (!salesByMonth[monthKey]) salesByMonth[monthKey] = [];
                salesByMonth[monthKey].push(sale);
            });
            return salesByMonth;
        }

        function monthlyKpiAverage(historySales, kpiFn, ...kpiArgs) {
            const salesByMonth = groupSalesByMonth(historySales);
            const kpiValues = Object.values(salesByMonth).map(sales => kpiFn(sales, ...kpiArgs));
            if (kpiValues.length === 0) return 0;
            return kpiValues.reduce((a, b) => a + b, 0) / kpiValues.length;
        }

        function getComparisonFilteredData(options = {}) {
            const { excludeFilter = null } = options;

            let clients = [...allClientsData];
            if (comparisonRedeGroupFilter === 'com_rede') {
                clients = clients.filter(c => c.ramo && c.ramo !== 'N/A');
                 if (selectedComparisonRedes.length > 0) {
                    clients = clients.filter(c => selectedComparisonRedes.includes(c.ramo));
                }
            } else if (comparisonRedeGroupFilter === 'sem_rede') {
                clients = clients.filter(c => !c.ramo || c.ramo === 'N/A');
            }
            const clientCodes = new Set(clients.map(c => c['codigo_cliente']));

            const supervisor = comparisonSupervisorFilter.value;
            const sellers = selectedComparisonSellers;
            const suppliers = selectedComparisonSuppliers;
            const products = selectedComparisonProducts;
            const pasta = currentComparisonFornecedor;
            const city = comparisonCityFilter.value.trim();
            const filial = comparisonFilialFilter.value;

            const commonFilter = s =>
                (filial === 'ambas' || s.filial === filial) &&
                (excludeFilter === 'supervisor' || !supervisor || s.superv === supervisor) &&
                (excludeFilter === 'seller' || sellers.length === 0 || sellers.includes(s.nome)) &&
                (excludeFilter === 'supplier' || suppliers.length === 0 || suppliers.includes(String(s.codfor))) &&
                (excludeFilter === 'product' || products.length === 0 || products.includes(String(s.produto))) &&
                (excludeFilter === 'pasta' || !pasta || s.observacaofor === pasta) &&
                (excludeFilter === 'city' || !city || (s.cidade && s.cidade.toLowerCase() === city.toLowerCase()));

            const currentSalesFilter = s => clientCodes.has(s.codcli) && commonFilter(s);

            let filteredHistory = allHistoryData.filter(commonFilter);
            if (comparisonRedeGroupFilter) {
                 filteredHistory = filteredHistory.filter(s => clientCodes.has(s.codcli));
            }

            return {
                currentSales: allSalesData.filter(currentSalesFilter),
                historySales: filteredHistory
            };
        }


        function updateAllComparisonFilters() {
            const { currentSales: supervisorCurrent, historySales: supervisorHistory } = getComparisonFilteredData({ excludeFilter: 'supervisor' });
            const supervisorOptionsData = [...supervisorCurrent, ...supervisorHistory];
            const currentSupervisor = comparisonSupervisorFilter.value;
            populateSupervisors('comparison-supervisor-filter', supervisorOptionsData);
            if ([...comparisonSupervisorFilter.options].some(o => o.value === currentSupervisor)) {
                comparisonSupervisorFilter.value = currentSupervisor;
            }

            const { currentSales: sellerCurrent, historySales: sellerHistory } = getComparisonFilteredData({ excludeFilter: 'seller' });
            const sellerOptionsData = [...sellerCurrent, ...sellerHistory];
            selectedComparisonSellers = updateSellerFilter(comparisonSupervisorFilter.value, comparisonVendedorFilterDropdown, comparisonVendedorFilterText, selectedComparisonSellers, sellerOptionsData);

            const { currentSales: supplierCurrent, historySales: supplierHistory } = getComparisonFilteredData({ excludeFilter: 'supplier' });
            const supplierOptionsData = [...supplierCurrent, ...supplierHistory];
            selectedComparisonSuppliers = updateSupplierFilter(comparisonSupplierFilterDropdown, comparisonSupplierFilterText, selectedComparisonSuppliers, supplierOptionsData, 'comparison');

            updateComparisonProductFilter();

            const { currentSales: cityCurrent, historySales: cityHistory } = getComparisonFilteredData({ excludeFilter: 'city' });
            const cityOptionsData = [...cityCurrent, ...cityHistory];
            updateComparisonCitySuggestions(cityOptionsData);

            const { currentSales: pastaCurrent, historySales: pastaHistory } = getComparisonFilteredData({ excludeFilter: 'pasta' });
            const pastaOptionsData = [...pastaCurrent, ...pastaHistory];
            const pepsicoBtn = document.querySelector('#comparison-fornecedor-toggle-container button[data-fornecedor="PEPSICO"]');
            const multimarcasBtn = document.querySelector('#comparison-fornecedor-toggle-container button[data-fornecedor="MULTIMARCAS"]');
            const hasPepsico = pastaOptionsData.some(s => s.observacaofor === 'PEPSICO');
            const hasMultimarcas = pastaOptionsData.some(s => s.observacaofor === 'MULTIMARCAS');
            pepsicoBtn.disabled = !hasPepsico;
            multimarcasBtn.disabled = !hasMultimarcas;
            pepsicoBtn.classList.toggle('opacity-50', !hasPepsico);
            multimarcasBtn.classList.toggle('opacity-50', !hasMultimarcas);
        }

        function updateProductFilter(dropdown, filterText, selectedArray, dataSource, filterType = 'comparison') {
            const searchInput = dropdown.querySelector('input[type="text"]');
            const listContainer = dropdown.querySelector('div[id$="-list"]');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';

            const products = [...new Map(dataSource.map(s => [s.produto, s.descricao])).entries()].sort((a,b) => a[1].localeCompare(b[1]));

            const filteredProducts = searchTerm.length > 0
                ? products.filter(([code, name]) =>
                    name.toLowerCase().includes(searchTerm) || code.toLowerCase().includes(searchTerm)
                  )
                : products;

            listContainer.innerHTML = '';
            filteredProducts.forEach(([code, name]) => {
                const isChecked = selectedArray.includes(code);
                listContainer.innerHTML += `
                    <label class="flex items-center p-2 hover:bg-slate-600 cursor-pointer">
                        <input type="checkbox" data-filter-type="${filterType}" class="form-checkbox h-4 w-4 bg-slate-800 border-slate-500 rounded text-teal-500 focus:ring-teal-500" value="${code}" ${isChecked ? 'checked' : ''}>
                        <span class="ml-2 text-xs">(${code}) ${name}</span>
                    </label>`;
            });

            if (selectedArray.length === 0) {
                filterText.textContent = 'Todos os Produtos';
            } else if (selectedArray.length === 1) {
                const productsInfo = new Map(products);
                filterText.textContent = productsInfo.get(selectedArray[0]) || '1 selecionado';
            } else {
                filterText.textContent = `${selectedArray.length} produtos selecionados`;
            }
        }

        function updateComparisonProductFilter() {
            const { currentSales, historySales } = getComparisonFilteredData({ excludeFilter: 'product' });
            updateProductFilter(comparisonProductFilterDropdown, comparisonProductFilterText, selectedComparisonProducts, [...currentSales, ...historySales], 'comparison');
        }

        function updateStockProductFilter() {
            const data = getStockFilteredData({excludeFilter: 'product'});
            updateProductFilter(stockProductFilterDropdown, stockProductFilterText, selectedStockProducts, [...data.sales, ...data.history], 'stock');
        }

        function updateStockSupplierFilter() {
            const data = getStockFilteredData({excludeFilter: 'supplier'});
            selectedStockSuppliers = updateSupplierFilter(stockSupplierFilterDropdown, stockSupplierFilterText, selectedStockSuppliers, [...data.sales, ...data.history], 'stock');
        }

        function updateStockSellerFilter() {
            const data = getStockFilteredData({excludeFilter: 'seller'});
            selectedStockSellers = updateSellerFilter(stockSupervisorFilter.value, stockVendedorFilterDropdown, stockVendedorFilterText, selectedStockSellers, [...data.sales, ...data.history]);
        }

        function updateStockCitySuggestions(dataSource) {
            const inputValue = stockCityFilter.value.toLowerCase();
            const allAvailableCities = [...new Set(dataSource.map(c => c.cidade).filter(c => c && c !== 'N/A'))].sort();
            const filteredCities = inputValue ? allAvailableCities.filter(c => c.toLowerCase().includes(inputValue)) : allAvailableCities;
            if (filteredCities.length > 0 && document.activeElement === stockCityFilter) {
                stockCitySuggestions.innerHTML = filteredCities.map(c => `<div class="p-2 hover:bg-slate-600 cursor-pointer">${c}</div>`).join('');
                stockCitySuggestions.classList.remove('hidden');
            } else {
                stockCitySuggestions.classList.add('hidden');
            }
        }

        function getActiveStockMap(filial) {
            const filterValue = filial || stockFilialFilter.value;
            if (filterValue === '05') {
                return stockData05;
            }
            if (filterValue === '08') {
                return stockData08;
            }
            const combinedStock = new Map(stockData05);
            stockData08.forEach((qty, code) => {
                combinedStock.set(code, (combinedStock.get(code) || 0) + qty);
            });
            return combinedStock;
        }

        function getStockFilteredData(options = {}) {
            const { excludeFilter = null } = options;

            let clients = [...allClientsData];
            if (excludeFilter !== 'rede') {
                if (stockRedeGroupFilter === 'com_rede') {
                    clients = clients.filter(c => c.ramo && c.ramo !== 'N/A');
                     if (selectedStockRedes.length > 0) {
                        clients = clients.filter(c => selectedStockRedes.includes(c.ramo));
                    }
                } else if (stockRedeGroupFilter === 'sem_rede') {
                    clients = clients.filter(c => !c.ramo || c.ramo === 'N/A');
                }
            }
            const clientCodes = new Set(clients.map(c => c['codigo_cliente']));

            const supervisor = stockSupervisorFilter.value;
            const sellers = selectedStockSellers;
            const suppliers = selectedStockSuppliers;
            const products = selectedStockProducts;
            const pasta = currentStockFornecedor;
            const city = stockCityFilter.value.trim();
            const filial = stockFilialFilter.value;

            const filterFunction = s =>
                (clientCodes.has(s.codcli)) &&
                (filial === 'ambas' || s.filial === filial) &&
                (excludeFilter === 'supervisor' || !supervisor || s.superv === supervisor) &&
                (excludeFilter === 'seller' || sellers.length === 0 || sellers.includes(s.nome)) &&
                (excludeFilter === 'supplier' || suppliers.length === 0 || suppliers.includes(String(s.codfor))) &&
                (excludeFilter === 'product' || products.length === 0 || products.includes(String(s.produto))) &&
                (excludeFilter === 'pasta' || !pasta || s.observacaofor === pasta) &&
                (excludeFilter === 'city' || !city || (s.cidade && s.cidade.toLowerCase() === city.toLowerCase()));

            return {
                sales: allSalesData.filter(filterFunction),
                history: allHistoryData.filter(filterFunction)
            };
        }

        function handleStockFilterChange() {
            const supervisorData = getStockFilteredData({ excludeFilter: 'supervisor' });
            const supervisorOptionsData = [...supervisorData.sales, ...supervisorData.history];
            populateSupervisors('stock-supervisor-filter', supervisorOptionsData);

            updateStockSellerFilter();
            updateStockSupplierFilter();
            updateStockProductFilter();

            const cityData = getStockFilteredData({ excludeFilter: 'city' });
            updateStockCitySuggestions([...cityData.sales, ...cityData.history]);

            const pastaData = getStockFilteredData({ excludeFilter: 'pasta' });
            const pastaOptionsData = [...pastaData.sales, ...pastaData.history];
            const pepsicoBtn = document.querySelector('#stock-fornecedor-toggle-container button[data-fornecedor="PEPSICO"]');
            const multimarcasBtn = document.querySelector('#stock-fornecedor-toggle-container button[data-fornecedor="MULTIMARCAS"]');
            const hasPepsico = pastaOptionsData.some(s => s.observacaofor === 'PEPSICO');
            const hasMultimarcas = pastaOptionsData.some(s => s.observacaofor === 'MULTIMARCAS');
            pepsicoBtn.disabled = !hasPepsico;
            multimarcasBtn.disabled = !hasMultimarcas;
            pepsicoBtn.classList.toggle('opacity-50', !hasPepsico);
            multimarcasBtn.classList.toggle('opacity-50', !hasMultimarcas);

            updateStockView();
        }

        function updateComparisonView() {
            const getRevenue = (sale) => (sale.tipovenda === '1' || sale.tipovenda === '9') ? sale.vlvenda : 0;

            const filteredData = getComparisonFilteredData();
            const { currentSales, historySales } = filteredData;

            const historyMonthsCount = getUniqueMonthCount(historySales);

            const currentTotalFat = currentSales.reduce((sum, item) => sum + getRevenue(item), 0);
            const currentTotalPeso = currentSales.reduce((sum, item) => sum + item.totpesoliq, 0);
            const currentClients = getPositiveClientsWithNewLogic(currentSales);
            const currentTicket = currentClients > 0 ? currentTotalFat / currentClients : 0;
            const pepsicoCodfors = ['707', '708'];
            const saltyCategories = ['CHEETOS', 'DORITOS', 'FANDANGOS', 'RUFFLES', 'TORCIDA'];
            const foodsCategories = ['TODDYNHO', 'TODDY', 'QUAKER', 'KEROCOCO'];
            const currentMixPepsico = calculateAverageMixComDevolucao(currentSales, pepsicoCodfors);
            const currentPositivacaoSalty = calculatePositivacaoPorCestaComDevolucao(currentSales, saltyCategories);
            const currentPositivacaoFoods = calculatePositivacaoPorCestaComDevolucao(currentSales, foodsCategories);

            const historyAvgFat = monthlyKpiAverage(historySales, (sales) => sales.reduce((sum, item) => sum + getRevenue(item), 0));
            const historyAvgPeso = monthlyKpiAverage(historySales, (sales) => sales.reduce((sum, item) => sum + item.totpesoliq, 0)) / 1000;

            const historyClientsAverage = monthlyKpiAverage(historySales, getPositiveClientsWithNewLogic);
            const historyTicketAverage = historyClientsAverage > 0 ? historyAvgFat / historyClientsAverage : 0;
            const historyMixPepsico = monthlyKpiAverage(historySales, calculateAverageMixComDevolucao, pepsicoCodfors);
            const historyPositivacaoSalty = monthlyKpiAverage(historySales, calculatePositivacaoPorCestaComDevolucao, saltyCategories);
            const historyPositivacaoFoods = monthlyKpiAverage(historySales, calculatePositivacaoPorCestaComDevolucao, foodsCategories);

            renderKpiCards([
                { title: 'Faturamento Total', current: currentTotalFat, history: historyAvgFat, format: 'currency' },
                { title: 'Peso Total (Ton)', current: currentTotalPeso / 1000, history: historyAvgPeso, format: 'decimal' },
                { title: 'Clientes Atendidos', current: currentClients, history: historyClientsAverage, format: 'integer' },
                { title: 'Ticket Médio', current: currentTicket, history: historyTicketAverage, format: 'currency' },
                { title: 'Mix por PDV (Pepsico)', current: currentMixPepsico, history: historyMixPepsico, format: 'mix' },
                { title: 'Mix Salty', current: currentPositivacaoSalty, history: historyPositivacaoSalty, format: 'integer' },
                { title: 'Mix Foods', current: currentPositivacaoFoods, history: historyPositivacaoFoods, format: 'integer' }
            ]);

            const currentYear = lastSaleDate.getFullYear();
            const currentMonth = lastSaleDate.getMonth();
            let currentMonthWeeks = getSundayBasedWeeks(currentYear, currentMonth);

            let excludeLastWeek = false;
            if (currentMonthWeeks.length > 0) {
                const lastWeek = currentMonthWeeks[currentMonthWeeks.length - 1];
                const lastWeekStartDate = lastWeek.start;
                const startDay = lastWeekStartDate.getDay();

                let daysInCurrentMonth = 0;
                let tempDate = new Date(lastWeek.start);
                while (tempDate <= lastWeek.end) {
                    if (tempDate.getMonth() === currentMonth) {
                        daysInCurrentMonth++;
                    }
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                if ((startDay === 0 || startDay === 6) && daysInCurrentMonth <= 2) {
                    excludeLastWeek = true;
                }
            }

            if (excludeLastWeek) {
                currentMonthWeeks.pop();
            }

            let salesForWeeklyCharts = [...currentSales];
            if (currentMonthWeeks.length > 0) {
                const firstWeekStartDate = currentMonthWeeks[0].start;
                if (firstWeekStartDate.getMonth() < currentMonth || firstWeekStartDate.getFullYear() < currentYear) {
                    const endOfPreviousMonth = new Date(currentYear, currentMonth, 0);
                    const relevantHistory = historySales.filter(s => {
                        const d = parseDate(s.dtped);
                        return d >= firstWeekStartDate && d <= endOfPreviousMonth;
                    });
                    salesForWeeklyCharts.push(...relevantHistory);
                }
            }


            let currentSalesByWeek = new Array(currentMonthWeeks.length).fill(0);
            salesForWeeklyCharts.forEach(sale => {
                const saleDate = parseDate(sale.dtped);
                if (!saleDate) return;
                const weekIndex = currentMonthWeeks.findIndex(week => saleDate >= week.start && saleDate <= week.end);
                if (weekIndex !== -1) {
                     currentSalesByWeek[weekIndex] += getRevenue(sale);
                }
            });

            const historySalesByWeekIndex = {};
            historySales.forEach(sale => {
                const saleDate = parseDate(sale.dtped);
                if (!saleDate) return;
                const saleYear = saleDate.getFullYear();
                const saleMonth = saleDate.getMonth();
                const monthKey = `${saleYear}-${saleMonth}`;
                const monthWeeks = getSundayBasedWeeks(saleYear, saleMonth);
                const weekIndex = monthWeeks.findIndex(week => saleDate >= week.start && saleDate <= week.end);
                if (weekIndex !== -1) {
                    if (!historySalesByWeekIndex[weekIndex]) historySalesByWeekIndex[weekIndex] = {};
                    if (!historySalesByWeekIndex[weekIndex][monthKey]) historySalesByWeekIndex[weekIndex][monthKey] = 0;
                    historySalesByWeekIndex[weekIndex][monthKey] += getRevenue(sale);
                }
            });

            const historyAvgSalesByWeek = new Array(currentMonthWeeks.length).fill(0);
            for (let i = 0; i < currentMonthWeeks.length; i++) {
                const weekDataByMonth = historySalesByWeekIndex[i] || {};
                const weeklyTotals = Object.values(weekDataByMonth);
                if (weeklyTotals.length > 0) {
                    const totalSum = weeklyTotals.reduce((a, b) => a + b, 0);
                    const divisor = Math.max(historyMonthsCount, 1);
                    historyAvgSalesByWeek[i] = totalSum / divisor;
                }
            }

            if (useTendencyComparison) {
                const today = lastSaleDate;
                const currentWeekIndex = currentMonthWeeks.findIndex(w => today >= w.start && today <= w.end);

                for (let i = 0; i < currentMonthWeeks.length; i++) {
                    if (i < currentWeekIndex) {
                        continue;
                    } else if (i === currentWeekIndex) {
                        const currentWeek = currentMonthWeeks[currentWeekIndex];
                        const salesThisWeekSoFar = salesForWeeklyCharts.filter(s => {
                            const d = parseDate(s.dtped);
                            return d >= currentWeek.start && d <= today;
                        });
                        const totalSoldThisWeek = salesThisWeekSoFar.reduce((sum, s) => sum + getRevenue(s), 0);

                        let workingDaysPassed = 0;
                        let totalWorkingDays = 0;
                        for (let d = new Date(currentWeek.start); d <= currentWeek.end; d.setDate(d.getDate() + 1)) {
                            const dayOfWeek = d.getDay();
                            if (dayOfWeek >= 1 && dayOfWeek <= 5 && !isHoliday(d, selectedHolidays)) {
                                totalWorkingDays++;
                                if (d <= today) {
                                    workingDaysPassed++;
                                }
                            }
                        }

                        if (workingDaysPassed > 0 && totalWorkingDays > 0) {
                            const dailyAverage = totalSoldThisWeek / workingDaysPassed;
                            currentSalesByWeek[i] = dailyAverage * totalWorkingDays;
                        } else {
                            currentSalesByWeek[i] = historyAvgSalesByWeek[i] || 0;
                        }
                    } else {
                        currentSalesByWeek[i] = historyAvgSalesByWeek[i] || 0;
                    }
                }
            }

            if (comparisonChartType === 'weekly') {
                monthlyComparisonChartContainer.classList.add('hidden');
                weeklyComparisonChartContainer.classList.remove('hidden');
                comparisonChartTitle.textContent = 'Comparativo de Faturamento Semanal';
                const weekLabels = currentMonthWeeks.map((w, i) => `Semana ${i + 1}`);

                createChart('weeklyComparisonChart', 'line', weekLabels, [
                    { label: useTendencyComparison ? 'Tendência Semanal' : 'Mês Atual', data: currentSalesByWeek, borderColor: 'var(--bg-button-active)', tension: 0.2, pointRadius: 5, pointBackgroundColor: 'var(--bg-button-active)', borderWidth: 2.5 },
                    { label: 'Média Trimestre', data: historyAvgSalesByWeek, borderColor: '#f97316', tension: 0.2, pointRadius: 5, pointBackgroundColor: '#f97316', borderWidth: 2.5 }
                ], {
                    plugins: {
                        legend: { display: true, position: 'top', align: 'end' }
                    },
                    layout: { padding: { bottom: 0 } }
                });

            } else if (comparisonChartType === 'monthly') {
                weeklyComparisonChartContainer.classList.add('hidden');
                monthlyComparisonChartContainer.classList.remove('hidden');
                comparisonChartTitle.textContent = 'Comparativo de Faturamento Mensal';

                let monthlyCurrentSales = currentSales;
                if (useTendencyComparison) {
                    const totalDays = getWorkingDaysInMonth(currentYear, currentMonth, selectedHolidays);
                    const passedDays = getPassedWorkingDaysInMonth(currentYear, currentMonth, selectedHolidays, lastSaleDate);

                    if (totalDays > 0 && passedDays > 0 && passedDays <= totalDays) {
                        const projectionFactor = totalDays / passedDays;
                        const currentTotal = monthlyCurrentSales.reduce((sum, item) => sum + getRevenue(item), 0);
                        const projectedTotal = currentTotal * projectionFactor;

                        monthlyCurrentSales = [{ vlvenda: projectedTotal, dtped: new Date(), tipovenda: '1' }]; // Assume tipovenda '1' for projection
                    }
                }
                const monthlyCurrentTotalFat = monthlyCurrentSales.reduce((sum, item) => sum + getRevenue(item), 0);

                const salesByMonth = {};
                historySales.forEach(sale => {
                    const saleDate = parseDate(sale.dtped);
                    if (!saleDate) return;
                    const monthKey = `${saleDate.getUTCFullYear()}-${String(saleDate.getUTCMonth() + 1).padStart(2, '0')}`;
                    salesByMonth[monthKey] = (salesByMonth[monthKey] || 0) + getRevenue(sale);
                });

                const sortedMonths = Object.keys(salesByMonth).sort();
                const monthLabels = sortedMonths.map(monthKey => {
                    const [year, month] = monthKey.split('-');
                    return new Date(parseInt(year), parseInt(month) - 1, 1).toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                });
                const monthValues = sortedMonths.map(monthKey => salesByMonth[monthKey]);

                let currentMonthLabel = 'Mês Atual';
                if (currentSales.length > 0) {
                    const firstSaleDate = parseDate(currentSales[0].dtped) || new Date();
                    currentMonthLabel = firstSaleDate.toLocaleString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' });
                }

                const existingIndex = monthLabels.indexOf(currentMonthLabel);
                if (existingIndex !== -1) {
                    monthValues[existingIndex] = monthlyCurrentTotalFat;
                } else {
                    monthLabels.push(currentMonthLabel);
                    monthValues.push(monthlyCurrentTotalFat);
                }

                createChart('monthlyComparisonChart', 'bar', monthLabels, [{
                    label: 'Faturamento Mensal',
                    data: monthValues,
                    backgroundColor: 'rgba(20, 184, 166, 0.7)',
                    borderColor: '#14b8a6',
                    borderWidth: 2
                }], {
                    layout: { padding: { top: 20 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: { weight: 'bold' },
                            formatter: (value) => {
                                if (value >= 1000000) return 'R$ ' + (value / 1000000).toFixed(2) + ' M';
                                return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                            }
                        }
                    }
                });
            }

            const salesByWeekAndDay = {};
            currentMonthWeeks.forEach((w, i) => {
                salesByWeekAndDay[i + 1] = new Array(7).fill(0);
            });

            salesForWeeklyCharts.forEach(sale => {
                const saleDate = parseDate(sale.dtped);
                if (!saleDate) return;
                const weekIndex = currentMonthWeeks.findIndex(week => saleDate >= week.start && saleDate <= week.end);
                if (weekIndex !== -1) {
                    const dayOfWeek = saleDate.getDay();
                    salesByWeekAndDay[weekIndex + 1][dayOfWeek] += getRevenue(sale);
                }
            });

            if (useTendencyComparison) {
                const today = lastSaleDate;
                const currentWeekIndex = currentMonthWeeks.findIndex(w => today >= w.start && today <= w.end);

                const historicalDayWeights = {};
                const salesByWeekDayMonth = {};

                historySales.forEach(sale => {
                    const d = parseDate(sale.dtped);
                    if (!d) return;
                    const monthKey = `${d.getFullYear()}-${d.getMonth()}`;
                    const monthWeeks = getSundayBasedWeeks(d.getFullYear(), d.getMonth());
                    const weekIndex = monthWeeks.findIndex(w => d >= w.start && d <= w.end);
                    if (weekIndex !== -1) {
                        if (!salesByWeekDayMonth[monthKey]) salesByWeekDayMonth[monthKey] = {};
                        if (!salesByWeekDayMonth[monthKey][weekIndex]) salesByWeekDayMonth[monthKey][weekIndex] = new Array(7).fill(0);
                        salesByWeekDayMonth[monthKey][weekIndex][d.getDay()] += getRevenue(sale);
                    }
                });

                for (let i = 0; i < currentMonthWeeks.length; i++) {
                    const totalsByDay = new Array(7).fill(0);
                    let monthCount = 0;
                    for (const monthKey in salesByWeekDayMonth) {
                        if (salesByWeekDayMonth[monthKey][i]) {
                            monthCount++;
                            for (let day = 0; day < 7; day++) {
                                totalsByDay[day] += salesByWeekDayMonth[monthKey][i][day] || 0;
                            }
                        }
                    }

                    const weeklyTotal = totalsByDay.reduce((a, b) => a + b, 0);
                    if (weeklyTotal > 0) {
                        historicalDayWeights[i] = totalsByDay.map(dayTotal => dayTotal / weeklyTotal);
                    } else {
                        historicalDayWeights[i] = [0, 0.2, 0.2, 0.2, 0.2, 0.2, 0];
                    }
                }

                for (let i = currentWeekIndex + 1; i < currentMonthWeeks.length; i++) {
                    const projectedTotalForWeek = currentSalesByWeek[i];
                    const weights = historicalDayWeights[i];
                    for (let day = 0; day < 7; day++) {
                        salesByWeekAndDay[i + 1][day] = projectedTotalForWeek * weights[day];
                    }
                }

                if (currentWeekIndex !== -1) {
                    const week = currentMonthWeeks[currentWeekIndex];
                    const soldInCurrentWeek = Object.values(salesByWeekAndDay[currentWeekIndex + 1]).reduce((a, b) => a + b, 0);
                    const projectedTotalForCurrentWeek = currentSalesByWeek[currentWeekIndex];
                    const remainingToSell = projectedTotalForCurrentWeek - soldInCurrentWeek;

                    let futureDayWeights = [];
                    let totalFutureWeight = 0;
                    for (let d = new Date(week.start); d <= week.end; d.setDate(d.getDate() + 1)) {
                        if (d > today) {
                            const dayIndex = d.getDay();
                            const weight = historicalDayWeights[currentWeekIndex][dayIndex];
                            futureDayWeights.push({ day: dayIndex, weight: weight });
                            totalFutureWeight += weight;
                        }
                    }

                    if (totalFutureWeight > 0 && remainingToSell > 0) {
                        futureDayWeights.forEach(item => {
                            const distributedAmount = (item.weight / totalFutureWeight) * remainingToSell;
                            salesByWeekAndDay[currentWeekIndex + 1][item.day] = distributedAmount;
                        });
                    }
                }
            }

            const dayNames = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const professionalPalette = ['#a855f7', '#6366f1', '#ec4899', '#f97316', '#8b5cf6', '#06b6d4', '#f59e0b'];
            const dailyBreakdownDatasets = dayNames.map((dayName, dayIndex) => {
                return {
                    label: dayName,
                    data: currentMonthWeeks.map((week, weekIndex) => salesByWeekAndDay[weekIndex + 1][dayIndex]),
                    backgroundColor: professionalPalette[dayIndex % professionalPalette.length],
                };
            });

            const weekLabelsForDailyChart = currentMonthWeeks.map((week, index) => {
                const startDateStr = week.start.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                const endDateStr = week.end.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                return `S${index + 1} (${startDateStr} à ${endDateStr})`;
            });

            if (dailyBreakdownDatasets.some(ds => ds.data.some(d => d > 0))) {
                createChart('dailyWeeklyComparisonChart', 'bar', weekLabelsForDailyChart, dailyBreakdownDatasets, {
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            mode: 'point',
                            intersect: true
                        },
                        datalabels: { display: false }
                    },
                    scales: {
                        x: { stacked: false },
                        y: { stacked: false, ticks: { callback: (v) => (v / 1000).toFixed(0) + 'k' } }
                    }
                });
            } else {
                showNoDataMessage('dailyWeeklyComparisonChart', 'Sem dados para exibir.');
            }

            const supervisorComparison = {};
            const activeSupervisors = [...new Set(allSalesData.map(s => s.superv))].filter(Boolean);
            activeSupervisors.forEach(sup => supervisorComparison[sup] = { current: 0, history: 0 });
            currentSales.forEach(s => { if(s.superv && supervisorComparison[s.superv]) supervisorComparison[s.superv].current += getRevenue(s); });

            // CORREÇÃO: Calcula a média histórica por supervisor usando a função 'monthlyKpiAverage'
            Object.keys(supervisorComparison).forEach(sup => {
                const supervisorHistorySales = historySales.filter(s => s.superv === sup);
                supervisorComparison[sup].history = monthlyKpiAverage(supervisorHistorySales, (sales) => sales.reduce((sum, item) => sum + getRevenue(item), 0));
            });

            const supervisorTableBody = document.getElementById('supervisorComparisonTableBody');
            supervisorTableBody.innerHTML = Object.entries(supervisorComparison).map(([sup, data]) => { const variation = data.history > 0 ? ((data.current - data.history) / data.history) * 100 : (data.current > 0 ? 100 : 0); const colorClass = variation > 0 ? 'text-green-400' : variation < 0 ? 'text-red-400' : 'text-slate-400'; return `<tr><td class="px-4 py-2">${sup}</td><td class="px-4 py-2 text-right">${data.history.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="px-4 py-2 text-right">${data.current.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td><td class="px-4 py-2 text-right ${colorClass}">${variation.toFixed(2)}%</td></tr>`; }).join('');
        }

        function updateStockView() {
            const { sales: filteredSales, history: filteredHistory } = getStockFilteredData();
            const allCombinedSales = [...filteredSales, ...filteredHistory];

            const filial = stockFilialFilter.value;
            const activeStockMap = getActiveStockMap(filial);

            const selectedSuppliers = selectedStockSuppliers;
            const selectedProducts = selectedStockProducts;
            const currentPasta = currentStockFornecedor;

            const productAnalysis = new Map();

            const productsWithFilteredActivity = new Set();
            allCombinedSales.forEach(s => productsWithFilteredActivity.add(s.produto));

            activeStockMap.forEach((qty, productCode) => {
                if (qty > 0) {
                    const details = productDetailsMap.get(productCode);
                    if (!details) return;

                    if (selectedSuppliers.length > 0 && !selectedSuppliers.includes(String(details.codfor))) {
                        return; 
                    }
                    if (selectedProducts.length > 0 && !selectedProducts.includes(String(productCode))) {
                        return; 
                    }
                    if (currentPasta) {
                        const pastaDoProduto = optimizedData.productPastaMap.get(productCode) || '';
                        if (pastaDoProduto !== currentPasta) {
                             return; 
                        }
                    }
                    
                    productsWithFilteredActivity.add(productCode);
                }
            });
            
            productsWithFilteredActivity.forEach(productCode => {
                if (!activeProductCodesFromCadastro.has(productCode)) return;

                const details = productDetailsMap.get(productCode) || {
                    descricao: `Produto ${productCode}`,
                    fornecedor: 'N/A',
                    codfor: 'N/A'
                };

                const stock = activeStockMap.get(productCode) || 0;
                const productAllSales = allCombinedSales.filter(s => s.produto === productCode);
                const totalQtySold = productAllSales.reduce((sum, s) => sum + s.qtvenda_embalagem_master, 0);

                if (stock <= 0 && totalQtySold <= 0) return;

                const productHistorySales = filteredHistory.filter(s => s.produto === productCode);
                const productCurrentSales = filteredSales.filter(s => s.produto === productCode);
                const currentMonthSalesQty = productCurrentSales.reduce((sum, s) => sum + s.qtvenda_embalagem_master, 0);

                const productCadastroDate = parseDate(details.dtcadastro);
                let productFirstWorkingDayIndex = 0;
                
                if (productCadastroDate) {
                    const cadastroDateString = productCadastroDate.toISOString().split('T')[0];
                    productFirstWorkingDayIndex = sortedWorkingDays.findIndex(d => d >= cadastroDateString);
                    if (productFirstWorkingDayIndex === -1) {
                        productFirstWorkingDayIndex = sortedWorkingDays.length; 
                    }
                }
                
                const productMaxLifeInWorkingDays = sortedWorkingDays.length - productFirstWorkingDayIndex;

                const daysFromBox = customWorkingDaysStock;

                let effectiveDaysToCalculate;
                
                const isFactuallyNewOrReactivated = (productHistorySales.length === 0 && productCurrentSales.length > 0);

                if (isFactuallyNewOrReactivated) {
                    const daysToConsider = (daysFromBox > 0) ? daysFromBox : passedWorkingDaysCurrentMonth;
                    effectiveDaysToCalculate = Math.min(passedWorkingDaysCurrentMonth, daysToConsider);
                } else {
                    if (daysFromBox > 0) {
                        effectiveDaysToCalculate = Math.min(daysFromBox, productMaxLifeInWorkingDays);
                } else {
                        effectiveDaysToCalculate = productMaxLifeInWorkingDays; 
                    }
                }
                
                const daysDivisor = effectiveDaysToCalculate > 0 ? effectiveDaysToCalculate : 1;
                
                const endDate = parseDate(sortedWorkingDays[sortedWorkingDays.length - 1]);
                const targetIndex = Math.max(0, sortedWorkingDays.length - daysDivisor); 
                const startDate = parseDate(sortedWorkingDays[targetIndex]);
                
                let totalQtySoldInRange = 0;
                productAllSales.forEach(sale => {
                    const saleDate = parseDate(sale.dtped);
                    if (saleDate && saleDate >= startDate && saleDate <= endDate) {
                        totalQtySoldInRange += sale.qtvenda_embalagem_master;
                    }
                });

                let dailyAvgSale = totalQtySoldInRange / daysDivisor;

                const isNew = productMaxLifeInWorkingDays <= passedWorkingDaysCurrentMonth;

                const trendDays = dailyAvgSale > 0 ? (stock / dailyAvgSale) : Infinity;
                const monthlyAvgSale = monthlyKpiAverage(productHistorySales, (sales) => sales.reduce((sum, s) => sum + s.qtvenda_embalagem_master, 0));


                productAnalysis.set(productCode, {
                    code: productCode,
                    ...details,
                    stock,
                    monthlyAvgSale,
                    dailyAvgSale,
                    trendDays,
                    currentMonthSalesQty,
                    isNew,
                    hasHistory: productHistorySales.length > 0,
                    soldThisMonth: currentMonthSalesQty > 0
                });
            });


            let sortedAnalysis = [...productAnalysis.values()].sort((a, b) => {
                 const trendA = isFinite(a.trendDays) ? a.trendDays : -1;
                 const trendB = isFinite(b.trendDays) ? b.trendDays : -1;
                return trendB - trendA;
            });


            if (stockTrendFilter !== 'all') {
                sortedAnalysis = sortedAnalysis.filter(item => {
                    const trend = item.trendDays;
                    if (stockTrendFilter === 'low') return isFinite(trend) && trend < 15;
                    if (stockTrendFilter === 'medium') return isFinite(trend) && trend >= 15 && trend < 30;
                    if (stockTrendFilter === 'good') return isFinite(trend) && trend >= 30;
                    return false;
                });
            }


            stockAnalysisTableBody.innerHTML = sortedAnalysis.map(item => {
                let trendText;
                let newTag = item.isNew ? ` <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-500/30 text-blue-300 ml-1">NOVO</span>` : '';

                if (!isFinite(item.trendDays) && item.stock > 0) {
                    trendText = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-500/30 text-gray-300">S/ VENDA</span>`;
                } else if (isFinite(item.trendDays)) {
                    const trendDays = Math.floor(item.trendDays);
                    let trendColor = 'text-slate-400';
                    if (trendDays < 15) trendColor = 'text-red-400';
                    else if (trendDays < 30) trendColor = 'text-yellow-400';
                    else trendColor = 'text-green-400';
                    trendText = `<span class="font-bold ${trendColor}">${trendDays} dias</span>`;
                } else {
                    trendText = '-';
                }

                return `
                    <tr>
                        <td class="px-4 py-2 text-xs">(${item.code}) ${item.descricao}</td>
                        <td class="px-4 py-2 text-xs">(${item.codfor}) ${item.fornecedor.split(' ').slice(0, 4).join(' ')}</td>
                        <td class="px-4 py-2 text-right text-xs">${item.stock.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                        <td class="px-4 py-2 text-right text-xs">${item.monthlyAvgSale.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                        <td class="px-4 py-2 text-right text-xs">${item.dailyAvgSale.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                        <td class="px-4 py-2 text-right text-xs flex items-center justify-end">${trendText}${newTag}</td>
                    </tr>
                `;
            }).join('');


            const growth = [];
            const decline = [];
            const newProducts = [];
            const lostProducts = [];

            productAnalysis.forEach(p => {
                 if (p.soldThisMonth && p.hasHistory) {
                    if (p.currentMonthSalesQty >= p.monthlyAvgSale) {
                        growth.push(p);
                    } else if (p.currentMonthSalesQty < p.monthlyAvgSale && p.monthlyAvgSale > 0) { 
                        decline.push(p);
                    }
                 } else if (p.soldThisMonth && !p.hasHistory) { 
                    newProducts.push(p);
                 } else if (!p.soldThisMonth && p.hasHistory) { 
                    lostProducts.push(p);
                 }
            });

            const renderProductTable = (bodyElement, data, showVariation = true) => {
                bodyElement.innerHTML = data.map(p => {
                    const variation = p.monthlyAvgSale > 0 ? ((p.currentMonthSalesQty - p.monthlyAvgSale) / p.monthlyAvgSale) * 100 : (p.currentMonthSalesQty > 0 ? Infinity : 0);
                    const colorClass = variation > 0 ? 'text-green-400' : (variation < 0 ? 'text-red-400' : 'text-slate-400');
                    let variationText = '0%';
                    if (isFinite(variation)) {
                        variationText = `${variation.toFixed(0)}%`;
                    } else if (variation === Infinity) {
                         variationText = 'Novo';
                    }


                    return `
                        <tr>
                            <td class="px-2 py-1.5 text-xs">(${p.code}) ${p.descricao}</td>
                            <td class="px-2 py-1.5 text-xs text-right">${p.currentMonthSalesQty.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                            <td class="px-2 py-1.5 text-xs text-right">${p.monthlyAvgSale.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                            ${showVariation ? `<td class="px-2 py-1.5 text-xs text-right font-bold ${colorClass}">${variationText}</td>` : ''}
                            <td class="px-2 py-1.5 text-xs text-right">${p.stock.toLocaleString('pt-BR', {maximumFractionDigits: 2})}</td>
                        </tr>
                    `;
                }).join('');
            };

            growth.sort((a,b) => (b.currentMonthSalesQty - b.monthlyAvgSale) - (a.currentMonthSalesQty - a.monthlyAvgSale));
            decline.sort((a,b) => (a.currentMonthSalesQty - a.monthlyAvgSale) - (b.currentMonthSalesQty - b.monthlyAvgSale));
            newProducts.sort((a,b) => b.currentMonthSalesQty - a.currentMonthSalesQty);
            lostProducts.sort((a,b) => b.monthlyAvgSale - a.monthlyAvgSale);

            renderProductTable(growthTableBody, growth);
            renderProductTable(declineTableBody, decline);
            renderProductTable(newProductsTableBody, newProducts, false);
            renderProductTable(lostProductsTableBody, lostProducts, false);
        }

        function getInnovationsFilteredData() {
            const supervisor = innovationsSupervisorFilter.value;
            const sellers = selectedInnovationsSellers;
            const city = innovationsCityFilter.value.trim().toLowerCase();
            const filial = innovationsFilialFilter.value;
            const suppliers = selectedInnovationsSuppliers;

            let clients = [...allClientsData];
            if (filial !== 'ambas') {
                clients = clients.filter(c => {
                    const lastBranch = clientLastBranch.get(c['codigo_cliente']);
                    return lastBranch === filial;
                });
            }

            if (supervisor) {
                const rcasOfSupervisor = new Set(optimizedData.rcasBySupervisor.get(supervisor) || []);
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSupervisor.has(rca)));
            }
            if (sellers.length > 0) {
                const rcasOfSellers = new Set();
                sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) rcasOfSellers.add(rcaCode);
                });
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSellers.has(rca)));
            }
            if (city) {
                clients = clients.filter(c => c.cidade && c.cidade.toLowerCase() === city);
            }

            const clientCodes = new Set(clients.map(c => c['codigo_cliente']));

            const filterFunction = s =>
                (clientCodes.has(s.codcli)) &&
                (filial === 'ambas' || s.filial === filial) &&
                (!supervisor || s.superv === supervisor) &&
                (sellers.length === 0 || sellers.includes(s.nome)) &&
                (suppliers.length === 0 || suppliers.includes(String(s.codfor))) &&
                (!city || (s.cidade && s.cidade.toLowerCase() === city));

            return {
                sales: allSalesData.filter(filterFunction),
                history: allHistoryData.filter(filterFunction),
                clients
            };
        }

        function updateInnovationsFilters() {
            const { sales, history } = getInnovationsFilteredData();
            let productSource = [...sales, ...history];

            if (selectedInnovationsSuppliers.length > 0) {
                 productSource = productSource.filter(s => selectedInnovationsSuppliers.includes(String(s.codfor)));
            }

            updateProductFilter(innovationsProductFilterDropdown, innovationsProductFilterText, selectedInnovationsProducts, productSource, 'innovations');
            innovationsProductFilterText.textContent = selectedInnovationsProducts.length > 0 ? `${selectedInnovationsProducts.length} produtos selecionados` : 'Selecione um ou mais produtos';
        }

        function resetInnovationsFilters() {
            innovationsSupervisorFilter.value = '';
            innovationsCityFilter.value = '';
            innovationsFilialFilter.value = 'ambas';
            innovationsIncludeBonusCheckbox.checked = true;
            innovationsIncludeBonus = true;
            selectedInnovationsSellers = [];
            selectedInnovationsSuppliers = [];
            selectedInnovationsProducts = [];
            updateSellerFilter('', innovationsVendedorFilterDropdown, innovationsVendedorFilterText, [], allSalesData);
            updateSupplierFilter(innovationsSupplierFilterDropdown, innovationsSupplierFilterText, [], allSalesData, 'innovations');
            updateInnovationsFilters();
            updateInnovationsView();
        }

        function updateInnovationsView() {
            const productsToAnalyze = selectedInnovationsProducts;
            const { clients, sales, history } = getInnovationsFilteredData();

            const supervisor = innovationsSupervisorFilter.value;
            const sellers = selectedInnovationsSellers;
            const sellerRcaCodes = new Set();
            if (sellers.length > 0) {
                sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) sellerRcaCodes.add(rcaCode);
                });
            } else if (supervisor) {
                (optimizedData.rcasBySupervisor.get(supervisor) || []).forEach(rca => sellerRcaCodes.add(rca));
            }


            const activeClientsForCoverage = clients.filter(c => {
                const codcli = c['codigo_cliente'];
                const rca1 = String(c.rca1 || '').trim();
                
                // --- INÍCIO DA MODIFICAÇÃO ---
                // REGRA DE EXCLUSÃO REMOVIDA: Ignora clientes destes RCAs
                /*
                if (rca1 === '306' || rca1 === '300') {
                    return false;
                }
                */
                // --- FIM DA MODIFICAÇÃO ---

                const isAmericanas = (c.razaosocial || '').toUpperCase().includes('AMERICANAS');
                // const isVdHiago = vdHiagoClients.has(codcli); // REGRA REMOVIDA
                
                // Regra de inclusão
                return (isAmericanas || rca1 !== '53');
            });

            const activeClientsCount = activeClientsForCoverage.length;
            const activeClientCodes = new Set(activeClientsForCoverage.map(c => c['codigo_cliente']));

            innovationsActiveClientsKpi.textContent = activeClientsCount.toLocaleString('pt-BR');

            if (productsToAnalyze.length === 0) {
                innovationsPlaceholder.classList.remove('hidden');
                innovationsResults.classList.add('hidden');
                innovationsSelectionCoverageValueKpi.textContent = '0%';
                innovationsSelectionCoverageCountKpi.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                innovationsSelectionCoverageValueKpiPrevious.textContent = '0%';
                innovationsSelectionCoverageCountKpiPrevious.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                innovationsBonusCoverageValueKpi.textContent = '0%';
                innovationsBonusCoverageCountKpi.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                innovationsBonusCoverageValueKpiPrevious.textContent = '0%';
                innovationsBonusCoverageCountKpiPrevious.textContent = `0 de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
                innovationsTopCoverageValueKpi.textContent = '0%';
                innovationsTopCoverageProductKpi.textContent = '-';
                innovationsTopCoverageCountKpi.textContent = '0 PDVs';
                return;
            }

            innovationsPlaceholder.classList.add('hidden');
            innovationsResults.classList.remove('hidden');

            const tableData = [];
            const clientsWhoGotSelectionCurrent = new Set();
            const clientsWhoGotSelectionPrevious = new Set();
            const clientsWhoGotBonusSelectionCurrent = new Set();
            const clientsWhoGotBonusSelectionPrevious = new Set();
            let topCoverageItem = { name: '-', coverage: 0, clients: 0 };

            productsToAnalyze.forEach(productCode => {
                const productInfo = productDetailsMap.get(productCode) || { descricao: `Produto ${productCode}`};

                let clientsWhoGotProductCurrent = 0;
                let clientsWhoGotProductPrevious = 0;

                activeClientCodes.forEach(codcli => {
                    const clientSalesCurrent = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                    const clientBonusCurrent = innovationsIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;

                    let boughtCurrent = false;
                    if (clientSalesCurrent && clientSalesCurrent.has(productCode)) {
                        const rcasWhoSold = clientSalesCurrent.get(productCode);
                        if (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca))) {
                            boughtCurrent = true;
                        }
                    }
                    let bonusCurrent = false;
                    if (clientBonusCurrent && clientBonusCurrent.has(productCode)) {
                        const rcasWhoBonused = clientBonusCurrent.get(productCode);
                         if (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca))) {
                            bonusCurrent = true;
                        }
                    }

                    if(boughtCurrent || bonusCurrent) clientsWhoGotProductCurrent++;
                    });


                    // CORREÇÃO: Lógica para Mês Anterior movida para fora do loop de clientes
                    // e agora usa o mapa pré-calculado corretamente.
                    const clientsWhoGotProductPreviousSet = new Set();
                    activeClientCodes.forEach(codcli => {
                         const clientSalesPrevious = optimizedData.salesByClientAndRca_PreviousMonth.get(codcli);
                    const clientBonusPrevious = innovationsIncludeBonus ? optimizedData.bonificationsByClientAndRca_PreviousMonth.get(codcli) : null;

                    let boughtPrevious = false;
                     if (clientSalesPrevious && clientSalesPrevious.has(productCode)) {
                        const rcasWhoSold = clientSalesPrevious.get(productCode);
                        if (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca))) {
                            boughtPrevious = true;
                        }
                    }
                    let bonusPrevious = false;
                    if (clientBonusPrevious && clientBonusPrevious.has(productCode)) {
                        const rcasWhoBonused = clientBonusPrevious.get(productCode);
                         if (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca))) {
                            bonusPrevious = true;
                        }
                    }
                        if(boughtPrevious || bonusPrevious) {
                            clientsWhoGotProductPreviousSet.add(codcli);
                        }
                });
                    clientsWhoGotProductPrevious = clientsWhoGotProductPreviousSet.size;

                const coverageCurrent = activeClientsCount > 0 ? (clientsWhoGotProductCurrent / activeClientsCount) * 100 : 0;
                const coveragePrevious = activeClientsCount > 0 ? (clientsWhoGotProductPrevious / activeClientsCount) * 100 : 0;

                if (coverageCurrent > topCoverageItem.coverage) {
                    topCoverageItem = {
                        name: `(${productCode}) ${productInfo.descricao}`,
                        coverage: coverageCurrent,
                        clients: clientsWhoGotProductCurrent
                    };
                }

                activeClientCodes.forEach(codcli => {
                    const currentSales = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                    const currentBonus = innovationsIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;

                    if ((currentSales && currentSales.has(productCode) && (sellerRcaCodes.size === 0 || [...currentSales.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                        (currentBonus && currentBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...currentBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                        clientsWhoGotSelectionCurrent.add(codcli);
                    }
                    if (currentBonus && currentBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...currentBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) {
                        clientsWhoGotBonusSelectionCurrent.add(codcli);
                    }

                    const previousSales = optimizedData.salesByClientAndRca_PreviousMonth.get(codcli);
                    const previousBonus = innovationsIncludeBonus ? optimizedData.bonificationsByClientAndRca_PreviousMonth.get(codcli) : null;

                    if ((previousSales && previousSales.has(productCode) && (sellerRcaCodes.size === 0 || [...previousSales.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                        (previousBonus && previousBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...previousBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                        clientsWhoGotSelectionPrevious.add(codcli);
                    }
                    if (previousBonus && previousBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...previousBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) {
                        clientsWhoGotBonusSelectionPrevious.add(codcli);
                    }
                });

                const variation = coveragePrevious > 0 ? ((coverageCurrent - coveragePrevious) / coveragePrevious) * 100 : (coverageCurrent > 0 ? Infinity : 0);
                const stockQty = getActiveStockMap(innovationsFilialFilter.value).get(productCode) || 0;

                tableData.push({
                    descricao: `(${productCode}) ${productInfo.descricao}`,
                    stockQty: stockQty,
                    coveragePrevious: coveragePrevious,
                    coverageCurrent: coverageCurrent,
                    variation: variation,
                    clientsPreviousCount: clientsWhoGotProductPrevious,
                    clientsCurrentCount: clientsWhoGotProductCurrent
                });
            });

            innovationsTopCoverageValueKpi.textContent = `${topCoverageItem.coverage.toFixed(2)}%`;
            innovationsTopCoverageProductKpi.textContent = topCoverageItem.name;
            innovationsTopCoverageProductKpi.title = topCoverageItem.name;
            innovationsTopCoverageCountKpi.textContent = `${topCoverageItem.clients.toLocaleString('pt-BR')} PDVs`;

            const selectionCoveredCountCurrent = clientsWhoGotSelectionCurrent.size;
            const selectionCoveragePercentCurrent = activeClientsCount > 0 ? (selectionCoveredCountCurrent / activeClientsCount) * 100 : 0;
            innovationsSelectionCoverageValueKpi.textContent = `${selectionCoveragePercentCurrent.toFixed(2)}%`;
            innovationsSelectionCoverageCountKpi.textContent = `${selectionCoveredCountCurrent.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            const selectionCoveredCountPrevious = clientsWhoGotSelectionPrevious.size;
            const selectionCoveragePercentPrevious = activeClientsCount > 0 ? (selectionCoveredCountPrevious / activeClientsCount) * 100 : 0;
            innovationsSelectionCoverageValueKpiPrevious.textContent = `${selectionCoveragePercentPrevious.toFixed(2)}%`;
            innovationsSelectionCoverageCountKpiPrevious.textContent = `${selectionCoveredCountPrevious.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            const bonusCoveredCountCurrent = clientsWhoGotBonusSelectionCurrent.size;
            const bonusCoveragePercentCurrent = activeClientsCount > 0 ? (bonusCoveredCountCurrent / activeClientsCount) * 100 : 0;
            innovationsBonusCoverageValueKpi.textContent = `${bonusCoveragePercentCurrent.toFixed(2)}%`;
            innovationsBonusCoverageCountKpi.textContent = `${bonusCoveredCountCurrent.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            const bonusCoveredCountPrevious = clientsWhoGotBonusSelectionPrevious.size;
            const bonusCoveragePercentPrevious = activeClientsCount > 0 ? (bonusCoveredCountPrevious / activeClientsCount) * 100 : 0;
            innovationsBonusCoverageValueKpiPrevious.textContent = `${bonusCoveragePercentPrevious.toFixed(2)}%`;
            innovationsBonusCoverageCountKpiPrevious.textContent = `${bonusCoveredCountPrevious.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;


            tableData.sort((a, b) => b.coverageCurrent - a.coverageCurrent);

            innovationsTableBody.innerHTML = tableData.map(item => {
                let variationContent;
                if (isFinite(item.variation)) {
                    const colorClass = item.variation >= 0 ? 'text-green-400' : 'text-red-400';
                    variationContent = `<span class="${colorClass}">${item.variation.toFixed(1)}%</span>`;
                } else if (item.coverageCurrent > 0) {
                    variationContent = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-500/30 text-purple-300">Novo</span>`;
                } else {
                    variationContent = `<span>-</span>`;
                }
                return `
                    <tr>
                        <td class="px-2 py-1.5 text-xs">${item.descricao}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.stockQty.toLocaleString('pt-BR')}</td>
                        <td class="px-2 py-1.5 text-xs text-right">
                            <div class="tooltip">${item.coveragePrevious.toFixed(2)}%<span class="tooltip-text">${item.clientsPreviousCount} PDVs</span></div>
                        </td>
                        <td class="px-2 py-1.5 text-xs text-right">
                            <div class="tooltip">${item.coverageCurrent.toFixed(2)}%<span class="tooltip-text">${item.clientsCurrentCount} PDVs</span></div>
                        </td>
                        <td class="px-2 py-1.5 text-xs text-right">${variationContent}</td>
                    </tr>
                `;
            }).join('');
        }

        function getInnovationsMonthFilteredData() {
            const supervisor = innovationsMonthSupervisorFilter.value;
            const sellers = selectedInnovationsMonthSellers;
            const city = innovationsMonthCityFilter.value.trim().toLowerCase();
            const filial = innovationsMonthFilialFilter.value;

            let clients = [...allClientsData];

            if (filial !== 'ambas') {
                clients = clients.filter(c => {
                    const lastBranch = clientLastBranch.get(c['codigo_cliente']);
                    return lastBranch === filial;
                });
            }

            if (supervisor) {
                const rcasOfSupervisor = new Set(optimizedData.rcasBySupervisor.get(supervisor) || []);
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSupervisor.has(rca)));
            }
            if (sellers.length > 0) {
                const rcasOfSellers = new Set();
                 sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) rcasOfSellers.add(rcaCode);
                });
                clients = clients.filter(c => c.rcas.some(rca => rcasOfSellers.has(rca)));
            }
            if (city) {
                clients = clients.filter(c => c.cidade && c.cidade.toLowerCase() === city);
            }

            return { clients };
        }

        function resetInnovationsMonthFilters() {
            innovationsMonthSupervisorFilter.value = '';
            innovationsMonthCityFilter.value = '';
            innovationsMonthFilialFilter.value = 'ambas';
            innovationsMonthCategoryFilter.value = '';
            innovationsMonthIncludeBonusCheckbox.checked = true;
            innovationsMonthIncludeBonus = true;
            selectedInnovationsMonthSellers = [];
            updateSellerFilter('', innovationsMonthVendedorFilterDropdown, innovationsMonthVendedorFilterText, [], allSalesData);
            updateInnovationsMonthView();
        }

        function updateInnovationsMonthView() {
            const selectedCategory = innovationsMonthCategoryFilter.value;

            const { clients: filteredClients } = getInnovationsMonthFilteredData();

            const supervisor = innovationsMonthSupervisorFilter.value;
            const sellers = selectedInnovationsMonthSellers;
            const sellerRcaCodes = new Set();
            if (sellers.length > 0) {
                sellers.forEach(sellerName => {
                    const rcaCode = optimizedData.rcaCodeByName.get(sellerName);
                    if (rcaCode) sellerRcaCodes.add(rcaCode);
                });
            } else if (supervisor) {
                (optimizedData.rcasBySupervisor.get(supervisor) || []).forEach(rca => sellerRcaCodes.add(rca));
            }

            const categories = {};
            if (innovationsMonthData && innovationsMonthData.length > 0) {
                innovationsMonthData.forEach(item => {
                    const categoryName = item.inovacoes; // CORREÇÃO: Usar "inovacoes" em minúsculas
                    if (!categoryName) return;
                    if (!categories[categoryName]) {
                        categories[categoryName] = { productCodes: new Set(), products: [] };
                    }
                    // CORREÇÃO: Usar "codigo" e "produto" em minúsculas para corresponder aos dados do Supabase
                    const productCode = String(item.codigo).trim();
                    categories[categoryName].productCodes.add(productCode);
                    categories[categoryName].products.push({ ...item, codigo: productCode });
                });
            }

            const allCategories = Object.keys(categories).sort();
            const currentFilterValue = innovationsMonthCategoryFilter.value;
            innovationsMonthCategoryFilter.innerHTML = '<option value="">Todas as Categorias</option>';
            allCategories.forEach(cat => {
                innovationsMonthCategoryFilter.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            if (allCategories.includes(currentFilterValue)) {
                innovationsMonthCategoryFilter.value = currentFilterValue;
            }


            const activeClients = filteredClients.filter(c => {
                const codcli = c['codigo_cliente'];
                const rca1 = String(c.rca1 || '').trim();
                
                // --- INÍCIO DA MODIFICAÇÃO ---
                // REGRA DE EXCLUSÃO REMOVIDA: Ignora clientes destes RCAs
                /*
                if (rca1 === '306' || rca1 === '300') {
                    return false;
                }
                */
                // --- FIM DA MODIFICAÇÃO ---
                
                const isAmericanas = (c.razaosocial || '').toUpperCase().includes('AMERICANAS');
                // const isVdHiago = vdHiagoClients.has(codcli); // REGRA REMOVIDA
                
                // Regra de inclusão
                return (isAmericanas || rca1 !== '53');
            });
            const activeClientsCount = activeClients.length;
            const activeClientCodes = new Set(activeClients.map(c => c['codigo_cliente']));

            const categoryAnalysis = {};
            let topCoverageItem = { name: '-', coverage: 0, clients: 0 };

            const clientsWhoGotAnyVisibleProductCurrent = new Set();
            const clientsWhoGotAnyVisibleProductPrevious = new Set();
            const clientsWhoGotBonusAnyVisibleProductCurrent = new Set();
            const clientsWhoGotBonusAnyVisibleProductPrevious = new Set();

            for (const categoryName in categories) {
                 if(selectedCategory && categoryName !== selectedCategory) continue;

                const productCodes = categories[categoryName].productCodes;
                let clientsCurrentCount = 0;
                let clientsPreviousCount = 0;

                activeClientCodes.forEach(codcli => {
                    const currentSales = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                    const currentBonus = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;
                    if ((currentSales && [...productCodes].some(p => {
                        const rcasWhoSold = currentSales.get(p);
                        return rcasWhoSold && (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca)));
                    })) || (currentBonus && [...productCodes].some(p => {
                        const rcasWhoBonused = currentBonus.get(p);
                        return rcasWhoBonused && (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca)));
                    }))) {
                        clientsCurrentCount++;
                        clientsWhoGotAnyVisibleProductCurrent.add(codcli);
                    }

                    if (currentBonus && [...productCodes].some(p => {
                        const rcasWhoBonused = currentBonus.get(p);
                        return rcasWhoBonused && (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca)));
                    })) {
                        clientsWhoGotBonusAnyVisibleProductCurrent.add(codcli);
                    }


                    const previousSales = optimizedData.salesByClientAndRca_PreviousMonth.get(codcli);
                    const previousBonus = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_PreviousMonth.get(codcli) : null;
                    if ((previousSales && [...productCodes].some(p => {
                        const rcasWhoSold = previousSales.get(p);
                        return rcasWhoSold && (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca)));
                    })) || (previousBonus && [...productCodes].some(p => {
                        const rcasWhoBonused = previousBonus.get(p);
                        return rcasWhoBonused && (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca)));
                    }))) {
                        clientsPreviousCount++;
                        clientsWhoGotAnyVisibleProductPrevious.add(codcli);
                    }
                     if (previousBonus && [...productCodes].some(p => {
                        const rcasWhoBonused = previousBonus.get(p);
                        return rcasWhoBonused && (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca)));
                    })) {
                        clientsWhoGotBonusAnyVisibleProductPrevious.add(codcli);
                    }
                });

                const coverageCurrent = activeClientsCount > 0 ? (clientsCurrentCount / activeClientsCount) * 100 : 0;

                if (!selectedCategory && coverageCurrent > topCoverageItem.coverage) {
                    topCoverageItem = { name: categoryName, coverage: coverageCurrent, clients: clientsCurrentCount };
                }

                const coveragePrevious = activeClientsCount > 0 ? (clientsPreviousCount / activeClientsCount) * 100 : 0;

                const variation = coveragePrevious > 0 ? ((coverageCurrent - coveragePrevious) / coveragePrevious) * 100 : (coverageCurrent > 0 ? Infinity : 0);

                categoryAnalysis[categoryName] = {
                    coverageCurrent,
                    coveragePrevious,
                    variation,
                    clientsCount: clientsCurrentCount
                };
            }

            if (selectedCategory && categories[selectedCategory]) {
                const productsInCategory = categories[selectedCategory].products;
                topCoverageItem = { name: '-', coverage: 0, clients: 0 };

                productsInCategory.forEach(product => {
                    const productCode = product.codigo; // CORREÇÃO: "codigo" em minúsculas
                    let clientsWhoGotProduct = 0;
                    activeClientCodes.forEach(codcli => {
                        const currentSales = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                        const currentBonus = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;

                        let gotIt = false;
                        if (currentSales && currentSales.has(productCode)) {
                             const rcasWhoSold = currentSales.get(productCode);
                             if (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca))) {
                                gotIt = true;
                             }
                        }
                        if (!gotIt && currentBonus && currentBonus.has(productCode)) {
                            const rcasWhoBonused = currentBonus.get(productCode);
                            if (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca))) {
                                gotIt = true;
                            }
                        }
                        if(gotIt) clientsWhoGotProduct++;
                    });

                    const coverage = activeClientsCount > 0 ? (clientsWhoGotProduct / activeClientsCount) * 100 : 0;
                    if (coverage > topCoverageItem.coverage) {
                        topCoverageItem = { name: `(${productCode}) ${product.produto}`, coverage: coverage, clients: clientsWhoGotProduct }; // CORREÇÃO: "produto" em minúsculas
                    }
                });
            }

            const selectionCoveredCountCurrent = clientsWhoGotAnyVisibleProductCurrent.size;
            const selectionCoveragePercentCurrent = activeClientsCount > 0 ? (selectionCoveredCountCurrent / activeClientsCount) * 100 : 0;
            const selectionCoveredCountPrevious = clientsWhoGotAnyVisibleProductPrevious.size;
            const selectionCoveragePercentPrevious = activeClientsCount > 0 ? (selectionCoveredCountPrevious / activeClientsCount) * 100 : 0;

            const bonusCoveredCountCurrent = clientsWhoGotBonusAnyVisibleProductCurrent.size;
            const bonusCoveragePercentCurrent = activeClientsCount > 0 ? (bonusCoveredCountCurrent / activeClientsCount) * 100 : 0;
            const bonusCoveredCountPrevious = clientsWhoGotBonusAnyVisibleProductPrevious.size;
            const bonusCoveragePercentPrevious = activeClientsCount > 0 ? (bonusCoveredCountPrevious / activeClientsCount) * 100 : 0;

            innovationsMonthActiveClientsKpi.textContent = activeClientsCount.toLocaleString('pt-BR');
            innovationsMonthTopCoverageValueKpi.textContent = `${topCoverageItem.coverage.toFixed(2)}%`;
            innovationsMonthTopCoverageKpi.textContent = topCoverageItem.name;
            innovationsMonthTopCoverageKpi.title = topCoverageItem.name;
            innovationsMonthTopCoverageCountKpi.textContent = `${topCoverageItem.clients.toLocaleString('pt-BR')} PDVs`;
            document.getElementById('innovations-month-top-coverage-title').textContent = selectedCategory ? 'Produto com Maior Cobertura' : 'Categoria com Maior Cobertura';

            innovationsMonthSelectionCoverageValueKpi.textContent = `${selectionCoveragePercentCurrent.toFixed(2)}%`;
            innovationsMonthSelectionCoverageCountKpi.textContent = `${selectionCoveredCountCurrent.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
            innovationsMonthSelectionCoverageValueKpiPrevious.textContent = `${selectionCoveragePercentPrevious.toFixed(2)}%`;
            innovationsMonthSelectionCoverageCountKpiPrevious.textContent = `${selectionCoveredCountPrevious.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            innovationsMonthBonusCoverageValueKpi.textContent = `${bonusCoveragePercentCurrent.toFixed(2)}%`;
            innovationsMonthBonusCoverageCountKpi.textContent = `${bonusCoveredCountCurrent.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;
            innovationsMonthBonusCoverageValueKpiPrevious.textContent = `${bonusCoveragePercentPrevious.toFixed(2)}%`;
            innovationsMonthBonusCoverageCountKpiPrevious.textContent = `${bonusCoveredCountPrevious.toLocaleString('pt-BR')} de ${activeClientsCount.toLocaleString('pt-BR')} clientes`;

            chartLabels = Object.keys(categoryAnalysis).sort((a,b) => categoryAnalysis[b].coverageCurrent - categoryAnalysis[a].coverageCurrent);
            const chartDataCurrent = chartLabels.map(cat => categoryAnalysis[cat].coverageCurrent);
            const chartDataPrevious = chartLabels.map(cat => categoryAnalysis[cat].coveragePrevious);

            if (chartLabels.length > 0) {
                createChart('innovations-month-chart', 'bar', chartLabels, [
                    { label: 'Mês Anterior', data: chartDataPrevious, backgroundColor: '#f97316' },
                    { label: 'Mês Atual', data: chartDataCurrent, backgroundColor: '#06b6d4' }
                ], {
                    plugins: {
                        legend: { display: true, position: 'top' },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 8,
                            formatter: (value) => value > 0 ? value.toFixed(1) + '%' : '',
                            color: '#cbd5e1',
                            font: { size: 10 }
                        },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toFixed(2) + '%';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { y: { ticks: { callback: (v) => `${v}%` } } },
                    layout: { padding: { top: 20 } }
                });
            } else {
                showNoDataMessage('innovations-month-chart', 'Sem dados de inovações para exibir com os filtros atuais.');
            }

            const tableData = [];
            const activeStockMap = getActiveStockMap(innovationsMonthFilialFilter.value);

            chartLabels.forEach(categoryName => {
                const categoryData = categories[categoryName];

                categoryData.products.forEach((product) => {
                    const productCode = product.codigo;   // CORREÇÃO: "codigo" em minúsculas
                    const productName = product.produto; // CORREÇÃO: "produto" em minúsculas

                    const stock = activeStockMap.get(productCode) || 0;

                    let clientsCurrentCount = 0;
                    let clientsPreviousCount = 0;

                    activeClientCodes.forEach(codcli => {
                         const currentSales = optimizedData.salesByClientAndRca_CurrentMonth.get(codcli);
                         const currentBonus = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(codcli) : null;
                         if((currentSales && currentSales.has(productCode) && (sellerRcaCodes.size === 0 || [...currentSales.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                            (currentBonus && currentBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...currentBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                                clientsCurrentCount++;
                         }

                         const previousSales = optimizedData.salesByClientAndRca_PreviousMonth.get(codcli);
                         const previousBonus = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_PreviousMonth.get(codcli) : null;
                         if((previousSales && previousSales.has(productCode) && (sellerRcaCodes.size === 0 || [...previousSales.get(productCode)].some(rca => sellerRcaCodes.has(rca)))) ||
                           (previousBonus && previousBonus.has(productCode) && (sellerRcaCodes.size === 0 || [...previousBonus.get(productCode)].some(rca => sellerRcaCodes.has(rca))))) {
                            clientsPreviousCount++;
                         }
                    });

                    const coverageCurrent = activeClientsCount > 0 ? (clientsCurrentCount / activeClientsCount) * 100 : 0;
                    const coveragePrevious = activeClientsCount > 0 ? (clientsPreviousCount / activeClientsCount) * 100 : 0;

                    const variation = coveragePrevious > 0 ? ((coverageCurrent - coveragePrevious) / coveragePrevious) * 100 : (coverageCurrent > 0 ? Infinity : 0);

                    tableData.push({
                        categoryName,
                        productCode,
                        productName,
                        stock,
                        coveragePrevious,
                        clientsPreviousCount,
                        coverageCurrent,
                        clientsCurrentCount,
                        variation
                    });
                });
            });

            tableData.sort((a,b) => b.coverageCurrent - a.coverageCurrent);

            innovationsMonthTableDataForExport = tableData;

            innovationsMonthTableBody.innerHTML = tableData.map(item => {
                let variationContent;
                if (isFinite(item.variation)) {
                    const colorClass = item.variation >= 0 ? 'text-green-400' : 'text-red-400';
                    variationContent = `<span class="${colorClass}">${item.variation.toFixed(1)}%</span>`;
                } else if (item.coverageCurrent > 0) {
                    variationContent = `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-500/30 text-purple-300">Novo</span>`;
                } else {
                    variationContent = `<span>-</span>`;
                }

                return `
                    <tr>
                        <td class="px-2 py-1.5 text-xs">${item.categoryName}</td>
                        <td class="px-2 py-1.5 text-xs">${item.productCode} - ${item.productName}</td>
                        <td class="px-2 py-1.5 text-xs text-right">${item.stock.toLocaleString('pt-BR')}</td>
                        <td class="px-2 py-1.5 text-xs text-right">
                            <div class="tooltip">${item.coveragePrevious.toFixed(2)}%<span class="tooltip-text">${item.clientsPreviousCount} PDVs</span></div>
                        </td>
                        <td class="px-2 py-1.5 text-xs text-right">
                            <div class="tooltip">${item.coverageCurrent.toFixed(2)}%<span class="tooltip-text">${item.clientsCurrentCount} PDVs</span></div>
                        </td>
                        <td class="px-2 py-1.5 text-xs text-right">${variationContent}</td>
                    </tr>
                `;
            }).join('');

            const innovationsByClientTableHead = document.getElementById('innovations-by-client-table-head');
            const innovationsByClientTableBody = document.getElementById('innovations-by-client-table-body');
            const innovationsByClientLegend = document.getElementById('innovations-by-client-legend');

            const categoryNames = Object.keys(categories).sort();
            categoryLegendForExport = categoryNames.map((name, index) => `${index + 1} - ${name}`);
            innovationsByClientLegend.innerHTML = `<strong>Legenda:</strong> ${categoryLegendForExport.join('; ')}`;

            let tableHeadHTML = `
                <tr>
                    <th class="px-2 py-2 text-left">Código</th>
                    <th class="px-2 py-2 text-left">Cliente</th>
                    <th class="px-2 py-2 text-left">Cidade</th>
                    <th class="px-2 py-2 text-left">Bairro</th>
                    <th class="px-2 py-2 text-center">Últ. Compra</th>
            `;
            categoryNames.forEach((name, index) => {
                tableHeadHTML += `<th class="px-2 py-2 text-center">${index + 1}</th>`;
            });
            tableHeadHTML += `</tr>`;
            innovationsByClientTableHead.innerHTML = tableHeadHTML;

            const clientInnovationStatus = activeClients.map(client => {
                const clientBoughtProducts = optimizedData.salesByClientAndRca_CurrentMonth.get(client['codigo_cliente']) || new Map();
                const clientBonusedProducts = innovationsMonthIncludeBonus ? optimizedData.bonificationsByClientAndRca_CurrentMonth.get(client['codigo_cliente']) : null;
                const status = {};
                categoryNames.forEach(catName => {
                    const productCodes = categories[catName].productCodes;
                    status[catName] = [...productCodes].some(p => {
                        const rcasWhoSold = clientBoughtProducts.get(p);
                        const rcasWhoBonused = clientBonusedProducts ? clientBonusedProducts.get(p) : null;
                        const sold = rcasWhoSold && (sellerRcaCodes.size === 0 || [...rcasWhoSold].some(rca => sellerRcaCodes.has(rca)));
                        const bonused = rcasWhoBonused && (sellerRcaCodes.size === 0 || [...rcasWhoBonused].some(rca => sellerRcaCodes.has(rca)));
                        return sold || bonused;
                    });
                });
                return { ...client, innovationStatus: status };
            });

            clientInnovationStatus.sort((a, b) => {
                const cidadeA = a.cidade || '';
                const cidadeB = b.cidade || '';
                const bairroA = a.bairro || '';
                const bairroB = b.bairro || '';
                if (cidadeA.localeCompare(cidadeB) !== 0) {
                    return cidadeA.localeCompare(cidadeB);
                }
                return bairroA.localeCompare(bairroB);
            });

            innovationsByClientForExport = clientInnovationStatus;

            let tableBodyHTML = '';
            const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
            const xIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;

            clientInnovationStatus.forEach(client => {
                tableBodyHTML += `
                    <tr>
                        <td class="px-2 py-1.5 text-xs">${client['codigo_cliente']}</td>
                        <td class="px-2 py-1.5 text-xs">${client.fantasia || client.razaosocial}</td>
                        <td class="px-2 py-1.5 text-xs">${client.cidade}</td>
                        <td class="px-2 py-1.5 text-xs">${client.bairro}</td>
                        <td class="px-2 py-1.5 text-xs text-center">${formatDate(client.ultimacompra)}</td>
                `;
                categoryNames.forEach(catName => {
                    tableBodyHTML += `<td class="px-2 py-1.5 text-center">${client.innovationStatus[catName] ? checkIcon : xIcon}</td>`;
                });
                tableBodyHTML += `</tr>`;
            });
            innovationsByClientTableBody.innerHTML = tableBodyHTML;
        }

        async function exportInnovationsMonthPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            const supervisor = innovationsMonthSupervisorFilter.value || 'Todos';
            const vendedor = selectedInnovationsMonthSellers.length > 0 ? selectedInnovationsMonthSellers.join(', ') : 'Todos';
            const filial = innovationsMonthFilialFilter.options[innovationsMonthFilialFilter.selectedIndex].text;
            const cidade = innovationsMonthCityFilter.value || 'Todas';
            const categoria = innovationsMonthCategoryFilter.value || 'Todas';
            const generationDate = new Date().toLocaleString('pt-BR');

            doc.setFontSize(18);
            doc.text('Relatório de Inovações do Mês', 14, 22);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Data de Emissão: ${generationDate}`, 14, 30);

            let filterText = `Filtros Aplicados: Supervisor: ${supervisor} | Vendedor: ${vendedor} | Filial: ${filial} | Cidade: ${cidade} | Categoria: ${categoria}`;
            const splitFilters = doc.splitTextToSize(filterText, 270);
            doc.text(splitFilters, 14, 36);

            const chartCanvas = document.getElementById('innovations-month-chart');
            if (chartCanvas && charts['innovations-month-chart'] && chartLabels.length > 0) {
                try {
                    const chartImage = chartCanvas.toDataURL('image/png', 1.0);
                    doc.addImage(chartImage, 'PNG', 14, 50, 270, 100);
                } catch (e) {
                    console.error("Erro ao converter o gráfico para imagem:", e);
                    doc.text("Erro ao gerar a imagem do gráfico.", 14, 50);
                }
            } else {
                 doc.text("Gráfico não disponível para os filtros selecionados.", 14, 50);
            }

            const head = [['Categoria', 'Produto', 'Estoque', 'Cob. Mês Ant.', 'Cob. Mês Atual', 'Variação']];
            const body = [];

            innovationsMonthTableDataForExport.forEach(item => {
                let variationContent;
                if (isFinite(item.variation)) {
                    variationContent = `${item.variation.toFixed(1)}%`;
                } else if (item.coverageCurrent > 0) {
                    variationContent = 'Novo';
                } else {
                    variationContent = '-';
                }

                const row = [
                    item.categoryName,
                    `${item.productCode} - ${item.productName}`,
                    item.stock.toLocaleString('pt-BR'),
                    `${item.coveragePrevious.toFixed(2)}% (${item.clientsPreviousCount} PDVs)`,
                    `${item.coverageCurrent.toFixed(2)}% (${item.clientsCurrentCount} PDVs)`,
                    variationContent
                ];
                body.push(row);
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 155,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5 },
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 7, fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [240, 248, 255] },
                didDrawPage: function (data) {
                    doc.setFontSize(12);
                    doc.setTextColor(40);
                    doc.text("Dados do Gráfico", data.settings.margin.left, 152);
                }
            });

            if (innovationsByClientForExport.length > 0) {
                doc.addPage();
                doc.setFontSize(18);
                doc.text('Relatório de Inovações por Cliente', 14, 22);
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Data de Emissão: ${generationDate}`, 14, 30);
                doc.text(splitFilters, 14, 36);

                const legendText = `Legenda: ${categoryLegendForExport.join('; ')}`;
                const splitLegend = doc.splitTextToSize(legendText, 270);
                doc.text(splitLegend, 14, 42);

                const clientInnovationsHead = [['Código', 'Cliente', 'Cidade', 'Bairro', 'Últ. Compra', ...categoryLegendForExport.map((_, i) => `${i + 1}`)]];
                const clientInnovationsBody = innovationsByClientForExport.map(client => {
                    const row = [
                        client['codigo_cliente'],
                        client.fantasia || client.razaosocial,
                        client.cidade,
                        client.bairro,
                        formatDate(client.ultimacompra)
                    ];
                    categoryLegendForExport.forEach((cat, index) => {
                        const catName = cat.split(' - ')[1];
                        const status = client.innovationStatus[catName];

                        const cell = {
                            content: status ? 'S' : 'N',
                            styles: {
                                textColor: status ? [34, 139, 34] : [220, 20, 60],
                                fontStyle: 'bold'
                            }
                        };
                        row.push(cell);
                    });
                    return row;
                });

                doc.autoTable({
                    head: clientInnovationsHead,
                    body: clientInnovationsBody,
                    startY: 55,
                    theme: 'grid',
                    styles: { fontSize: 7, cellPadding: 1.5, halign: 'center' },
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 7, fontStyle: 'bold' },
                    columnStyles: {
                        0: { halign: 'left' },
                        1: { halign: 'left' },
                        2: { halign: 'left' },
                        3: { halign: 'left' },
                        4: { halign: 'center' }
                    },
                    alternateRowStyles: { fillColor: [240, 248, 255] },
                });
            }

            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(150);
                doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' });
            }

            const fileNameParam = vendedor.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'geral';
            doc.save(`relatorio_inovacoes_mes_${fileNameParam}_${new Date().toISOString().slice(0,10)}.pdf`);
        }


        function openModal(pedidoId) {
            const orderInfo = aggregatedOrders.find(order => order.pedido == pedidoId);
            const itemsDoPedido = allSalesData.filter(item => item.pedido == pedidoId);
            if (!orderInfo) return;
            modalPedidoId.textContent = pedidoId;
            modalHeaderInfo.innerHTML = `<div><p class="font-bold">Cód. Cliente:</p><p>${orderInfo.codcli || 'N/A'}</p></div><div><p class="font-bold">Cliente:</p><p>${orderInfo.cliente_nome || 'N/A'}</p></div><div><p class="font-bold">Vendedor:</p><p>${orderInfo.nome || 'N/A'}</p></div><div><p class="font-bold">Data Pedido:</p><p>${formatDate(orderInfo.dtped)}</p></div><div><p class="font-bold">Data Faturamento:</p><p>${formatDate(orderInfo.dtsaida)}</p></div><div><p class="font-bold">Cidade:</p><p>${orderInfo.cidade || 'N/A'}</p></div>`;
            // CORREÇÃO 2: Usar 'item.qtvenda' (minúsculas) em vez de 'item.QTVENDA'
            modalTableBody.innerHTML = itemsDoPedido.map(item => { const unitPrice = (item.qtvenda > 0) ? (item.vlvenda / item.qtvenda) : 0; return `<tr><td class="px-4 py-2">(${item.produto}) ${item.descricao}</td><td class="px-4 py-2 text-right">${item.qtvenda}</td><td class="px-4 py-2 text-right">${item.totpesoliq.toLocaleString('pt-BR', { minimumFractionDigits: 2 })} Kg</td><td class="px-4 py-2 text-right"><div class="tooltip">${unitPrice.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<span class="tooltip-text" style="width: max-content; transform: translateX(-50%); margin-left: 0;">Subtotal: ${item.vlvenda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</span></div></td></tr>`; }).join('');
            modalFooterTotal.innerHTML = `<p class="text-lg font-bold text-teal-400">Mix de Produtos: ${itemsDoPedido.length}</p><p class="text-lg font-bold text-emerald-400">Total do Pedido: ${orderInfo.vlvenda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>`;
            modal.classList.remove('hidden');
        }

        function openClientModal(codcli) {
            // CORREÇÃO 1: Adicionados logs de depuração para o modal do cliente
            console.log("A tentar encontrar cliente com codcli:", codcli);
            const clientData = allClientsData.find(c => String(c['codigo_cliente']) === String(codcli));
            console.log("Encontrado clientData:", clientData);
            if (!clientData) return;
            let finalAddress = clientData.endereco || 'N/A';
            const number = clientData.numero || 'SN';
            if (number !== 'SN' && finalAddress !== 'N/A' && !finalAddress.includes(number)) finalAddress += `, ${number}`;
            clientModalContent.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm"><div><p class="font-bold">Código:</p><p>${clientData['codigo_cliente'] || 'N/A'}</p></div><div><p class="font-bold">CNPJ/CPF:</p><p>${clientData.cnpj_cpf || 'N/A'}</p></div><div class="md:col-span-2"><p class="font-bold">Insc. Est. / Produtor:</p><p>${clientData.inscricaoestadual || 'N/A'}</p></div><div class="md:col-span-2"><p class="font-bold">Razão Social:</p><p>${clientData.razaosocial || 'N/A'}</p></div><div class="md:col-span-2"><p class="font-bold">Nome Fantasia:</p><p>${clientData.fantasia || 'N/A'}</p></div><div class="md:col-span-2"><p class="font-bold">Endereço:</p><p>${finalAddress}</p></div><div><p class="font-bold">Bairro:</p><p>${clientData.bairro || 'N/A'}</p></div><div><p class="font-bold">Cidade:</p><p>${clientData.cidade || 'N/A'}</p></div><div><p class="font-bold">CEP:</p><p>${clientData.cep || 'N/A'}</p></div><div><p class="font-bold">Telefone:</p><p>${clientData.telefone || 'N/A'}</p></div><div class="md:col-span-2"><p class="font-bold">E-mail:</p><p>${clientData.email || 'N/A'}</p></div><div><p class="font-bold">Ramo de Atividade:</p><p>${clientData.ramo || 'N/A'}</p></div><div><p class="font-bold">Última Compra:</p><p>${formatDate(clientData.ultimacompra)}</p></div><div><p class="font-bold">Data Cadastro:</p><p>${formatDate(clientData.datacadastro)}</p></div><div><p class="font-bold">Bloqueio:</p><p>${clientData.bloqueio || 'N/A'}</p></div></div>`;
            clientModal.classList.remove('hidden');
        }

        function exportClientsPDF(clientList, title, filename, includeFaturamento) {
             if (clientList.length === 0) return;
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            const supervisor = citySupervisorFilter.value || 'Todos'; const vendedor = selectedCitySellers.length > 0 ? selectedCitySellers.join(', ') : 'Todos';
            const generationDate = new Date().toLocaleString('pt-BR'); const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toLocaleDateString('pt-BR');
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toLocaleDateString('pt-BR');
            doc.setFontSize(18); doc.text(title, 14, 22); doc.setFontSize(11); doc.setTextColor(100);
            doc.text(`Período de Análise: ${firstDay} a ${lastDay}`, 14, 32);
            doc.text(`Supervisor: ${supervisor}`, 14, 38); doc.text(`Vendedor: ${vendedor}`, 14, 44);
            doc.text(`Data de Emissão: ${generationDate}`, 14, 50);
            const tableColumn = ["Código", "Cliente", "Bairro", "Cidade", "Últ. Compra"];
            if (includeFaturamento) tableColumn.splice(2, 0, "Faturamento");

            clientList.sort((a, b) => {
                const cidadeA = a.cidade || '';
                const cidadeB = b.cidade || '';
                const bairroA = a.bairro || '';
                const bairroB = b.bairro || '';
                if (cidadeA < cidadeB) return -1;
                if (cidadeA > cidadeB) return 1;
                if (bairroA < bairroB) return -1;
                if (bairroA > bairroB) return 1;
                return 0;
            });

            const tableRows = [];
            clientList.forEach(client => {
                const clientData = [ client['codigo_cliente'] || '', client.fantasia || client.razaosocial || '', client.bairro || '', client.cidade || '', formatDate(client.ultimacompra) || 'N/A' ];
                if (includeFaturamento) clientData.splice(2, 0, (client.total || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }));
                tableRows.push(clientData);
            });
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 60, theme: 'grid', styles: { fontSize: 8, cellPadding: 1.5 }, headStyles: { fillColor: [41, 128, 185], textColor: 255, fontSize: 8, fontStyle: 'bold' }, alternateRowStyles: { fillColor: [240, 248, 255] }, margin: { top: 10 } });
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(9); doc.setTextColor(150); doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 10, { align: 'center' }); }
            const fileNameVendedor = vendedor.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'geral';
            doc.save(`${filename}_${fileNameVendedor}_${new Date().toISOString().slice(0,10)}.pdf`);
        }

        function renderCalendar(year, month) {
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

            let calendarHTML = `
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-slate-600">&lt;</button>
                    <h3 class="font-bold text-lg">${monthNames[month]} ${year}</h3>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-slate-600">&gt;</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                    <div>Dom</div><div>Seg</div><div>Ter</div><div>Qua</div><div>Qui</div><div>Sex</div><div>Sáb</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
            `;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toISOString().split('T')[0];
                const isSelected = selectedHolidays.includes(dateString);
                const isToday = date.getTime() === lastSaleDate.getTime();
                let dayClasses = 'p-2 rounded-full cursor-pointer hover:bg-menu-button-hover flex items-center justify-center';
                if (isSelected) dayClasses += ' bg-red-500 text-white font-bold';
                if (isToday) dayClasses += ' border-2 border-teal-400';

                calendarHTML += `<div class="${dayClasses}" data-date="${dateString}">${day}</div>`;
            }

            calendarHTML += `</div>`;
            calendarContainer.innerHTML = calendarHTML;
        }

        function initializeRedeFilters() {
            const hasRedeData = allClientsData.some(client => client.ramo && client.ramo !== 'N/A');

            const mainRedeFilterWrapper = document.getElementById('main-rede-filter-wrapper');
            const cityRedeFilterWrapper = document.getElementById('city-rede-filter-wrapper');
            const comparisonRedeFilterWrapper = document.getElementById('comparison-rede-filter-wrapper');
            const stockRedeFilterWrapper = document.getElementById('stock-rede-filter-wrapper');

            if (mainRedeFilterWrapper) mainRedeFilterWrapper.style.display = hasRedeData ? '' : 'none';
            if (cityRedeFilterWrapper) cityRedeFilterWrapper.style.display = hasRedeData ? '' : 'none';
            if (comparisonRedeFilterWrapper) comparisonRedeFilterWrapper.style.display = hasRedeData ? '' : 'none';
            if (stockRedeFilterWrapper) stockRedeFilterWrapper.style.display = hasRedeData ? '' : 'none';
        }

        function debounce(func, delay = 300) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function updateSideNavActiveState(targetViewId) {
            mainNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

            // Lógica especial para 'table-view', que deve ativar o 'main-dashboard'
            const navTargetId = targetViewId === 'table-view' ? 'main-dashboard' : targetViewId;

            const activeButton = mainNav.querySelector(`.nav-btn[data-view="${navTargetId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

        function populateSideMenu() {
            const navConfig = [
                {
                    title: 'Análises Principais',
                    buttons: [
                        { id: 'nav-main-dashboard', text: 'Dashboard Principal', viewId: 'main-dashboard', default: true },
                        { id: 'nav-orders-view', text: 'Pedidos Detalhados', viewId: 'table-view' }
                    ]
                },
                {
                    title: 'Análises Detalhadas',
                    buttons: [
                        { id: 'nav-comparison-view', text: 'Comparativo Mensal', viewId: 'comparison-view' },
                        { id: 'nav-stock-view', text: 'Análise de Estoque', viewId: 'stock-view' },
                        { id: 'nav-coverage-view', text: 'Cobertura de Estoque', viewId: 'coverage-view' },
                        { id: 'nav-innovations-view', text: 'Análise de Inovações', viewId: 'innovations-view' },
                        { id: 'nav-innovations-month-view', text: 'Inovações Mês', viewId: 'innovations-month-view' },
                        { id: 'nav-weekly-view', text: 'Acompanhamento Semanal', viewId: 'weekly-view' },
                        { id: 'nav-city-view', text: 'Análise por Cidade', viewId: 'city-view' }
                    ]
                },
                {
                    title: 'Admin',
                    buttons: [
                        { id: 'nav-admin-uploader', text: 'Uploader de Dados', viewId: 'admin-uploader-modal' }
                    ]
                }
            ];

            mainNav.innerHTML = navConfig.map(section => `
                <div class="nav-section">
                    <h3>${section.title}</h3>
                    ${section.buttons.map(btn => `<button id="${btn.id}" data-view="${btn.viewId}" class="nav-btn ${btn.default ? 'active' : ''}">${btn.text}</button>`).join('')}
                </div>
            `).join('');
        }
        
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle-checkbox');
            const savedTheme = localStorage.getItem('theme') || 'dark';

            document.documentElement.setAttribute('data-theme', savedTheme);
            themeToggle.checked = savedTheme === 'dark';

            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Re-render all charts to apply new theme colors
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};
                
                updateAllVisuals();
                updateCityView();
                updateWeeklyView();
                updateComparisonView();
                updateInnovationsMonthView();
            });
        }

        function setupEventListeners() {
            // Lógica do Menu Retrátil
            const toggleMenu = () => {
                sideMenu.classList.toggle('open');
                menuOverlay.classList.toggle('open');
                menuOverlay.classList.toggle('hidden'); // <-- CORREÇÃO: Adicionado/removido 'hidden'
            };

            menuToggleBtn.addEventListener('click', toggleMenu);
            menuOverlay.addEventListener('click', toggleMenu);

            // Lógica de Navegação
            const allViews = [mainDashboard, tableView, chartView, comparisonView, stockView, coverageView, innovationsView, weeklyView, cityView, innovationsMonthView];

            const switchView = (targetViewId) => {
                let viewToShow = null;
                
                allViews.forEach(view => {
                    // Casos especiais para o dashboard principal
                    if (targetViewId === 'main-dashboard' && (view.id === 'main-dashboard' || view.id === 'chartView')) {
                        view.classList.remove('hidden');
                        if (view.id === 'main-dashboard') viewToShow = view;
                    } 
                    // Caso especial para a tabela de pedidos
                    else if (targetViewId === 'table-view' && (view.id === 'main-dashboard' || view.id === 'tableView')) {
                         view.classList.remove('hidden');
                         if(view.id === 'main-dashboard') viewToShow = view;
                    }
                    // Demais casos
                    else if (view.id === targetViewId) {
                        view.classList.remove('hidden');
                        viewToShow = view;
                    } else {
                        view.classList.add('hidden');
                    }
                });

                // Lógica para mostrar/esconder a tabela vs gráficos no dashboard principal
                if (targetViewId === 'main-dashboard') {
                    chartView.classList.remove('hidden');
                    tableView.classList.add('hidden');
                } else if (targetViewId === 'table-view') {
                    chartView.classList.add('hidden');
                    tableView.classList.remove('hidden');
                }

                return viewToShow;
            };

            mainNav.addEventListener('click', e => {
                if (e.target.matches('.nav-btn')) {
                    const targetViewId = e.target.dataset.view;
                    
                    // ADIÇÃO: Lógica para abrir o modal do admin
                    if (targetViewId === 'admin-uploader-modal') {
                        document.getElementById('admin-uploader-modal').classList.remove('hidden');
                        // Não alterna a view principal, apenas mostra o modal
                        mainNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        toggleMenu(); // Fecha o menu após abrir o modal
                        return; // Interrompe a execução para não tratar como uma troca de view
                    }

                    // Atualiza botão ativo
                    mainNav.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    const view = switchView(targetViewId);

                    // Executa funções de atualização específicas da view
                    if (view) {
                        switch(view.id) {
                            case 'main-dashboard': updateAllVisuals(); break;
                            case 'comparison-view': updateAllComparisonFilters(); updateComparisonView(); break;
                            case 'stock-view': handleStockFilterChange(); break;
                            case 'coverage-view': updateCoverageFilters(); updateCoverageView(); break;
                            case 'innovations-view':
                                populateSupervisors('innovations-supervisor-filter', allSalesData);
                                updateSellerFilter('', innovationsVendedorFilterDropdown, innovationsVendedorFilterText, [], allSalesData);
                                updateSupplierFilter(innovationsSupplierFilterDropdown, innovationsSupplierFilterText, [], allSalesData, 'innovations');
                                updateInnovationsFilters();
                                updateInnovationsView();
                                break;
                            case 'weekly-view': populateWeeklyFilters(); updateWeeklyView(); break;
                            case 'city-view': updateCityView(); break;
                        }
                    }
                    
                    toggleMenu(); // Fecha o menu após a navegação
                }
            });

            // Botões de "Voltar"
            backToMainFromComparisonBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });
            backToMainFromStockBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });
            backToMainFromCoverageBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });
            backToMainFromInnovationsBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });
            backToMainFromWeeklyBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });
            backToMainFromCityBtn.addEventListener('click', () => { switchView('main-dashboard'); updateAllVisuals(); updateSideNavActiveState('main-dashboard'); });

            supervisorFilter.addEventListener('change', () => { selectedSellers = []; updateSellerFilter(supervisorFilter.value, vendedorFilterDropdown, vendedorFilterText, selectedSellers, allSalesData); mainTableState.currentPage = 1; updateAllVisuals(); });
            fornecedorFilter.addEventListener('change', () => { mainTableState.currentPage = 1; updateAllVisuals(); });
            vendedorFilterBtn.addEventListener('click', () => vendedorFilterDropdown.classList.toggle('hidden'));
            vendedorFilterDropdown.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const { value, checked } = e.target; if (checked) selectedSellers.push(value); else selectedSellers = selectedSellers.filter(s => s !== value); selectedSellers = updateSellerFilter(supervisorFilter.value, vendedorFilterDropdown, vendedorFilterText, selectedSellers, allSalesData); mainTableState.currentPage = 1; updateAllVisuals(); } });
            
            tipoVendaFilterBtn.addEventListener('click', () => tipoVendaFilterDropdown.classList.toggle('hidden'));
            tipoVendaFilterDropdown.addEventListener('change', (e) => { 
                if (e.target.type === 'checkbox') { 
                    const { value, checked } = e.target; 
                    if (checked) selectedTiposVenda.push(value); 
                    else selectedTiposVenda = selectedTiposVenda.filter(s => s !== value); 
                    selectedTiposVenda = updateTipoVendaFilter(tipoVendaFilterDropdown, tipoVendaFilterText, selectedTiposVenda, allSalesData); 
                    mainTableState.currentPage = 1; 
                    updateAllVisuals(); 
                } 
            });

            posicaoFilter.addEventListener('change', () => { mainTableState.currentPage = 1; updateAllVisuals(); });
            codcliFilter.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^0-9]/g, ''));
            codcliFilter.addEventListener('change', () => { mainTableState.currentPage = 1; updateAllVisuals(); });
            clearFiltersBtn.addEventListener('click', resetMainFilters);
            
            prevPageBtn.addEventListener('click', () => {
                if (mainTableState.currentPage > 1) {
                    mainTableState.currentPage--;
                    renderTable(mainTableState.filteredData);
                }
            });
            nextPageBtn.addEventListener('click', () => {
                if (mainTableState.currentPage < mainTableState.totalPages) {
                    mainTableState.currentPage++;
                    renderTable(mainTableState.filteredData);
                }
            });

            mainComRedeBtn.addEventListener('click', () => mainRedeFilterDropdown.classList.toggle('hidden'));
            mainRedeGroupContainer.addEventListener('click', (e) => {
                if(e.target.closest('button')) {
                    const button = e.target.closest('button');
                    mainRedeGroupFilter = button.dataset.group;
                    mainRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    if (mainRedeGroupFilter !== 'com_rede') {
                        mainRedeFilterDropdown.classList.add('hidden');
                        selectedMainRedes = [];
                    }
                    updateRedeFilter(mainRedeFilterDropdown, mainComRedeBtnText, selectedMainRedes, allClientsData);
                    mainTableState.currentPage = 1;
                    updateAllVisuals();
                }
            });
            mainRedeFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) selectedMainRedes.push(value);
                    else selectedMainRedes = selectedMainRedes.filter(r => r !== value);
                    selectedMainRedes = updateRedeFilter(mainRedeFilterDropdown, mainComRedeBtnText, selectedMainRedes, allClientsData);
                    mainTableState.currentPage = 1;
                    updateAllVisuals();
                }
            });

            citySupervisorFilter.addEventListener('change', () => { selectedCitySellers = []; selectedCitySellers = updateSellerFilter(citySupervisorFilter.value, cityVendedorFilterDropdown, cityVendedorFilterText, selectedCitySellers, allSalesData); validateCityFilter(); updateCityView(); });
            cityVendedorFilterBtn.addEventListener('click', () => cityVendedorFilterDropdown.classList.toggle('hidden'));
            cityVendedorFilterDropdown.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const { value, checked } = e.target; if (checked) selectedCitySellers.push(value); else selectedCitySellers = selectedCitySellers.filter(s => s !== value); selectedCitySellers = updateSellerFilter(citySupervisorFilter.value, cityVendedorFilterDropdown, cityVendedorFilterText, selectedCitySellers, allSalesData); validateCityFilter(); updateCityView(); } });

            cityComRedeBtn.addEventListener('click', () => cityRedeFilterDropdown.classList.toggle('hidden'));
            cityRedeGroupContainer.addEventListener('click', (e) => {
                if(e.target.closest('button')) {
                    const button = e.target.closest('button');
                    cityRedeGroupFilter = button.dataset.group;
                    cityRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');

                    if (cityRedeGroupFilter !== 'com_rede') {
                        cityRedeFilterDropdown.classList.add('hidden');
                        selectedCityRedes = [];
                    }
                    updateRedeFilter(cityRedeFilterDropdown, cityComRedeBtnText, selectedCityRedes, allClientsData);
                    updateCityView();
                }
            });
            cityRedeFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) selectedCityRedes.push(value);
                    else selectedCityRedes = selectedCityRedes.filter(r => r !== value);

                    cityRedeGroupFilter = 'com_rede';
                    cityRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    cityComRedeBtn.classList.add('active');

                    selectedCityRedes = updateRedeFilter(cityRedeFilterDropdown, cityComRedeBtnText, selectedCityRedes, allClientsData);
                    updateCityView();
                }
            });


            clearCityFiltersBtn.addEventListener('click', resetCityFilters);
            cityCodCliFilter.addEventListener('input', (e) => e.target.value = e.target.value.replace(/[^0-9]/g, ''));
            cityCodCliFilter.addEventListener('change', updateCityView);
            cityNameFilter.addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[0-9]/g, ''); const relevantClients = getRelevantClientsForCityFilter(); updateCitySuggestions(cityNameFilter, citySuggestions, relevantClients); });
            cityNameFilter.addEventListener('focus', () => { const relevantClients = getRelevantClientsForCityFilter(); citySuggestions.classList.remove('manual-hide'); updateCitySuggestions(cityNameFilter, citySuggestions, relevantClients); });
            cityNameFilter.addEventListener('blur', () => setTimeout(() => citySuggestions.classList.add('hidden'), 150));
            cityNameFilter.addEventListener('keydown', (e) => { if (e.key === 'Enter') { citySuggestions.classList.add('hidden', 'manual-hide'); updateCityView(); e.target.blur(); } });

            document.addEventListener('click', (e) => {
                if (!vendedorFilterBtn.contains(e.target) && !vendedorFilterDropdown.contains(e.target)) vendedorFilterDropdown.classList.add('hidden');
                if (!tipoVendaFilterBtn.contains(e.target) && !tipoVendaFilterDropdown.contains(e.target)) tipoVendaFilterDropdown.classList.add('hidden');
                if (!cityVendedorFilterBtn.contains(e.target) && !cityVendedorFilterDropdown.contains(e.target)) cityVendedorFilterDropdown.classList.add('hidden');
                if (!cityComRedeBtn.contains(e.target) && !cityRedeFilterDropdown.contains(e.target)) cityRedeFilterDropdown.classList.add('hidden');
                if (!mainComRedeBtn.contains(e.target) && !mainRedeFilterDropdown.contains(e.target)) mainRedeFilterDropdown.classList.add('hidden');
                if (!comparisonComRedeBtn.contains(e.target) && !comparisonRedeFilterDropdown.contains(e.target)) comparisonRedeFilterDropdown.classList.add('hidden');
                if (!comparisonVendedorFilterBtn.contains(e.target) && !comparisonVendedorFilterDropdown.contains(e.target)) comparisonVendedorFilterDropdown.classList.add('hidden');
                if (!comparisonSupplierFilterBtn.contains(e.target) && !comparisonSupplierFilterDropdown.contains(e.target)) comparisonSupplierFilterDropdown.classList.add('hidden');
                if (!comparisonProductFilterBtn.contains(e.target) && !comparisonProductFilterDropdown.contains(e.target)) comparisonProductFilterDropdown.classList.add('hidden');
                if (!stockComRedeBtn.contains(e.target) && !stockRedeFilterDropdown.contains(e.target)) stockRedeFilterDropdown.classList.add('hidden');
                if (!stockVendedorFilterBtn.contains(e.target) && !stockVendedorFilterDropdown.contains(e.target)) stockVendedorFilterDropdown.classList.add('hidden');
                if (!stockSupplierFilterBtn.contains(e.target) && !stockSupplierFilterDropdown.contains(e.target)) stockSupplierFilterDropdown.classList.add('hidden');
                if (!stockProductFilterBtn.contains(e.target) && !stockProductFilterDropdown.contains(e.target)) stockProductFilterDropdown.classList.add('hidden');
                if (e.target.closest('[data-pedido-id]')) { e.preventDefault(); openModal(e.target.closest('[data-pedido-id]').dataset.pedidoId); }
                if (e.target.closest('[data-codcli]')) { e.preventDefault(); openClientModal(e.target.closest('[data-codcli]').dataset.codcli); }
                if (e.target.closest('#city-suggestions > div')) { cityNameFilter.value = e.target.textContent; citySuggestions.classList.add('hidden'); updateCityView(); }
                if (e.target.closest('#comparison-city-suggestions > div')) { comparisonCityFilter.value = e.target.textContent; comparisonCitySuggestions.classList.add('hidden'); updateAllComparisonFilters(); updateComparisonView(); }
                else if (!comparisonCityFilter.contains(e.target)) comparisonCitySuggestions.classList.add('hidden');
                if (e.target.closest('#stock-city-suggestions > div')) { stockCityFilter.value = e.target.textContent; stockCitySuggestions.classList.add('hidden'); handleStockFilterChange(); }
                else if (!stockCityFilter.contains(e.target)) stockCitySuggestions.classList.add('hidden');
            });

            fornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(btn => { btn.addEventListener('click', () => { const fornecedor = btn.dataset.fornecedor; if (currentFornecedor === fornecedor) { currentFornecedor = ''; btn.classList.remove('active'); } else { currentFornecedor = fornecedor; fornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } populateSupervisors('supervisor-filter', allSalesData); selectedSellers = []; updateSellerFilter(supervisorFilter.value, vendedorFilterDropdown, vendedorFilterText, selectedSellers, allSalesData); mainTableState.currentPage = 1; updateAllVisuals(); }); });
            weeklyFornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(btn => { btn.addEventListener('click', () => { const fornecedor = btn.dataset.fornecedor; if (currentWeeklyFornecedor === fornecedor) { currentWeeklyFornecedor = ''; btn.classList.remove('active'); } else { currentWeeklyFornecedor = fornecedor; weeklyFornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } updateWeeklyView(); }); });
            weeklySupervisorFilter.addEventListener('change', updateWeeklyView);
            clearWeeklyFiltersBtn.addEventListener('click', resetWeeklyFilters);

            const handleComparisonFilterChange = () => {
                updateAllComparisonFilters();
                updateComparisonView();
            };

            comparisonSupervisorFilter.addEventListener('change', handleComparisonFilterChange);
            comparisonFilialFilter.addEventListener('change', handleComparisonFilterChange);
            comparisonVendedorFilterBtn.addEventListener('click', () => comparisonVendedorFilterDropdown.classList.toggle('hidden'));
            comparisonVendedorFilterDropdown.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const { value, checked } = e.target; if (checked) selectedComparisonSellers.push(value); else selectedComparisonSellers = selectedComparisonSellers.filter(s => s !== value); handleComparisonFilterChange(); } });
            comparisonFornecedorToggleContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const fornecedor = e.target.dataset.fornecedor; if (currentComparisonFornecedor === fornecedor) { currentComparisonFornecedor = ''; e.target.classList.remove('active'); } else { currentComparisonFornecedor = fornecedor; comparisonFornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); } handleComparisonFilterChange(); } });
            comparisonSupplierFilterBtn.addEventListener('click', () => comparisonSupplierFilterDropdown.classList.toggle('hidden'));
            comparisonSupplierFilterDropdown.addEventListener('change', (e) => { if (e.target.type === 'checkbox' && e.target.dataset.filterType === 'comparison') { const { value, checked } = e.target; if (checked) selectedComparisonSuppliers.push(value); else selectedComparisonSuppliers = selectedComparisonSuppliers.filter(s => s !== value); handleComparisonFilterChange(); } });

            comparisonComRedeBtn.addEventListener('click', () => comparisonRedeFilterDropdown.classList.toggle('hidden'));
            comparisonRedeGroupContainer.addEventListener('click', (e) => {
                if(e.target.closest('button')) {
                    const button = e.target.closest('button');
                    comparisonRedeGroupFilter = button.dataset.group;
                    comparisonRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    if (comparisonRedeGroupFilter !== 'com_rede') {
                        comparisonRedeFilterDropdown.classList.add('hidden');
                        selectedComparisonRedes = [];
                    }
                    updateRedeFilter(comparisonRedeFilterDropdown, comparisonComRedeBtnText, selectedComparisonRedes, allClientsData);
                    handleComparisonFilterChange();
                }
            });
            comparisonRedeFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) selectedComparisonRedes.push(value);
                    else selectedComparisonRedes = selectedComparisonRedes.filter(r => r !== value);

                    comparisonRedeGroupFilter = 'com_rede';
                    comparisonRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    comparisonComRedeBtn.classList.add('active');

                    selectedComparisonRedes = updateRedeFilter(comparisonRedeFilterDropdown, comparisonComRedeBtnText, selectedComparisonRedes, allClientsData);
                    handleComparisonFilterChange();
                }
            });

            comparisonCityFilter.addEventListener('input', () => {
                const { currentSales, historySales } = getComparisonFilteredData({ excludeFilter: 'city' });
                updateComparisonCitySuggestions([...currentSales, ...historySales]);
            });
            comparisonCityFilter.addEventListener('focus', () => {
                const { currentSales, historySales } = getComparisonFilteredData({ excludeFilter: 'city' });
                updateComparisonCitySuggestions([...currentSales, ...historySales]);
            });
            comparisonCityFilter.addEventListener('change', handleComparisonFilterChange);

            clearComparisonFiltersBtn.addEventListener('click', resetComparisonFilters);

            const handleProductFilterChange = (e, selectedArray) => {
                 if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedArray.includes(value)) selectedArray.push(value);
                    } else {
                        const index = selectedArray.indexOf(value);
                        if (index > -1) selectedArray.splice(index, 1);
                    }
                    return true;
                }
                return false;
            }

            comparisonProductFilterBtn.addEventListener('click', () => {
                updateComparisonProductFilter();
                comparisonProductFilterDropdown.classList.toggle('hidden');
            });
            
            const debouncedComparisonProductSearch = debounce(updateComparisonProductFilter, 250);
            comparisonProductFilterDropdown.addEventListener('input', (e) => {
                if (e.target.id === 'comparison-product-search-input') {
                    debouncedComparisonProductSearch();
                }
            });
            comparisonProductFilterDropdown.addEventListener('change', (e) => {
                if(e.target.dataset.filterType === 'comparison' && handleProductFilterChange(e, selectedComparisonProducts)) {
                    handleComparisonFilterChange();
                    updateComparisonProductFilter();
                }
            });
            stockProductFilterBtn.addEventListener('click', () => {
                updateStockProductFilter();
                stockProductFilterDropdown.classList.toggle('hidden');
            });

            const debouncedStockProductSearch = debounce(updateStockProductFilter, 250);
            stockProductFilterDropdown.addEventListener('input', (e) => {
                if (e.target.id === 'stock-product-search-input') {
                    debouncedStockProductSearch();
                }
            });

            stockProductFilterDropdown.addEventListener('change', (e) => {
                if(e.target.dataset.filterType === 'stock' && handleProductFilterChange(e, selectedStockProducts)) {
                    handleStockFilterChange();
                    updateStockProductFilter();
                }
            });
        
            stockFilialFilter.addEventListener('change', handleStockFilterChange);
            clearStockFiltersBtn.addEventListener('click', resetStockFilters);
            stockFornecedorToggleContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { const fornecedor = e.target.dataset.fornecedor; if (currentStockFornecedor === fornecedor) { currentStockFornecedor = ''; e.target.classList.remove('active'); } else { currentStockFornecedor = fornecedor; stockFornecedorToggleContainer.querySelectorAll('.fornecedor-btn').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); } handleStockFilterChange(); } });
            stockSupervisorFilter.addEventListener('change', handleStockFilterChange);
            stockVendedorFilterBtn.addEventListener('click', () => stockVendedorFilterDropdown.classList.toggle('hidden'));
            stockVendedorFilterDropdown.addEventListener('change', (e) => { if (e.target.type === 'checkbox') { const { value, checked } = e.target; if (checked) selectedStockSellers.push(value); else selectedStockSellers = selectedStockSellers.filter(s => s !== value); handleStockFilterChange(); } });
            stockSupplierFilterBtn.addEventListener('click', () => stockSupplierFilterDropdown.classList.toggle('hidden'));
            stockSupplierFilterDropdown.addEventListener('change', (e) => { if (e.target.dataset.filterType === 'stock' && e.target.type === 'checkbox') { const { value, checked } = e.target; if (checked) { if(!selectedStockSuppliers.includes(value)) selectedStockSuppliers.push(value); } else { selectedStockSuppliers = selectedStockSuppliers.filter(s => s !== value); } handleStockFilterChange(); } });

            const debouncedStockCityUpdate = debounce(() => {
                const cityData = getStockFilteredData({ excludeFilter: 'city' });
                updateStockCitySuggestions([...cityData.sales, ...cityData.history]);
            }, 300);
            stockCityFilter.addEventListener('input', debouncedStockCityUpdate);
            stockCityFilter.addEventListener('focus', debouncedStockCityUpdate);
            stockCityFilter.addEventListener('change', handleStockFilterChange);

            stockComRedeBtn.addEventListener('click', () => stockRedeFilterDropdown.classList.toggle('hidden'));
            stockRedeGroupContainer.addEventListener('click', (e) => {
                if(e.target.closest('button')) {
                    const button = e.target.closest('button');
                    stockRedeGroupFilter = button.dataset.group;
                    stockRedeGroupContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    if (stockRedeGroupFilter !== 'com_rede') {
                        stockRedeFilterDropdown.classList.add('hidden');
                        selectedStockRedes = [];
                    }
                    updateRedeFilter(stockRedeFilterDropdown, stockComRedeBtnText, selectedStockRedes, allClientsData, 'Com Rede');
                    handleStockFilterChange();
                }
            });
            stockRedeFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) selectedStockRedes.push(value);
                    else selectedStockRedes = selectedStockRedes.filter(r => r !== value);
                    selectedStockRedes = updateRedeFilter(stockRedeFilterDropdown, stockComRedeBtnText, selectedStockRedes, allClientsData, 'Com Rede');
                    handleStockFilterChange();
                }
            });


            comparisonTendencyToggle.addEventListener('click', () => {
                useTendencyComparison = !useTendencyComparison;
                comparisonTendencyToggle.textContent = useTendencyComparison ? 'Ver Dados Reais' : 'Calcular Tendência';
                comparisonTendencyToggle.classList.toggle('bg-orange-600');
                comparisonTendencyToggle.classList.toggle('hover:bg-orange-500');
                comparisonTendencyToggle.classList.toggle('bg-purple-600');
                comparisonTendencyToggle.classList.toggle('hover:bg-purple-500');
                updateComparisonView();
            });

            toggleWeeklyBtn.addEventListener('click', () => {
                comparisonChartType = 'weekly';
                toggleWeeklyBtn.classList.add('active');
                toggleMonthlyBtn.classList.remove('active');
                updateComparisonView();
            });

            toggleMonthlyBtn.addEventListener('click', () => {
                comparisonChartType = 'monthly';
                toggleMonthlyBtn.classList.add('active');
                toggleWeeklyBtn.classList.remove('active');
                updateComparisonView();
            });

            mainHolidayPickerBtn.addEventListener('click', () => {
                renderCalendar(calendarState.year, calendarState.month);
                holidayModal.classList.remove('hidden');
            });
            comparisonHolidayPickerBtn.addEventListener('click', () => {
                renderCalendar(calendarState.year, calendarState.month);
                holidayModal.classList.remove('hidden');
            });
            holidayModalCloseBtn.addEventListener('click', () => holidayModal.classList.add('hidden'));
            holidayModalDoneBtn.addEventListener('click', () => {
                holidayModal.classList.add('hidden');
                const holidayBtnText = selectedHolidays.length > 0 ? `${selectedHolidays.length} feriado(s)` : 'Selecionar Feriados';
                comparisonHolidayPickerBtn.textContent = holidayBtnText;
                mainHolidayPickerBtn.textContent = holidayBtnText;
                updateComparisonView();
                updateAllVisuals();
            });
            calendarContainer.addEventListener('click', (e) => {
                if (e.target.id === 'prev-month-btn') {
                    calendarState.month--;
                    if (calendarState.month < 0) {
                        calendarState.month = 11;
                        calendarState.year--;
                    }
                    renderCalendar(calendarState.year, calendarState.month);
                } else if (e.target.id === 'next-month-btn') {
                    calendarState.month++;
                    if (calendarState.month > 11) {
                        calendarState.month = 0;
                        calendarState.year++;
                    }
                    renderCalendar(calendarState.year, calendarState.month);
                } else if (e.target.dataset.date) {
                    const dateString = e.target.dataset.date;
                    const index = selectedHolidays.indexOf(dateString);
                    if (index > -1) {
                        selectedHolidays.splice(index, 1);
                    } else {
                        selectedHolidays.push(dateString);
                    }
                    renderCalendar(calendarState.year, calendarState.month);
                }
            });


            document.getElementById('export-active-pdf-btn').addEventListener('click', () => exportClientsPDF(activeClientsForExport, 'Relatório de Clientes Ativos no Mês', 'clientes_ativos', true));
            document.getElementById('export-inactive-pdf-btn').addEventListener('click', () => exportClientsPDF(inactiveClientsForExport, 'Relatório de Clientes Sem Vendas no Mês', 'clientes_sem_vendas', false));
            modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));
            clientModalCloseBtn.addEventListener('click', () => clientModal.classList.add('hidden'));
            faturamentoBtn.addEventListener('click', () => { currentProductMetric = 'faturamento'; faturamentoBtn.classList.add('active'); pesoBtn.classList.remove('active'); updateAllVisuals(); });
            pesoBtn.addEventListener('click', () => { currentProductMetric = 'peso'; pesoBtn.classList.add('active'); faturamentoBtn.classList.remove('active'); updateAllVisuals(); });

            const debouncedUpdateInnovations = debounce(() => {
                updateInnovationsFilters();
                updateInnovationsView();
            }, 400);

            /*
            // CORREÇÃO: Botão 'viewInnovationsBtn' não existe mais, foi substituído pelo menu lateral.
            viewInnovationsBtn.addEventListener('click', () => {
                mainDashboard.classList.add('hidden');
                innovationsView.classList.remove('hidden');
                populateSupervisors('innovations-supervisor-filter', allSalesData);
                updateSellerFilter('', innovationsVendedorFilterDropdown, innovationsVendedorFilterText, [], allSalesData);
                updateSupplierFilter(innovationsSupplierFilterDropdown, innovationsSupplierFilterText, [], allSalesData, 'innovations');
                updateInnovationsFilters();
                updateInnovationsView();
            });
            */

            backToMainFromInnovationsBtn.addEventListener('click', () => {
                innovationsView.classList.add('hidden');
                mainDashboard.classList.remove('hidden');
                updateAllVisuals();
            });

            const openInnovationsMonthView = () => {
                switchView('innovations-month-view');
                populateSupervisors('innovations-month-supervisor-filter', allSalesData);
                updateSellerFilter('', innovationsMonthVendedorFilterDropdown, innovationsMonthVendedorFilterText, [], allSalesData);
                updateInnovationsMonthView();
            };

            innovationsMonthBtn.addEventListener('click', openInnovationsMonthView);
            
            mainNav.addEventListener('click', e => {
                if (e.target.id === 'nav-innovations-month-view') {
                    openInnovationsMonthView();
                }
            });

            backToInnovationsFromMonthBtn.addEventListener('click', () => {
                switchView('main-dashboard');
                updateAllVisuals();
                updateSideNavActiveState('main-dashboard');
            });

            innovationsMonthCategoryFilter.addEventListener('change', updateInnovationsMonthView);
            innovationsFilialFilter.addEventListener('change', debouncedUpdateInnovations);
            innovationsIncludeBonusCheckbox.addEventListener('change', (e) => {
                innovationsIncludeBonus = e.target.checked;
                updateInnovationsView();
            });

            innovationsSupervisorFilter.addEventListener('change', () => {
                selectedInnovationsSellers = [];
                updateSellerFilter(innovationsSupervisorFilter.value, innovationsVendedorFilterDropdown, innovationsVendedorFilterText, selectedInnovationsSellers, allSalesData);
                debouncedUpdateInnovations();
            });

            innovationsCityFilter.addEventListener('input', () => {
                const cityDataSource = getInnovationsFilteredData().clients;
                updateCitySuggestions(innovationsCityFilter, innovationsCitySuggestions, cityDataSource);
                // Apenas atualiza as sugestões, não dispara o filtro ainda
            });
            innovationsCityFilter.addEventListener('change', debouncedUpdateInnovations);
            innovationsCityFilter.addEventListener('focus', () => {
                const cityDataSource = getInnovationsFilteredData().clients;
                innovationsCitySuggestions.classList.remove('manual-hide');
                updateCitySuggestions(innovationsCityFilter, innovationsCitySuggestions, cityDataSource);
            });
             innovationsCityFilter.addEventListener('blur', () => setTimeout(() => innovationsCitySuggestions.classList.add('hidden'), 150));
            innovationsCitySuggestions.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    innovationsCityFilter.value = e.target.textContent;
                    innovationsCitySuggestions.classList.add('hidden');
                    debouncedUpdateInnovations();
                }
            });


            clearInnovationsFiltersBtn.addEventListener('click', resetInnovationsFilters);

            innovationsVendedorFilterBtn.addEventListener('click', () => innovationsVendedorFilterDropdown.classList.toggle('hidden'));
            innovationsVendedorFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedInnovationsSellers.includes(value)) selectedInnovationsSellers.push(value);
                    } else {
                        selectedInnovationsSellers = selectedInnovationsSellers.filter(s => s !== value);
                    }
                    updateSellerFilter(innovationsSupervisorFilter.value, innovationsVendedorFilterDropdown, innovationsVendedorFilterText, selectedInnovationsSellers, allSalesData);
                    debouncedUpdateInnovations();
                }
            });

            innovationsSupplierFilterBtn.addEventListener('click', () => innovationsSupplierFilterDropdown.classList.toggle('hidden'));
            innovationsSupplierFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox' && e.target.dataset.filterType === 'innovations') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedInnovationsSuppliers.includes(value)) selectedInnovationsSuppliers.push(value);
                    } else {
                        selectedInnovationsSuppliers = selectedInnovationsSuppliers.filter(s => s !== value);
                    }
                    updateSupplierFilter(innovationsSupplierFilterDropdown, innovationsSupplierFilterText, selectedInnovationsSuppliers, allSalesData, 'innovations');

                    const supplierProducts = new Set();
                    selectedInnovationsSuppliers.forEach(codfor => {
                        (optimizedData.productsBySupplier.get(codfor) || []).forEach(prod => supplierProducts.add(prod));
                    });
                    selectedInnovationsProducts = Array.from(supplierProducts);

                    debouncedUpdateInnovations();
                }
            });

            innovationsProductFilterBtn.addEventListener('click', () => {
                updateInnovationsFilters();
                innovationsProductFilterDropdown.classList.toggle('hidden');
            });

            const debouncedInnovationsProductSearch = debounce(updateInnovationsFilters, 250);

            innovationsProductFilterDropdown.addEventListener('input', (e) => {
                if (e.target.id === 'innovations-product-search-input') {
                    debouncedInnovationsProductSearch();
                }
            });

            innovationsProductFilterDropdown.addEventListener('change', (e) => {
                if (e.target.dataset.filterType === 'innovations' && handleProductFilterChange(e, selectedInnovationsProducts)) {
                    debouncedUpdateInnovations();
                }
            });

            const debouncedUpdateInnovationsMonth = debounce(updateInnovationsMonthView, 400);
            innovationsMonthIncludeBonusCheckbox.addEventListener('change', (e) => {
                innovationsMonthIncludeBonus = e.target.checked;
                updateInnovationsMonthView();
            });

            innovationsMonthSupervisorFilter.addEventListener('change', () => {
                selectedInnovationsMonthSellers = [];
                updateSellerFilter(innovationsMonthSupervisorFilter.value, innovationsMonthVendedorFilterDropdown, innovationsMonthVendedorFilterText, selectedInnovationsMonthSellers, allSalesData);
                debouncedUpdateInnovationsMonth();
            });

            innovationsMonthVendedorFilterBtn.addEventListener('click', () => innovationsMonthVendedorFilterDropdown.classList.toggle('hidden'));
            innovationsMonthVendedorFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedInnovationsMonthSellers.includes(value)) selectedInnovationsMonthSellers.push(value);
                    } else {
                        selectedInnovationsMonthSellers = selectedInnovationsMonthSellers.filter(s => s !== value);
                    }
                    updateSellerFilter(innovationsMonthSupervisorFilter.value, innovationsMonthVendedorFilterDropdown, innovationsMonthVendedorFilterText, selectedInnovationsMonthSellers, allSalesData);
                    debouncedUpdateInnovationsMonth();
                }
            });

            innovationsMonthCityFilter.addEventListener('input', () => {
                const cityDataSource = getInnovationsMonthFilteredData().clients;
                updateCitySuggestions(innovationsMonthCityFilter, innovationsMonthCitySuggestions, cityDataSource);
                debouncedUpdateInnovationsMonth();
            });
            innovationsMonthCityFilter.addEventListener('focus', () => {
                const cityDataSource = getInnovationsMonthFilteredData().clients;
                innovationsMonthCitySuggestions.classList.remove('manual-hide');
                updateCitySuggestions(innovationsMonthCityFilter, innovationsMonthCitySuggestions, cityDataSource);
            });
            innovationsMonthCityFilter.addEventListener('blur', () => setTimeout(() => innovationsMonthCitySuggestions.classList.add('hidden'), 150));
            innovationsMonthCitySuggestions.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    innovationsMonthCityFilter.value = e.target.textContent;
                    innovationsMonthCitySuggestions.classList.add('hidden');
                    debouncedUpdateInnovationsMonth();
                }
            });

            innovationsMonthFilialFilter.addEventListener('change', debouncedUpdateInnovationsMonth);
            clearInnovationsMonthFiltersBtn.addEventListener('click', resetInnovationsMonthFilters);
            exportInnovationsMonthPdfBtn.addEventListener('click', exportInnovationsMonthPDF);

            /*
            // CORREÇÃO: Botão 'viewCoverageBtn' não existe mais, foi substituído pelo menu lateral.
            viewCoverageBtn.addEventListener('click', () => {
                mainDashboard.classList.add('hidden');
                coverageView.classList.remove('hidden');
                populateSupervisors('coverage-supervisor-filter', allSalesData);
                updateSellerFilter('', coverageVendedorFilterDropdown, coverageVendedorFilterText, [], allSalesData);
                updateSupplierFilter(coverageSupplierFilterDropdown, coverageSupplierFilterText, [], allSalesData, 'coverage');
                updateCoverageFilters();
                updateCoverageView();
            });
            */

            backToMainFromCoverageBtn.addEventListener('click', () => {
                coverageView.classList.add('hidden');
                mainDashboard.classList.remove('hidden');
                updateAllVisuals();
            });

            const debouncedUpdateCoverage = debounce(() => {
                updateCoverageFilters();
                updateCoverageView();
            }, 400);

            coverageFilialFilter.addEventListener('change', debouncedUpdateCoverage);
            coverageIncludeBonusCheckbox.addEventListener('change', (e) => {
                coverageIncludeBonus = e.target.checked;
                updateCoverageView();
            });

            coverageSupervisorFilter.addEventListener('change', () => {
                selectedCoverageSellers = [];
                updateSellerFilter(coverageSupervisorFilter.value, coverageVendedorFilterDropdown, coverageVendedorFilterText, selectedCoverageSellers, allSalesData);
                debouncedUpdateCoverage();
            });

            coverageCityFilter.addEventListener('input', () => {
                const cityDataSource = getCoverageFilteredData().clients;
                updateCitySuggestions(coverageCityFilter, coverageCitySuggestions, cityDataSource);
                debouncedUpdateCoverage();
            });
            coverageCityFilter.addEventListener('focus', () => {
                const cityDataSource = getCoverageFilteredData().clients;
                coverageCitySuggestions.classList.remove('manual-hide');
                updateCitySuggestions(coverageCityFilter, coverageCitySuggestions, cityDataSource);
            });
            coverageCityFilter.addEventListener('blur', () => setTimeout(() => coverageCitySuggestions.classList.add('hidden'), 150));
            coverageCitySuggestions.addEventListener('click', (e) => {
                if (e.target.tagName === 'DIV') {
                    coverageCityFilter.value = e.target.textContent;
                    coverageCitySuggestions.classList.add('hidden');
                    debouncedUpdateCoverage();
                }
            });

            clearCoverageFiltersBtn.addEventListener('click', resetCoverageFilters);

            coverageVendedorFilterBtn.addEventListener('click', () => coverageVendedorFilterDropdown.classList.toggle('hidden'));
            coverageVendedorFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedCoverageSellers.includes(value)) selectedCoverageSellers.push(value);
                    } else {
                        selectedCoverageSellers = selectedCoverageSellers.filter(s => s !== value);
                    }
                    updateSellerFilter(coverageSupervisorFilter.value, coverageVendedorFilterDropdown, coverageVendedorFilterText, selectedCoverageSellers, allSalesData);
                    debouncedUpdateCoverage();
                }
            });

            coverageSupplierFilterBtn.addEventListener('click', () => coverageSupplierFilterDropdown.classList.toggle('hidden'));
            coverageSupplierFilterDropdown.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox' && e.target.dataset.filterType === 'coverage') {
                    const { value, checked } = e.target;
                    if (checked) {
                        if (!selectedCoverageSuppliers.includes(value)) selectedCoverageSuppliers.push(value);
                    } else {
                        selectedCoverageSuppliers = selectedCoverageSuppliers.filter(s => s !== value);
                    }
                    updateSupplierFilter(coverageSupplierFilterDropdown, coverageSupplierFilterText, selectedCoverageSuppliers, allSalesData, 'coverage');
                    
                    const supplierProducts = new Set();
                    selectedCoverageSuppliers.forEach(codfor => {
                        (optimizedData.productsBySupplier.get(codfor) || []).forEach(prod => supplierProducts.add(prod));
                    });
                    selectedCoverageProducts = Array.from(supplierProducts);

                    debouncedUpdateCoverage();
                }
            });

            coverageProductFilterBtn.addEventListener('click', () => {
                updateCoverageFilters();
                coverageProductFilterDropdown.classList.toggle('hidden');
            });

            const debouncedCoverageProductSearch = debounce(updateCoverageFilters, 250);

            coverageProductFilterDropdown.addEventListener('input', (e) => {
                if (e.target.id === 'coverage-product-search-input') {
                    debouncedCoverageProductSearch();
                }
            });

            coverageProductFilterDropdown.addEventListener('change', (e) => {
                if (e.target.dataset.filterType === 'coverage' && handleProductFilterChange(e, selectedCoverageProducts)) {
                    debouncedUpdateCoverage();
                }
            });


            document.addEventListener('click', (e) => {
                if (!innovationsVendedorFilterBtn.contains(e.target) && !innovationsVendedorFilterDropdown.contains(e.target)) innovationsVendedorFilterDropdown.classList.add('hidden');
                if (!innovationsSupplierFilterBtn.contains(e.target) && !innovationsSupplierFilterDropdown.contains(e.target)) innovationsSupplierFilterDropdown.classList.add('hidden');
                if (!innovationsProductFilterBtn.contains(e.target) && !innovationsProductFilterDropdown.contains(e.target)) innovationsProductFilterDropdown.classList.add('hidden');
                if (!innovationsMonthVendedorFilterBtn.contains(e.target) && !innovationsMonthVendedorFilterDropdown.contains(e.target)) innovationsMonthVendedorFilterDropdown.classList.add('hidden');
                if (!coverageVendedorFilterBtn.contains(e.target) && !coverageVendedorFilterDropdown.contains(e.target)) coverageVendedorFilterDropdown.classList.add('hidden');
                if (!coverageSupplierFilterBtn.contains(e.target) && !coverageSupplierFilterDropdown.contains(e.target)) coverageSupplierFilterDropdown.classList.add('hidden');
                if (!coverageProductFilterBtn.contains(e.target) && !coverageProductFilterDropdown.contains(e.target)) coverageProductFilterDropdown.classList.add('hidden');
            });

            const stockWorkingDaysInput = document.getElementById('stock-working-days-input');
            if (stockWorkingDaysInput) {
                stockWorkingDaysInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const value = parseInt(e.target.value);
                        if (!isNaN(value) && value > 0 && value <= maxWorkingDaysStock) {
                            customWorkingDaysStock = value;
                        } else {
                             e.target.value = customWorkingDaysStock;
                        }
                        handleStockFilterChange();
                        e.target.blur(); // <-- ADICIONADO: Remove o foco do input após pressionar Enter
                    }
                });
                stockWorkingDaysInput.addEventListener('blur', (e) => {
                    const value = parseInt(e.target.value);
                     if (isNaN(value) || value <= 0 || value > maxWorkingDaysStock) {
                         e.target.value = customWorkingDaysStock;
                    } else if (value !== customWorkingDaysStock) {

                        customWorkingDaysStock = value;
                        handleStockFilterChange();
                    }
                });
            }

            document.querySelectorAll('.stock-trend-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    stockTrendFilter = btn.dataset.trend;
                    document.querySelectorAll('.stock-trend-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    handleStockFilterChange();
                });
            });
        }

        initializeOptimizedDataStructures();
        calculateHistoricalBests(); // <-- MOVIDA PARA CIMA
        populateSupervisors('supervisor-filter', allSalesData);
        populateMainSupplierFilter('fornecedor-filter', [...allSalesData, ...allHistoryData]);
        populateSupervisors('city-supervisor-filter', allSalesData);
        populateSupervisors('stock-supervisor-filter', [...allSalesData, ...allHistoryData]);
        updateSellerFilter('', vendedorFilterDropdown, vendedorFilterText, selectedSellers, allSalesData);
        updateTipoVendaFilter(tipoVendaFilterDropdown, tipoVendaFilterText, selectedTiposVenda, allSalesData);
        updateSellerFilter('', cityVendedorFilterDropdown, cityVendedorFilterText, selectedCitySellers, allSalesData);

        updateRedeFilter(mainRedeFilterDropdown, mainComRedeBtnText, selectedMainRedes, allClientsData);
        updateRedeFilter(cityRedeFilterDropdown, cityComRedeBtnText, selectedCityRedes, allClientsData);
        updateRedeFilter(comparisonRedeFilterDropdown, comparisonComRedeBtnText, selectedComparisonRedes, allClientsData);
        updateRedeFilter(stockRedeFilterDropdown, stockComRedeBtnText, selectedStockRedes, allClientsData, 'Com Rede');

        updateAllComparisonFilters();

        updateStockSellerFilter();
        updateStockSupplierFilter();
        updateStockProductFilter();
        updateStockCitySuggestions([...allSalesData, ...allHistoryData]);

        initializeRedeFilters();
        populateSideMenu();
        initializeTheme();
        setupEventListeners();
        
        // Assegura que os dados históricos estão prontos antes da primeira renderização
        // calculateHistoricalBests(); // <-- REMOVIDA DAQUI
        
        updateAllVisuals();
        renderTable(aggregatedOrders);
    </script>

    <!-- Script do Uploader -->
    <script id="worker-script" type="text/worker-javascript">
        self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');

        // --- Funções de Ajuda (parseDate, parseBrazilianNumber, readFile) ---
        // (Sem alterações nestas funções)
        function parseDate(dateString) {
            if (!dateString) return null;
            if (dateString instanceof Date) {
                return !isNaN(dateString.getTime()) ? dateString : null;
            }
            if (typeof dateString === 'number') {
                return new Date(Math.round((dateString - 25569) * 86400 * 1000));
            }
            if (typeof dateString !== 'string') return null;

            if (dateString.length === 10 && dateString.charAt(2) === '/' && dateString.charAt(5) === '/') {
                const [day, month, year] = dateString.split('/');
                if (year.length === 4) {
                    return new Date(`${year}-${month}-${day}T00:00:00`);
                }
            }

            const isoDate = new Date(dateString);
            return !isNaN(isoDate.getTime()) ? isoDate : null;
        }

        function parseBrazilianNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string' || !value) return 0;

            let numberString = value.replace(/R\$\s?/g, '').trim();

            const lastComma = numberString.lastIndexOf(',');
            const lastDot = numberString.lastIndexOf('.');

            if (lastComma > lastDot) {
                numberString = numberString.replace(/\./g, '').replace(',', '.');
            } else {
                numberString = numberString.replace(/,/g, '');
            }

            const number = parseFloat(numberString);
            return isNaN(number) ? 0 : number;
        }

        const readFile = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) {
                    // Se o arquivo for 'null' ou 'undefined', resolve com array vazio.
                    // Isto é crucial para o upload parcial.
                    resolve([]);
                    return;
                }
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        let jsonData;
                        const data = event.target.result;
                        if (file.name.endsWith('.csv')) {
                            let decodedData;
                            try {
                                decodedData = new TextDecoder('utf-8', { fatal: true }).decode(new Uint8Array(data));
                            } catch (e) {
                                decodedData = new TextDecoder('iso-8859-1').decode(new Uint8Array(data));
                            }

                            const lines = decodedData.split(/\r?\n/).filter(line => line.trim() !== '');
                            if (lines.length < 1) {
                                resolve([]);
                                return;
                            };

                            const firstLine = lines[0];
                            // Detecção de delimitador robusta
                            const delimiters = [';', ',', '\t', '|'];
                            let bestDelimiter = ',';
                            let maxCount = 0;
                            delimiters.forEach(d => {
                                const count = (firstLine.match(new RegExp(`\\${d}`, 'g')) || []).length;
                                if (count > maxCount) {
                                    maxCount = count;
                                    bestDelimiter = d;
                                }
                            });

                            // CORREÇÃO para CSV '5. INOVAÇÕES.csv' que usa ';'
                            if (file.name.toUpperCase().includes("INOVA")) {
                                if (firstLine.includes(';')) bestDelimiter = ';';
                            }

                            const headers = lines.shift().trim().split(bestDelimiter).map(h => h.replace(/"/g, '').trim().replace(/^\uFEFF/, ''));

                            jsonData = lines.map(line => {
                                const values = line.split(bestDelimiter);
                                let row = {};
                                for (let i = 0; i < headers.length; i++) {
                                    row[headers[i]] = (values[i] || '').replace(/"/g, '').trim();
                                }
                                return row;
                            });
                        } else {
                            const workbook = XLSX.read(new Uint8Array(data), {type: 'array'});
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            jsonData = XLSX.utils.sheet_to_json(worksheet, { raw: false, cellDates: false });
                        }
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error(`Erro ao ler o arquivo '${file.name}'.`));
                reader.readAsArrayBuffer(file);
            });
        };
        // --- Fim das Funções de Ajuda ---


        // Esta função (processSalesData) depende
        // dos mapas (clientMap, productMasterMap).
        // Se eles estiverem vazios, os dados de vendas
        // ficarão 'N/A' ou com valores padrão.
        const processSalesData = (rawData, clientMap, productMasterMap, newRcaSupervisorMap) => {
            return rawData.map(rawRow => {
                const codCliStr = String(rawRow['CODCLI']).trim();
                const clientInfo = clientMap.get(codCliStr) || {};

                let vendorName = String(rawRow['NOME'] || '');
                let supervisorName = String(rawRow['SUPERV'] || '');
                let codUsur = String(rawRow['CODUSUR'] || '').trim();
                let codSupervisor = String(rawRow['CODSUPERVISOR'] || '').trim();
                const pedido = String(rawRow['PEDIDO'] || '');
                let isAmericanas = false;

                const nomeClienteParaLogica = (clientInfo.razaosocial || clientInfo.fantasia || clientInfo.nomecliente || '').trim().toUpperCase();
                if (nomeClienteParaLogica.includes('AMERICANAS S.A')) {
                    vendorName = 'AMERICANAS';
                    codUsur = '1001';
                    supervisorName = 'BALCAO';
                    codSupervisor = '';
                    isAmericanas = true;

                    if (clientInfo.rcas) {
                         clientInfo.rca1 = '1001';
                         if (!clientInfo.rcas.includes('1001')) {
                            clientInfo.rcas.unshift('1001');
                         }
                    }
                }

                if (!isAmericanas) {
                    const rca1Cliente = (clientInfo.rca1 || '').trim();
                    const codUsurVenda = codUsur;
                    const codUsurParaBusca = rca1Cliente || codUsurVenda;
                    const rcaInfo = newRcaSupervisorMap.get(codUsurParaBusca);

                    if (rcaInfo) {
                        vendorName = rcaInfo.NOME;
                        supervisorName = rcaInfo.SUPERV;
                        codSupervisor = rcaInfo.CODSUPERVISOR;
                        codUsur = codUsurParaBusca;
                    }
                    else if (rca1Cliente && rca1Cliente !== codUsurVenda) {
                        const fallbackInfo = newRcaSupervisorMap.get(codUsurVenda);
                        if (fallbackInfo) {
                            vendorName = fallbackInfo.NOME;
                            supervisorName = fallbackInfo.SUPERV;
                            codSupervisor = fallbackInfo.CODSUPERVISOR;
                            codUsur = codUsurVenda;
                        } else {
                            codUsur = codUsurVenda;
                        }
                    }
                    else {
                        codUsur = codUsurVenda;
                    }
                }

                const supervisorUpper = (supervisorName || '').trim().toUpperCase();
                if (supervisorUpper === 'BALCAO' || supervisorUpper === 'BALCÃO') supervisorName = 'BALCAO';

                let dtPed = rawRow['DTPED'];
                const dtSaida = rawRow['DTSAIDA'];
                const parsedDtPed = parseDate(dtPed);
                const parsedDtSaida = parseDate(dtSaida);
                if (parsedDtPed && parsedDtSaida && (parsedDtPed.getFullYear() < parsedDtSaida.getFullYear() || (parsedDtPed.getFullYear() === parsedDtSaida.getFullYear() && parsedDtPed.getMonth() < parsedDtSaida.getMonth()))) {
                    dtPed = dtSaida;
                }
                const productCode = String(rawRow['PRODUTO'] || '').trim();
                // Se productMasterMap estiver vazio (sem arquivo de produtos), qtdeMaster será 1.
                const qtdeMaster = productMasterMap.get(productCode) || 1;
                const qtVenda = parseInt(String(rawRow['QTVENDA'] || '0').trim(), 10) || 0;

                const tipoVenda = String(rawRow['TIPOVENDA'] || 'N/A').trim();
                const isFaturamento = (tipoVenda === '1' || tipoVenda === '9');
                const vlVendaOriginal = parseBrazilianNumber(rawRow['VLVENDA']);
                const vlBonificOriginal = parseBrazilianNumber(rawRow['VLBONIFIC']);
                const pesoOriginal = parseBrazilianNumber(rawRow['TOTPESOLIQ']);

                let filialValue = String(rawRow['FILIAL'] || '').trim();
                if (filialValue === '5') filialValue = '05';
                if (filialValue === '8') filialValue = '08';

                return {
                    pedido: pedido,
                    nome: vendorName,
                    superv: supervisorName,
                    produto: productCode,
                    descricao: String(rawRow['DESCRICAO'] || ''),
                    fornecedor: String(rawRow['FORNECEDOR'] || ''),
                    observacaofor: String(rawRow['OBSERVACAOFOR'] || '').trim(),
                    codfor: String(rawRow['CODFOR'] || '').trim(),
                    codusur: codUsur,
                    codcli: codCliStr,
                    // Se clientMap estiver vazio, clientInfo.nomeCliente será 'undefined'
                    // e o '|| N/A' será usado.
                    cliente_nome: clientInfo.nomeCliente || 'N/A',
                    cidade: clientInfo.cidade || 'N/A',
                    bairro: clientInfo.bairro || 'N/A',
                    qtvenda: qtVenda,
                    vlvenda: isFaturamento ? vlVendaOriginal : 0,
                    vlbonific: isFaturamento ? vlBonificOriginal : (vlVendaOriginal + vlBonificOriginal),
                    totpesoliq: pesoOriginal,
                    dtped: dtPed,
                    dtsaida: dtSaida,
                    posicao: String(rawRow['POSICAO'] || ''),
                    estoqueunit: parseBrazilianNumber(rawRow['ESTOQUEUNIT']),
                    qtvenda_embalagem_master: isNaN(qtdeMaster) || qtdeMaster === 0 ? 0 : qtVenda / qtdeMaster,
                    tipovenda: tipoVenda,
                    filial: filialValue,
                    codsupervisor: codSupervisor
                };
            });
        };

        function getPassedWorkingDaysInSpecificMonth(year, month, today) {
            let count = 0;
            const date = new Date(year, month, 1);
            while (date <= today && date.getMonth() === month) {
                const dayOfWeek = date.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    count++;
                }
                date.setDate(date.getDate() + 1);
            }
            return count > 0 ? count : 1;
        }

        // O Worker principal (sem alterações)
        self.onmessage = async (event) => {
            const { salesFile, clientsFile, productsFile, historyFile, innovationsFile } = event.data;

            try {
                self.postMessage({ type: 'progress', status: 'Lendo arquivos...', percentage: 10 });
                // Graças à função 'readFile', se um arquivo não for fornecido (ex: clientsFile = null),
                // a variável (ex: clientsDataRaw) será apenas um array vazio [].
                const [salesDataRaw, clientsDataRaw, productsDataRaw, historyDataRaw, innovationsDataRaw] = await Promise.all([
                    readFile(salesFile),
                    readFile(clientsFile),
                    readFile(productsFile),
                    readFile(historyFile),
                    readFile(innovationsFile)
                ]);

                // Se houver dados de vendas OU histórico, o mapa de supervisores é necessário.
                // Se não, pulamos esta etapa.
                const newRcaSupervisorMap = new Map();
                if (salesDataRaw.length > 0 || historyDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Criando mapa mestre de supervisores...', percentage: 20 });
                    const lastSaleDateMap = new Map();
                    const allSalesForMap = [...salesDataRaw, ...historyDataRaw];

                    allSalesForMap.forEach(row => {
                        try {
                            const codUsur = String(row['CODUSUR'] || '').trim();
                            if (codUsur === '1001') return;
                            const dtPed = row['DTPED'];
                            if (!codUsur || !dtPed) return;
                            const saleDate = parseDate(dtPed);
                            if (!saleDate || isNaN(saleDate.getTime())) return;
                            const lastDate = lastSaleDateMap.get(codUsur);
                            if (!lastDate || saleDate >= lastDate) {
                                lastSaleDateMap.set(codUsur, saleDate);
                                newRcaSupervisorMap.set(codUsur, {
                                    NOME: String(row['NOME'] || ''),
                                    SUPERV: String(row['SUPERV'] || ''),
                                    CODSUPERVISOR: String(row['CODSUPERVISOR'] || '').trim()
                                });
                            }
                        } catch (e) {
                            console.error('Erro ao processar linha para mapa mestre:', e, row);
                        }
                    });
                }


                const stockMap05 = new Map();
                const stockMap08 = new Map();
                const allProductCodesInStock = new Set();
                if (salesDataRaw.length > 0) {
                     self.postMessage({ type: 'progress', status: 'Extraindo estoque...', percentage: 25 });
                    salesDataRaw.forEach(item => {
                        const productCode = String(item['PRODUTO'] || '').trim();
                        if (!productCode) return;
                        allProductCodesInStock.add(productCode);
                        let branch = String(item['FILIAL'] || '').trim();
                        const stockQtyCx = parseBrazilianNumber(item['ESTOQUECX']);
                        if (branch === '5') branch = '05';
                        if (branch === '8') branch = '08';
                        if (branch === '05') stockMap05.set(productCode, stockQtyCx);
                        else if (branch === '08') stockMap08.set(productCode, stockQtyCx);
                    });
                }

                const productMasterMap = new Map();
                const productDetailsMap = new Map();
                const activeProductCodesFromCadastro = new Set();
                if (productsDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Mapeando produtos...', percentage: 30 });
                    productsDataRaw.forEach(prod => {
                        const productCode = String(prod['Código'] || '').trim();
                        if (!productCode) return;
                        activeProductCodesFromCadastro.add(productCode);

                        let qtdeMaster = parseInt(prod['Qtde embalagem master(Compra)'], 10);
                        if (isNaN(qtdeMaster) || qtdeMaster <= 0) qtdeMaster = 1;
                        productMasterMap.set(productCode, qtdeMaster);
                        if (!productDetailsMap.has(productCode)) {
                            productDetailsMap.set(productCode, {
                                code: productCode,
                                descricao: String(prod['Descrição'] || `Produto ${productCode}`),
                                fornecedor: String(prod['Nome do fornecedor'] || 'N/A'),
                                codfor: String(prod['Fornecedor'] || 'N/A'),
                                // CORREÇÃO: Removido o '1,' que estava a causar o SyntaxError
                                dtcadastro: prod['Dt.Cadastro'] || null
                            });
                        }
                    });
                }

                const clientMap = new Map();
                if (clientsDataRaw.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Processando clientes...', percentage: 50 });
                    clientsDataRaw.forEach(client => {
                        const codCli = String(client['Código'] || '').trim();
                        if (!codCli) return;
                        const rca1 = String(client['RCA 1'] || '');
                        const rca2 = String(client['RCA 2'] || '');
                        const rcas = new Set();
                        if (rca1) rcas.add(rca1);
                        if (rca2) rcas.add(rca2);
                        let registrationDateStr = client['Data e Hora de Cadastro'] || '';
                        if (registrationDateStr.includes(' ')) registrationDateStr = registrationDateStr.split(' ')[0];

                        // *** AQUI ESTÁ A MUDANÇA ***
                        const clientData = {
                            codigo_cliente: codCli, // CORRIGIDO: Chave primária agora é ASCII
                            rcas: Array.from(rcas),
                            rca1: rca1,
                            rca2: rca2,
                            cidade: String(client['Nome da Cidade'] || 'N/A'),
                            nomecliente: String(client['Fantasia'] || client['Cliente'] || 'N/A'),
                            bairro: String(client['Bairro'] || 'N/A'),
                            razaosocial: String(client['Cliente'] || 'N/A'),
                            fantasia: String(client['Fantasia'] || 'N/A'),
                            cnpj_cpf: String(client['CNPJ/CPF'] || 'N/A'),
                            endereco: String(client['Endereço Comercial'] || client['Endereço'] || 'N/A'),
                            numero: String(client['Número'] || 'SN'),
                            cep: String(client['CEP'] || 'N/A'),
                            telefone: String(client['Telefone Comercial'] || 'N/A'),
                            email: String(client['E-mail'] || 'N/A'),
                            ramo: String(client['Descricao'] || 'N/A'),
                            ultimacompra: client['Data da Última Compra'],
                            datacadastro: registrationDateStr,
                            bloqueio: String(client['Bloqueio'] || '').trim().toUpperCase(),
                            inscricaoestadual: String(client['Insc. Est. / Produtor'] || 'N/A')
                        };
                        // O clientMap agora usa o 'codCli' (ex: "11465") como chave
                        // e armazena o objeto 'clientData' (que tem 'codigo_cliente' dentro)
                        clientMap.set(codCli, clientData);
                    });
                }

                // Processa vendas (mesmo que salesDataRaw seja [], a função retorna [])
                self.postMessage({ type: 'progress', status: 'Cruzando dados de vendas...', percentage: 70 });
                // NOTA: O 'processSalesData' usa o 'clientMap.get(codCliStr)',
                // o que está correto, pois 'codCliStr' é o "Código" (ex: "11465").
                // O 'clientInfo' retornado será o objeto 'clientData' que já
                // tem 'codigo_cliente' e as outras colunas.
                const processedSalesData = processSalesData(salesDataRaw, clientMap, productMasterMap, newRcaSupervisorMap);
                const processedHistoryData = processSalesData(historyDataRaw, clientMap, productMasterMap, newRcaSupervisorMap);

                // Aplica regras de negócio (mesmo que os arrays estejam vazios)
                self.postMessage({ type: 'progress', status: 'Aplicando regras de filial...', percentage: 75 });
                const allProcessedSales = [...processedSalesData, ...processedHistoryData].sort((a, b) => {
                    const dateA = parseDate(a.dtped) || new Date(0);
                    const dateB = parseDate(b.dtped) || new Date(0);
                    return dateA - dateB;
                });
                const clientLastBranch = new Map();
                const clientsWith05Purchase = new Set();
                allProcessedSales.forEach(sale => {
                    const codCli = sale.codcli;
                    const filial = sale.filial;
                    if (codCli && filial) {
                        clientLastBranch.set(codCli, filial);
                        if (filial === '05') clientsWith05Purchase.add(codCli);
                    }
                });
                const clientBranchOverride = new Map();
                clientsWith05Purchase.forEach(codCli => {
                    const lastBranch = clientLastBranch.get(codCli);
                    if (lastBranch && lastBranch === '08') clientBranchOverride.set(codCli, '08');
                });
                const applyBranchOverride = (salesArray, overrideMap) => {
                    return salesArray.map(sale => {
                        const override = overrideMap.get(sale.codcli);
                        if (override && sale.filial === '05') return { ...sale, filial: override };
                        return sale;
                    });
                };
                let finalSalesData = applyBranchOverride(processedSalesData, clientBranchOverride);
                let finalHistoryData = applyBranchOverride(processedHistoryData, clientBranchOverride);

                self.postMessage({ type: 'progress', status: 'Aplicando regra (Tiago)...', percentage: 78 });
                const tiagoSellersToMoveTo08 = new Set(['291', '292', '293', '284', '289', '287', '286']);
                const applyTiagoRule = (salesArray) => {
                    return salesArray.map(sale => {
                        if (sale.codsupervisor === '12' && tiagoSellersToMoveTo08.has(sale.codusur)) {
                            return { ...sale, filial: '08' };
                        }
                        return sale;
                    });
                };
                finalSalesData = applyTiagoRule(finalSalesData);
                finalHistoryData = applyTiagoRule(finalHistoryData);

                // Atualiza datas de compra APENAS se houver novos clientes E novas vendas
                if (clientMap.size > 0 && finalSalesData.length > 0) {
                    self.postMessage({ type: 'progress', status: 'Atualizando datas de compra...', percentage: 80 });
                    const latestSaleDateByClient = new Map();
                    finalSalesData.forEach(sale => {
                        const codcli = sale.codcli;
                        const saleDate = parseDate(sale.dtped);
                        if (codcli && saleDate) {
                            const existingDate = latestSaleDateByClient.get(codcli);
                            if (!existingDate || saleDate > existingDate) latestSaleDateByClient.set(codcli, saleDate);
                        }
                    });
                    clientMap.forEach((client, codcli) => {
                        const lastPurchaseDate = parseDate(client.ultimacompra);
                        const latestSaleDate = latestSaleDateByClient.get(codcli);
                        if (latestSaleDate && (!lastPurchaseDate || isNaN(lastPurchaseDate.getTime()) || latestSaleDate > lastPurchaseDate)) {
                            client.ultimacompra = latestSaleDate;
                        }
                    });
                }

                // Agrega pedidos (se houver vendas)
                self.postMessage({ type: 'progress', status: 'Agregando pedidos...', percentage: 90 });
                const aggregateOrders = (data) => {
                    const orders = new Map();
                    data.forEach(row => {
                        if (!row.pedido) return;
                        if (!orders.has(row.pedido)) {
                            orders.set(row.pedido, { ...row, qtvenda: 0, vlvenda: 0, vlbonific: 0, totpesoliq: 0, fornecedores: new Set(), codfors: new Set() });
                        }
                        const order = orders.get(row.pedido);
                        order.qtvenda += row.qtvenda;
                        order.vlvenda += row.vlvenda;
                        order.vlbonific += row.vlbonific;
                        order.totpesoliq += row.totpesoliq;
                        if (row.observacaofor) order.fornecedores.add(row.observacaofor);
                        if (row.codfor) order.codfors.add(row.codfor);
                    });
                    return Array.from(orders.values()).map(order => {
                        order.fornecedores_list = Array.from(order.fornecedores);
                        order.fornecedores_str = order.fornecedores_list.join(', ');
                        order.codfors_list = Array.from(order.codfors);
                        delete order.fornecedores;
                        delete order.codfors;
                        return order;
                    });
                };
                // Se finalSalesData for [], aggregatedByOrder também será [].
                const aggregatedByOrder = aggregateOrders(finalSalesData);

                // --- Preparação dos dados finais ---
                // Se os arrays de input estavam vazios, os arrays de output também estarão.
                // Ex: Se clientsDataRaw = [], finalClientsData = []

                const finalClientsData = Array.from(clientMap.values());
                const finalProductDetailsData = Array.from(productDetailsMap.values());
                const finalActiveProductsData = Array.from(activeProductCodesFromCadastro).map(code => ({ code: code }));

                const finalStockData = [];
                allProductCodesInStock.forEach(code => {
                    finalStockData.push({ product_code: code, filial: "05", stock_qty: stockMap05.get(code) || 0 });
                    finalStockData.push({ product_code: code, filial: "08", stock_qty: stockMap08.get(code) || 0 });
                });

                // Metadados são sempre atualizados se houver vendas
                const finalMetadata = [];
                if (finalSalesData.length > 0) {
                     const lastSaleDate = finalSalesData.length > 0
                        ? new Date(Math.max.apply(null, finalSalesData.map(s => parseDate(s.dtped)).filter(d => d && !isNaN(d))))
                        : new Date();
                    lastSaleDate.setHours(0,0,0,0);
                    const passedWorkingDaysCurrentMonth = getPassedWorkingDaysInSpecificMonth(
                        lastSaleDate.getFullYear(),
                        lastSaleDate.getMonth(),
                        lastSaleDate
                    );

                    finalMetadata.push({
                        key: "passed_working_days",
                        value: String(passedWorkingDaysCurrentMonth)
                    });
                    finalMetadata.push({
                        key: "last_update",
                        value: new Date().toISOString()
                    });
                }


                const finalInnovationsData = innovationsDataRaw.map(item => ({
                    inovacoes: item.Inovacoes || item.inovacoes,
                    codigo: item.Codigo || item.codigo,
                    produto: item.Produto || item.produto
                }));


                self.postMessage({ type: 'progress', status: 'Finalizando...', percentage: 100 });

                // O objeto 'data' SÓ TERÁ chaves para os dados
                // que foram realmente processados.
                self.postMessage({
                    type: 'result',
                    data: {
                        detailed: finalSalesData,
                        history: finalHistoryData,
                        byOrder: aggregatedByOrder,
                        clients: finalClientsData,
                        product_details: finalProductDetailsData,
                        active_products: finalActiveProductsData,
                        stock: finalStockData,
                        innovations: finalInnovationsData,
                        metadata: finalMetadata
                    }
                });

            } catch (error) {
                self.postMessage({ type: 'error', message: error.message + (error.stack ? `
Stack: ${error.stack}`: '') });
            }
        };
    </script>

    <!--
      Script Principal da Página
    -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const salesFileInput = document.getElementById('sales-file-input');
            const clientsFileInput = document.getElementById('clients-file-input');
            const productsFileInput = document.getElementById('products-file-input');
            const historyFileInput = document.getElementById('history-file-input');
            const innovationsFileInput = document.getElementById('innovations-file-input');
            const generateBtn = document.getElementById('generate-btn');
            const adminModalCloseBtn = document.getElementById('admin-modal-close-btn');

            const statusContainer = document.getElementById('status-container');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');

            const supabaseUrlInput = document.getElementById('supabase-url');
            const supabaseKeyInput = document.getElementById('supabase-key');

            let files = {};

            adminModalCloseBtn.addEventListener('click', () => {
                document.getElementById('admin-uploader-modal').classList.add('hidden');
                const adminNavBtn = document.getElementById('nav-admin-uploader');
                if (adminNavBtn) {
                    adminNavBtn.classList.remove('active');
                }
            });

            // Lógica do Botão (sem alteração)
            const checkFiles = () => {
                const atLeastOneFileLoaded = files.salesFile || files.clientsFile || files.productsFile || files.historyFile || files.innovationsFile;
                const supabaseConfigReady = supabaseUrlInput.value && supabaseKeyInput.value;
                generateBtn.disabled = !(atLeastOneFileLoaded && supabaseConfigReady);
            };

            // 'Listeners' (sem alteração)
            salesFileInput.addEventListener('change', (e) => { files.salesFile = e.target.files[0]; checkFiles(); });
            clientsFileInput.addEventListener('change', (e) => { files.clientsFile = e.target.files[0]; checkFiles(); });
            productsFileInput.addEventListener('change', (e) => { files.productsFile = e.target.files[0]; checkFiles(); });
            historyFileInput.addEventListener('change', (e) => { files.historyFile = e.target.files[0]; checkFiles(); });
            innovationsFileInput.addEventListener('change', (e) => { files.innovationsFile = e.target.files[0]; checkFiles(); });
            supabaseUrlInput.addEventListener('input', checkFiles);
            supabaseKeyInput.addEventListener('input', checkFiles);

            // 'Worker' (sem alteração)
            const workerScript = document.getElementById('worker-script').textContent;
            const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(workerBlob);
            const worker = new Worker(workerUrl);

            // 'onmessage' do worker (sem alteração)
            worker.onmessage = (event) => {
                const { type, status, percentage, data, message } = event.data;

                if (type === 'progress') {
                    statusText.textContent = status;
                    progressBar.style.width = \`\${percentage}%\`;
                } else if (type === 'result') {
                    statusText.textContent = 'Dados processados! Enviando para o Supabase...';
                    progressBar.style.width = '100%';
                    enviarDadosParaSupabase(data);
                } else if (type === 'error') {
                    statusContainer.classList.remove('hidden');
                    statusText.innerHTML = \`<p class="text-red-500">Erro no Worker: \${message}</p>\`;
                    progressBar.style.width = '0%';
                    generateBtn.disabled = false;
                }
            };

            // 'click' do botão (sem alteração)
            generateBtn.addEventListener('click', () => {
                if (generateBtn.disabled) return;

                generateBtn.disabled = true;
                statusContainer.classList.remove('hidden');
                statusText.textContent = 'A iniciar o processamento...';
                progressBar.style.width = '0%';

                worker.postMessage({
                    salesFile: files.salesFile || null,
                    clientsFile: files.clientsFile || null,
                    productsFile: files.productsFile || null,
                    historyFile: files.historyFile || null,
                    innovationsFile: files.innovationsFile || null
                });
            });

            // 'enviarDadosEmLotes' (sem alteração da v5)
            async function enviarDadosEmLotes(supabaseClient, nomeTabela, dados, statusText, progressBar, progressoInicial, progressoFinal, primaryKeys = ['id']) {
                const TAMANHO_LOTE = 500;

                try {
                    if (dados.length > 0) {
                        const totalLotes = Math.ceil(dados.length / TAMANHO_LOTE);

                        const anyColumn = primaryKeys[0];
                        statusText.textContent = \`(Etapa \${progressoInicial < 40 ? '1' : '2'}/9) Limpando dados antigos de \${nomeTabela}...\`;

                        // *** O 'deleteError' AQUI VAI FINALMENTE PARAR DE ACONTECER ***
                        // CORREÇÃO: Usa um filtro genérico que não depende do nome da coluna.
                        // Apaga todos os registros onde a chave primária não é um valor impossível,
                        // efetivamente limpando a tabela de forma segura.
                        const { error: deleteError } = await supabaseClient
                            .from(nomeTabela)
                            .delete()
                            .neq(primaryKeys[0], 'IMPOSSIBLE_VALUE_TO_MATCH');

                        if (deleteError) throw new Error(\`Falha ao limpar \${nomeTabela}: \${deleteError.message}\`);

                        for (let i = 0; i < totalLotes; i++) {
                            const inicio = i * TAMANHO_LOTE;
                            const fim = inicio + TAMANHO_LOTE;
                            const lote = dados.slice(inicio, fim);

                            const statusMsg = \`(Etapa \${progressoInicial < 40 ? '1' : '2'}/8) Enviando \${nomeTabela} (Lote \${i + 1}/\${totalLotes})...\`;
                            statusText.textContent = statusMsg;

                            const { error: insertError } = await supabaseClient
                                .from(nomeTabela)
                                .insert(lote);

                            if (insertError) {
                                console.error(\`Erro no lote \${i+1} de \${nomeTabela}:\`, insertError);
                                throw new Error(\`Erro ao inserir \${nomeTabela} (Lote \${i + 1}): \${insertError.message}\`);
                            }

                            const progressoLote = (i + 1) / totalLotes;
                            const progressoTotal = progressoInicial + (progressoLote * (progressoFinal - progressoInicial));
                            progressBar.style.width = \`\${progressoTotal}%\`;
                        }
                    } else {
                        progressBar.style.width = \`\${progressoFinal}%\`;
                    }
                } catch (error) {
                    throw error;
                }
            }


            // Função principal de envio
            async function enviarDadosParaSupabase(data) {
                const SUPABASE_URL = supabaseUrlInput.value;
                const SUPABASE_KEY = supabaseKeyInput.value;

                if (!SUPABASE_URL || !SUPABASE_KEY) {
                    statusText.innerHTML = \`<p class="text-red-500">Erro: URL ou Chave Secreta do Supabase não informada.</p>\`;
                    generateBtn.disabled = false;
                    return;
                }

                try {
                    const { createClient } = supabase;
                    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

                    statusText.textContent = 'Conectado! Verificando dados para enviar...';
                    progressBar.style.width = '5%';

                    const tasks = [];

                    if (data.detailed) tasks.push({ name: 'Vendas Atuais', tableName: 'data_detailed', data: data.detailed, keys: ['pedido'] });
                    if (data.history) tasks.push({ name: 'Histórico', tableName: 'data_history', data: data.history, keys: ['pedido'] });
                    if (data.byOrder) tasks.push({ name: 'Pedidos', tableName: 'data_orders', data: data.byOrder, keys: ['pedido'] });
                    // *** AQUI ESTÁ A MUDANÇA ***
                    if (data.clients) tasks.push({ name: 'Clientes', tableName: 'data_clients', data: data.clients, keys: ['codigo_cliente'] }); // CORRIGIDO
                    if (data.product_details) tasks.push({ name: 'Detalhes de Produtos', tableName: 'data_product_details', data: data.product_details, keys: ['code'] });
                    if (data.active_products) tasks.push({ name: 'Produtos Ativos', tableName: 'data_active_products', data: data.active_products, keys: ['code'] });
                    if (data.stock) tasks.push({ name: 'Estoque', tableName: 'data_stock', data: data.stock, keys: ['product_code'] });
                    if (data.innovations) tasks.push({ name: 'Inovações', tableName: 'data_innovations', data: data.innovations, keys: ['codigo'] });
                    if (data.metadata) tasks.push({ name: 'Metadados', tableName: 'data_metadata', data: data.metadata, keys: ['key'] });

                    if (tasks.length === 0) {
                        statusText.innerHTML = \`<p class="text-yellow-500">Nenhum dado novo foi processado.</p>\`;
                        generateBtn.disabled = false;
                        return;
                    }

                    const totalTasks = tasks.length;

                    for (let i = 0; i < totalTasks; i++) {
                        const task = tasks[i];
                        const taskProgress = ((i + 1) / totalTasks);
                        const progressoInicial = (i / totalTasks) * 100;
                        const progressoFinal = taskProgress * 100;

                        statusText.textContent = \`Enviando (\${i + 1}/\${totalTasks}): \${task.name}...\`;

                        await enviarDadosEmLotes(
                            supabaseClient,
                            task.tableName,
                            task.data,
                            statusText,
                            progressBar,
                            progressoInicial,
                            progressoFinal,
                            task.keys
                        );
                    }

                    // CORREÇÃO: Removido o 'E' que estava a causar um SyntaxError
                    // SUCESSO!
                    statusText.innerHTML = \`<p class="text-green-500">Sucesso! Dados do dashboard atualizados.</p>\`;
                    progressBar.style.width = '100%';
                    generateBtn.disabled = false;

                    // Limpa os campos de arquivo para a próxima
                    salesFileInput.value = '';
                    clientsFileInput.value = '';
                    productsFileInput.value = '';
                    historyFileInput.value = '';
                    innovationsFileInput.value = '';
                    files = {};
                    checkFiles();

                } catch (error) {
                    console.error('Erro no Supabase:', error);
                    statusText.innerHTML = \`<p class="text-red-500">Erro ao enviar: \${error.message}</p>\`;
                    progressBar.style.width = '0%';
                    generateBtn.disabled = false;
                }
            }
            checkFiles();
        });
    </script>
</body>
</html>
