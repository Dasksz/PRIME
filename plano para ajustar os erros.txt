O que você deve fazer no seu JavaScript
Como o SQL já está correto (com o CODIGO 2), o erro HTTP 400 que vimos na sua imagem agora é 100% causado pelo seu ficheiro js/main.js.

O problema é que o js/main.js está a enviar parâmetros a mais (como p_fornecedores e p_produtos) para funções que não os esperam (get_main_kpis e get_top_products).

Aqui está a correção exata que você precisa de aplicar no seu ficheiro js/main.js:

Ficheiro a modificar: dasksz/prime/PRIME-0496736bfe24b7f84e86a2f6687268cc5ad2d053/js/main.js Localização: Encontre a função updateDashboardView(), por volta da linha 300.

1. Código Original (Problemático)
Encontre este bloco de código no seu ficheiro:

JavaScript

// ▼▼▼ ENCONTRE ESTE BLOCO DE CÓDIGO (Linha 300-322) ▼▼▼
    try {
        const allFilters = getAppliedFilters('main');
        const groupBy = allFilters.p_supervisor ? 'vendedor' : 'supervisor';

        const rpcParams = {
            p_pasta: allFilters.p_pasta,
            p_supervisor: allFilters.p_supervisor,
            p_vendedor_nomes: allFilters.p_vendedor_nomes,
            p_codcli: allFilters.p_codcli,
            p_posicao: allFilters.p_posicao,
            p_codfor: allFilters.p_codfor,
            p_tipos_venda: allFilters.p_tipos_venda,
            p_rede_group: allFilters.p_rede_group,
            p_redes: allFilters.p_redes,
            p_cidade: allFilters.p_cidade,
            p_filial: allFilters.p_filial
        };

        const [kpiData, salesByPersonData, salesByCategoryData, topProductsData] = await Promise.all([
            api.getMainKpis(supabase, rpcParams), // <-- ERRO AQUI
            api.getSalesByGroup(supabase, { ...rpcParams, p_group_by: groupBy }),
            api.getSalesByGroup(supabase, { ...rpcParams, p_group_by: 'categoria' }),
            api.getTopProducts(supabase, { ...rpcParams, p_metric: 'faturamento' }) // <-- ERRO AQUI
        ]);
2. Código Corrigido (Substituição)
Substitua o bloco inteiro acima por este novo bloco corrigido:

JavaScript

// ▼▼▼ SUBSTITUA PELO BLOCO ABAIXO ▼▼▼
    try {
        const allFilters = getAppliedFilters('main');
        const groupBy = allFilters.p_supervisor ? 'vendedor' : 'supervisor';

        // 1. Parâmetros ESPECÍFICOS para get_main_kpis e get_sales_by_group
        //    (Estes não aceitam p_fornecedores ou p_produtos)
        const mainParams = {
            p_pasta: allFilters.p_pasta,
            p_supervisor: allFilters.p_supervisor,
            p_vendedor_nomes: allFilters.p_vendedor_nomes,
            p_codcli: allFilters.p_codcli,
            p_posicao: allFilters.p_posicao,
            p_codfor: allFilters.p_codfor,
            p_tipos_venda: allFilters.p_tipos_venda,
            p_rede_group: allFilters.p_rede_group,
            p_redes: allFilters.p_redes,
            p_cidade: allFilters.p_cidade,
            p_filial: allFilters.p_filial
        };

        // 2. Parâmetros ESPECÍFICOS para get_top_products
        //    (Este aceita os mesmos que o main, mas NÃO p_fornecedores/p_produtos)
        const topProductsParams = {
            ...mainParams, // Reutiliza os 11 parâmetros
            p_metric: 'faturamento' // Adiciona o p_metric
        };
        
        const [kpiData, salesByPersonData, salesByCategoryData, topProductsData] = await Promise.all([
            api.getMainKpis(supabase, mainParams), // <-- CORRIGIDO
            api.getSalesByGroup(supabase, { ...mainParams, p_group_by: groupBy }), // <-- CORRIGIDO
            api.getSalesByGroup(supabase, { ...mainParams, p_group_by: 'categoria' }), // <-- CORRIGIDO
            api.getTopProducts(supabase, topProductsParams) // <-- CORRIGIDO
        ]);
Explicação da Correção
O Problema: O seu código original criava um objeto genérico rpcParams e enviava-o para todas as funções. No entanto, a sua função getAppliedFilters('main') também recolhe p_fornecedores e p_produtos, que não são esperados pelas funções get_main_kpis ou get_top_products (definidas no seu CODIGO 2).

A Solução: O novo código cria objetos de parâmetros específicos (mainParams e topProductsParams) que contêm apenas os argumentos que as suas funções SQL (do CODIGO 2) realmente esperam.

Resultado: Isto resolve a incompatibilidade (structure of query does not match) e corrige o erro HTTP 400.

Depois de fazer esta alteração no js/main.js e salvar, lembre-se de recarregar a sua aplicação no navegador com Ctrl + Shift + R (ou Cmd + Shift + R) para garantir que o ficheiro novo é carregado.
