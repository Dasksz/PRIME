<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Vendas - PRIME DISTRIBUIÇÃO</title>
    <link rel="icon" type="image/jpeg" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSnaaZ2WnZBJIxPRfabS4Ug78PKK6Gu3nbHlw&s">
    <!-- 1. ADICIONADO: Scripts necessários para o dashboard -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- 2. ADICIONADO: Biblioteca do Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 3. ADICIONADO: Todo o CSS do seu dashboard escuro original */
        body { font-family: 'Inter', sans-serif; background-color: #0d1126; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161e3d; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
        ::-webkit-scrollbar-corner { background: #161e3d; }
        .sticky-header th { position: sticky; top: 0; z-index: 10; background-color: #161e3d; border-bottom: 2px solid #2d3748; }
        .hidden { display: none; }
        .metric-btn.active, .fornecedor-btn.active, .comparison-toggle-btn.active, .group-btn.active, #main-rede-group-container > div > button.active, #city-rede-group-container > div > button.active, #comparison-rede-group-container > div > button.active, #stock-rede-group-container > div > button.active { background-color: #38b2ac; color: #FFF; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltip-text { visibility: hidden; width: auto; min-width: 80px; background-color: #1f2937; color: #fff; text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute; z-index: 1001; bottom: 125%; left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #161e3d; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; }
        .kpi-card { background-color: #1d2347; border-radius: 0.5rem; padding: 1.5rem; text-align: center; border: 1px solid #2d3748; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .stock-trend-btn.active { outline: 2px solid #38b2ac; outline-offset: 2px; transform: scale(1.1); }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* 4. ADICIONADO: Estilo para o loader inicial */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #0d1126;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        #loader-spinner {
            border: 4px solid #1d2347;
            border-top: 4px solid #38b2ac;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#0d1126] text-slate-300 antialiased">

    <!-- 5. ADICIONADO: Loader que será exibido enquanto os dados carregam -->
    <div id="loader">
        <div id="loader-spinner"></div>
        <p id="loader-text" class="text-slate-300 mt-4">Carregando dados do Supabase...</p>
    </div>

    <!-- 6. ADICIONADO: Todo o HTML do seu dashboard escuro original -->
    <div id="main-dashboard" class="hidden"> <!-- Começa escondido -->
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="mb-6 -mt-4 -mx-4 sm:-mt-6 sm:-mx-6 lg:-mt-8 lg:-mx-8 p-6 bg-gradient-to-r from-[#1e2a5a] to-[#0d1126] rounded-b-lg shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4">
                    <div class="text-center sm:text-left">
                        <h1 class="text-2xl font-bold text-white">PAINEL DE VENDAS - <span class="text-yellow-300">PRIME</span> DISTRIBUIÇÃO</h1>
                        <!-- Este <p> será atualizado pelo script -->
                        <p id="generation-date" class="text-slate-300 mt-1">Dados atualizados em: ...</p>
                    </div>
                </div>
            </header>

            <!-- KPIs com bordas e cores atualizadas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="kpi-card border-t-4 border-indigo-500">
                    <h3 class="text-slate-400 font-medium uppercase text-sm">Volume Tons</h3>
                    <p id="total-peso" class="text-4xl font-bold text-white my-2">0,0</p>
                </div>
                <div class="kpi-card border-t-4 border-teal-500">
                    <h3 class="text-slate-400 font-medium uppercase text-sm">Faturamento R$</h3>
                    <p id="total-vendas" class="text-4xl font-bold text-white my-2">R$ 0,00</p>
                </div>
                <div class="kpi-card border-t-4 border-green-500">
                    <h3 class="text-slate-400 font-medium uppercase text-sm">SKU/PDV</h3>
                    <p id="kpi-sku-pdv" class="text-4xl font-bold text-white my-2">0,0</p>
                </div>
                <div class="kpi-card border-t-4 border-purple-500">
                    <h3 class="text-slate-400 font-medium uppercase text-sm">Cobertura PDVs</h3>
                    <p id="kpi-positivacao" class="text-4xl font-bold text-white my-2">0,0%</p>
                    <p id="kpi-positivacao-percent" class="text-sm text-slate-400 -mt-1">0 PDVs</p>
                </div>
            </div>
            
            <!-- ... (O RESTANTE DO SEU HTML DO DASHBOARD VAI AQUI) ... -->
            <!-- (Filtros, Botões de Navegação, Contêineres de Gráficos, Tabelas, Modais, etc.) -->
            <!-- Copie todo o <body> do template que seu script gerava -->
            
            <div class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div id="fornecedor-toggle-container" class="w-full sm:w-auto rounded-lg p-1 flex justify-center sm:justify-start gap-2">
                    <button data-fornecedor="PEPSICO" class="fornecedor-btn bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">PEPSICO</button>
                    <button data-fornecedor="MULTIMARCAS" class="fornecedor-btn bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold py-2 px-4 rounded-lg flex-1 sm:flex-none">MULTIMARCAS</button>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button id="viewChartBtn" class="w-full bg-teal-500 hover:bg-teal-400 text-white font-bold py-2 px-4 rounded-lg hidden">Gráficos</button>
                    <button id="viewTableBtn" class="w-full bg-teal-500 hover:bg-teal-400 text-white font-bold py-2 px-4 rounded-lg">Pedidos</button>
                    <button id="viewComparisonBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg">Comparativo</button>
                    <button id="viewStockBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Estoque</button>
                    <button id="viewCoverageBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">Cobertura</button>
                </div>
            </div>
            <div id="main-filters" class="mb-6 p-4 bg-[#1d2347] rounded-lg shadow-sm border border-slate-700">
                <!-- ... (Cole todos os seus filtros aqui) ... -->
                 <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 items-end">
                    <!-- Filtro de Rede -->
                    <div id="main-rede-filter-wrapper" class="relative">
                        <label class="block mb-2 text-sm font-medium text-slate-400">Rede</label>
                        <div id="main-rede-group-container" class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" data-group="" class="group-btn active py-2 px-4 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-l-lg hover:bg-slate-600">Todos</button>
                            <button type="button" data-group="com_rede" id="main-com-rede-btn" class="group-btn py-2 px-4 text-sm font-medium text-slate-300 bg-slate-700 border-t border-b border-slate-600 hover:bg-slate-600 flex items-center gap-2">
                                <span id="main-com-rede-btn-text">Com Rede</span>
                                <svg class="w-3 h-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <button type="button" data-group="sem_rede" class="group-btn py-2 px-4 text-sm font-medium text-slate-300 bg-slate-700 border border-slate-600 rounded-r-lg hover:bg-slate-600">Sem Rede</button>
                        </div>
                        <div id="main-rede-filter-dropdown" class="hidden absolute z-20 w-56 mt-1 top-full left-0 bg-slate-800 border border-slate-600 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-left text-white"></div>
                    </div>
                    <!-- Outros Filtros -->
                    <div><label for="supervisor-filter" class="block mb-2 text-sm font-medium text-slate-400">Supervisor</label><select id="supervisor-filter" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                    <div class="relative"><label for="vendedor-filter-btn" class="block mb-2 text-sm font-medium text-slate-400">Vendedor</label><button id="vendedor-filter-btn" class="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="vendedor-filter-text">Todos Vendedores</span><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="vendedor-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-white"></div></div>
                    <div class="relative"><label for="tipo-venda-filter-btn" class="block mb-2 text-sm font-medium text-slate-400">Tipo Venda</label><button id="tipo-venda-filter-btn" class="w-full bg-slate-700 border border-slate-600 text-white text-sm rounded-lg p-2.5 text-left flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-teal-500"><span id="tipo-venda-filter-text">Todos os Tipos</span><svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path></svg></button><div id="tipo-venda-filter-dropdown" class="hidden absolute z-20 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-lg max-h-60 overflow-y-auto custom-scrollbar text-white"></div></div>
                    <div><label for="fornecedor-filter" class="block mb-2 text-sm font-medium text-slate-400">Fornecedor</label><select id="fornecedor-filter" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todos</option></select></div>
                    <div><label for="codcli-filter" class="block mb-2 text-sm font-medium text-slate-400">Cód. Cliente</label><input type="text" id="codcli-filter" placeholder="Digite o código..." class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"></div>
                    <div><label for="posicao-filter" class="block mb-2 text-sm font-medium text-slate-400">Posição</label><select id="posicao-filter" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 block w-full p-2.5"><option value="">Todas</option><option value="L">Liberado</option><option value="M">Montado</option><option value="F">Faturado</option></select></div>
                    <div class="md:col-start-6"><button id="clear-filters-btn" class="w-full bg-slate-600 hover:bg-slate-500 text-white font-bold py-2.5 px-4 rounded-lg">Limpar Filtros</button></div>
                </div>
            </div>
            <main id="app-container">
                <!-- ... (Cole o restante do seu HTML aqui: chartView, tableView...) ... -->
                <div id="chartView" class="">
                    <div class="mb-6 bg-[#1d2347] p-4 rounded-lg border border-slate-700 shadow-sm">
                        <!-- ... (HTML do gráfico de tendência) ... -->
                    </div>
                </div>
                <div id="tableView" class="hidden">
                    <!-- ... (HTML da tabela) ... -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- ... (Cole o HTML das outras views: city-view, weekly-view, etc.) ... -->
    <!-- ... (Cole o HTML de TODOS os modais: order-details-modal, etc.) ... -->

    <!-- Exemplo (COLE TODO O SEU HTML AQUI) -->
    <div id="city-view" class="hidden">...</div>
    <div id="weekly-view" class="hidden">...</div>
    <div id="comparison-view" class="hidden">...</div>
    <div id="stock-view" class="hidden">...</div>
    <div id="innovations-view" class="hidden">...</div>
    <div id="innovations-month-view" class="hidden">...</div>
    <div id="coverage-view" class="hidden">...</div>
    <div id="order-details-modal" class="modal-overlay hidden">...</div>
    <div id="client-details-modal" class="modal-overlay hidden">...</div>
    <div id="holiday-modal" class="modal-overlay hidden">...</div>


    <!-- 7. ADICIONADO: Script que busca dados e inicia o dashboard -->
    <script>
        // !! AÇÃO NECESSÁRIA !!
        // Cole sua URL e Chave PÚBLICA (anon) aqui
        const SUPABASE_URL = 'https://dhozwhfmrwiumwpcqabi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRob3p3aGZtcndpdW13cGNxYWJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjMzNjAsImV4cCI6MjA3NzgzOTM2MH0.syWqcBCbfH5Ey5AB4NGrsF2-ZuBw4W3NZAPIAZb6Bq4';
        
        // Variável global que o script de lógica espera
        let embeddedData = {};

        // Função para carregar os dados do Supabase
        async function carregarDadosDoSupabase() {
            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loader-text');
            const mainDashboard = document.getElementById('main-dashboard');
            
            try {
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('COLE_A_URL')) {
                    loaderText.innerHTML = '<span class="text-red-400">Erro: SUPABASE_URL ou SUPABASE_ANON_KEY não configuradas no index.html.</span>';
                    return;
                }
                
                const { createClient } = supabase.auth;
                const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                loaderText.textContent = 'Buscando dados...';

                // Busca a linha única (id=1) da nossa tabela
                const { data, error } = await supabaseClient
                    .from('dashboard_data')
                    .select('data, updated_at')
                    .eq('id', 1)
                    .single(); // .single() pega um único objeto, não um array

                if (error) {
                    throw error;
                }

                if (!data || !data.data) {
                    throw new Error('Nenhum dado encontrado no Supabase. Execute o admin.html primeiro.');
                }

                loaderText.textContent = 'Renderizando dashboard...';

                // 8. PONTO MÁGICO: Alimenta a variável global com os dados da nuvem
                window.embeddedData = data.data;

                // Atualiza a data de geração no HTML
                const generationDate = new Date(data.updated_at).toLocaleString('pt-BR');
                document.getElementById('generation-date').textContent = `Dados atualizados em: ${generationDate}`;

                // Pega o conteúdo do script de lógica
                const scriptLogicContent = document.getElementById('report-logic-script').textContent;
                
                // Cria um novo tag <script>
                const logicScript = document.createElement('script');
                logicScript.textContent = scriptLogicContent;
                
                // Adiciona o script ao body, o que fará com que ele execute
                // agora que 'window.embeddedData' já existe.
                document.body.appendChild(logicScript);

                // Mostra o dashboard e esconde o loader
                mainDashboard.classList.remove('hidden');
                loader.style.opacity = '0';
                setTimeout(() => loader.classList.add('hidden'), 300);

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                loaderText.innerHTML = `<span class="text-red-400">Falha ao carregar dados: ${error.message}</span>`;
            }
        }

        // Inicia o carregamento assim que a página estiver pronta
        document.addEventListener('DOMContentLoaded', carregarDadosDoSupabase);
    </script>


    <!-- 
      9. ADICIONADO: Seu script de lógica original, INALTERADO,
      mas agora dentro de um <script type="text/template"> 
    -->
    <script id="report-logic-script" type="text/template">
        // ... (COLE AQUI O CONTEÚDO COMPLETO DO SEU <script id="report-logic-script">) ...
        // ... (Começa com "const allSalesData = embeddedData.detailed;" ...)
        // ... (E termina com "renderTable(aggregatedOrders);") ...

        // Exemplo (cole seu script completo aqui):
        const allSalesData = embeddedData.detailed;
        const allHistoryData = embeddedData.history;
        const aggregatedOrders = embeddedData.byOrder;
        const allClientsData = embeddedData.clients;
        const stockData05 = new Map(Object.entries(embeddedData.stockMap05 || {}));
        const stockData08 = new Map(Object.entries(embeddedData.stockMap08 || {}));
        const innovationsMonthData = embeddedData.innovationsMonth;
        const clientMapForKPIs = new Map(allClientsData.map(c => [String(c['Código']), c]));
        const activeProductCodesFromCadastro = new Set(embeddedData.activeProductCodes || []);
        const productDetailsMap = new Map(Object.entries(embeddedData.productDetails || {}));
        const passedWorkingDaysCurrentMonth = embeddedData.passedWorkingDaysCurrentMonth || 1;

        // ... todo o resto do seu código de lógica ...
        
        // ... (várias e várias linhas de código) ...
        
        // A última linha do seu script de lógica original:
        // (ela agora será executada depois que o 'embeddedData' for carregado)
        updateAllVisuals();
        renderTable(aggregatedOrders);
    </script>
</body>
</html>
